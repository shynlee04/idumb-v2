---
phase: 11-sdk-type-realignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/11-sdk-type-realignment/11-CONTRACTS.md
autonomous: true

must_haves:
  truths:
    - "Contract registry documents every SDK type consumed by this app with field shapes, nullable fields, and discriminant values"
    - "Each consumer file is mapped to the SDK types it imports and the properties it accesses"
  artifacts:
    - path: ".planning/phases/11-sdk-type-realignment/11-CONTRACTS.md"
      provides: "SDK type contract registry — single executor reference for all SDK type shapes"
      min_lines: 150
  key_links:
    - from: "11-CONTRACTS.md"
      to: "node_modules/@opencode-ai/sdk/dist/gen/types.gen.d.ts"
      via: "type audit extraction"
      pattern: "Session|Message|Part|SessionStatus"
---

<objective>
Create the SDK type contract registry — a comprehensive audit document that maps every SDK type consumed by this app to its actual shape, nullable fields, discriminant values, and consumer locations.

Purpose: This document becomes the single executor reference for Plans 11-03 (Zod schemas) and 11-04 (consumer migration). Without it, executors must parse 3380 lines of raw SDK types.gen.d.ts each time.

Output: `.planning/phases/11-sdk-type-realignment/11-CONTRACTS.md`
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-sdk-type-realignment/11-RESEARCH.md
@app/shared/engine-types.ts
@app/shared/ide-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full SDK type audit from source</name>
  <files>.planning/phases/11-sdk-type-realignment/11-CONTRACTS.md</files>
  <action>
Read `node_modules/@opencode-ai/sdk/dist/gen/types.gen.d.ts` to extract the actual type definitions for every type re-exported in `app/shared/engine-types.ts`.

For each SDK type (Session, SessionStatus, Message, UserMessage, AssistantMessage, Part, TextPart, ToolPart, FilePart, ReasoningPart, StepStartPart, StepFinishPart, SnapshotPart, PatchPart, AgentPart, RetryPart, CompactionPart), document:

1. **Full interface shape** — every field with its TypeScript type
2. **Nullable/optional fields** — which fields can be `undefined` or `null`
3. **Discriminant values** — for union types (Part, Message, SessionStatus), what `type` or `role` values distinguish members
4. **Timestamp format** — whether timestamps are `number` (epoch ms) or `string` (ISO)
5. **Nested types** — types referenced within (e.g., `Session.messages` references `Message[]`)

Also check `node_modules/@opencode-ai/sdk/dist/gen/types.gen.d.ts` for the `OpencodeClient` method return types used in `app/server/sessions.ts` (e.g., what `client.session.list()` actually returns — the `{ data, error, response }` wrapper shape).

Structure the document as:

```markdown
# SDK Type Contract Registry — @opencode-ai/sdk@{version}

## Generated: {date}

## Core Types

### Session
| Field | Type | Nullable | Notes |
...

### Message (discriminated union on `role`)
...

### Part (discriminated union on `type`)
...

### SessionStatus (discriminated union on `type`)
...

## SDK Client Return Shapes
### session.list() → { data: Session[], error, response }
...

## Gotchas & Drift Risks
- `time.created` is number (epoch), not Date or ISO string
- `Message.parts` is Part[] (not optional on SDK type, but may be empty array at runtime)
- `Session.title` may be empty string, not null
...
```

Use the research file (`11-RESEARCH.md`) as a starting reference but VERIFY every field against the actual SDK source. The research was a snapshot — the source is truth.
  </action>
  <verify>
File exists at `.planning/phases/11-sdk-type-realignment/11-CONTRACTS.md` with at least 150 lines. Contains sections for Session, Message, Part (all discriminant members), SessionStatus. Every type re-exported in `engine-types.ts` is documented.
  </verify>
  <done>Contract registry documents all 17 SDK types re-exported from engine-types.ts with field shapes, nullability, and discriminant values.</done>
</task>

<task type="auto">
  <name>Task 2: Cross-reference contracts against consumers</name>
  <files>.planning/phases/11-sdk-type-realignment/11-CONTRACTS.md</files>
  <action>
Add a "Consumer Map" section to `11-CONTRACTS.md` that cross-references every consumer file against the SDK types it uses.

Read these consumer files and map their SDK type usage:

1. **`app/server/sessions.ts`** (~230 LOC) — Server functions that call SDK client methods and return SDK-typed data. Map: which SDK client methods are called, what return types flow through, where `JSON.parse(JSON.stringify())` serialization workaround is used.

2. **`app/hooks/useStreaming.ts`** (~163 LOC) — SSE streaming hook. Map: which SDK types are used in state (`Message[]`), which SSE event properties are accessed (`data.message.id`, `data.part.messageID`, `data.part.id`, `m.parts`).

3. **`app/components/chat/ChatMessage.tsx`** (~120 LOC) — Message renderer. Map: which `message.*` properties accessed, how `part.type` is narrowed (or not), any `as any` casts.

4. **`app/routes/chat.$sessionId.tsx`** (~190 LOC) — Chat route. Map: which SDK types used in loader data, how messages/parts are passed to components.

5. **`app/routes/api/sessions.$id.prompt.ts`** (~180 LOC) — SSE server route. Map: which SDK events are relayed, what shapes are forwarded.

6. **`app/routes/api/events.ts`** (~100 LOC) — Global SSE relay. Map: event types forwarded.

7. **`app/server/sdk-client.server.ts`** (~259 LOC) — SDK client lifecycle. Map: `unwrapSdkResult<T>` generic usage, SDK method calls.

For each consumer, note:
- SDK types imported (from `engine-types` or `ide-types`)
- Properties accessed on those types
- Any type narrowing patterns (or lack thereof)
- Any `as any`, `as unknown`, or unsafe casts on SDK data
- Any violations (hand-rolled types duplicating SDK shapes)

Format as table:

```markdown
## Consumer Map

| File | SDK Types Used | Properties Accessed | Issues |
|------|---------------|---------------------|--------|
| sessions.ts | Session, Message, Part, SessionStatus | session.id, session.title, ... | JSON.parse workaround needed |
| useStreaming.ts | Message, Part | m.id, m.parts, part.messageID | SSE data untyped (JSON.parse) |
...
```
  </action>
  <verify>
`11-CONTRACTS.md` contains a "Consumer Map" section with rows for all 7 consumer files listed above. Each row has SDK types used, properties accessed, and issues noted.
  </verify>
  <done>Every consumer of SDK types is mapped with specific property access patterns and issues flagged for Plans 11-03 and 11-04.</done>
</task>

</tasks>

<verification>
- `11-CONTRACTS.md` exists with 150+ lines
- All 17 SDK types from `engine-types.ts` re-exports are documented
- Consumer Map covers all 7 consumer files
- Gotchas section lists at least 3 known drift risks
</verification>

<success_criteria>
- Contract registry is complete enough that an executor can build Zod schemas (Plan 11-03) without needing to read the raw SDK types
- Consumer map is detailed enough that an executor can migrate consumers (Plan 11-04) knowing exactly which properties to type-narrow
</success_criteria>

<output>
After completion, create `.planning/phases/11-sdk-type-realignment/11-01-SUMMARY.md`
</output>
