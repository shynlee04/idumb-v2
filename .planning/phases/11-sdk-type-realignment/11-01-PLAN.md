---
phase: 11-sdk-type-realignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/shared/engine-types.ts
  - app/shared/ide-types.ts
  - app/server/config.ts
  - app/server/sessions.ts
  - app/server/sdk-client.server.ts
autonomous: true

must_haves:
  truths:
    - "engine-types.ts re-exports Session, Message, Part, Event from @opencode-ai/sdk — zero hand-rolled SDK type definitions remain"
    - "Server functions (config.ts, sessions.ts) use SDK Provider/Agent/Session types — no Record<string, unknown> normalization"
    - "ide-types.ts barrel re-exports SDK types from engine-types.ts without duplication"
    - "tsc --noEmit passes after all type changes"
  artifacts:
    - path: "app/shared/engine-types.ts"
      provides: "SDK type re-exports + app-level types + helper functions"
      contains: "from '@opencode-ai/sdk'"
    - path: "app/shared/ide-types.ts"
      provides: "Updated barrel re-exports matching new engine-types"
      contains: "from './engine-types'"
    - path: "app/server/config.ts"
      provides: "Provider/Agent normalization using SDK types"
      contains: "Provider"
    - path: "app/server/sessions.ts"
      provides: "Session CRUD returning SDK-typed responses"
      contains: "Session"
  key_links:
    - from: "app/shared/engine-types.ts"
      to: "@opencode-ai/sdk"
      via: "type re-exports"
      pattern: "export type.*from '@opencode-ai/sdk'"
    - from: "app/server/config.ts"
      to: "app/shared/engine-types.ts"
      via: "import type"
      pattern: "import type.*from.*engine-types"
    - from: "app/shared/ide-types.ts"
      to: "app/shared/engine-types.ts"
      via: "re-exports"
      pattern: "from './engine-types'"
---

<objective>
Replace hand-rolled SDK type definitions in engine-types.ts with re-exports from @opencode-ai/sdk and update all server-side consumers.

Purpose: engine-types.ts was created during Phase 5 before the SDK was installed. Now that @opencode-ai/sdk@1.1.54 is available, these hand-rolled types create drift — they don't match the actual SDK shapes (e.g., our SessionStatus is a string union but SDK's is an object union, our Session has `createdAt: string` but SDK's has `time.created: number`). This drift will poison every downstream phase.

Output: engine-types.ts with SDK re-exports + app-level types only, all server functions using SDK types, tsc passing.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-sdk-type-realignment/11-RESEARCH.md

Source files to read before editing:
@app/shared/engine-types.ts
@app/shared/ide-types.ts
@app/server/config.ts
@app/server/sessions.ts
@app/server/sdk-client.server.ts

SDK type definitions (read for reference):
@node_modules/@opencode-ai/sdk/dist/gen/types.gen.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite engine-types.ts — SDK re-exports + app-level types</name>
  <files>app/shared/engine-types.ts</files>
  <action>
Rewrite engine-types.ts to eliminate ALL hand-rolled SDK type definitions. The file should contain exactly 3 sections:

**Section 1: SDK type re-exports.** Re-export these types from `@opencode-ai/sdk`:
```typescript
export type {
  Session, Message, UserMessage, AssistantMessage,
  Part, TextPart, ToolPart, ReasoningPart, StepStartPart, StepFinishPart,
  SnapshotPart, PatchPart, AgentPart, RetryPart, CompactionPart, SubtaskPart, FilePart,
  Event, GlobalEvent, SessionStatus,
  Provider, Model, Agent, Pty,
  TextPartInput, FilePartInput,
} from '@opencode-ai/sdk'
```

**Section 2: App-level types (NOT in SDK).** Keep these as-is — they represent dashboard concepts:
- `EngineStatus` — OpenCode server process lifecycle (running, url, projectDir, port)
- `DashboardConfig`, `PortConfig` — dashboard launch configuration
- `EngineErrorResponse` — error wrapper for API responses

**Section 3: UI-friendly derived types + helpers.** These simplify SDK types for React components:
- `ProviderInfo` — `{ id: string; name: string; models: { id: string; name: string }[] }` — flattened from SDK Provider (which has `models: Record<string, Model>`)
- `AgentInfo` — `{ id: string; name: string; description?: string }` — simplified from SDK Agent
- `AppInfo` — keep as-is (has `path`, `gitBranch`, `gitUrl`)
- `toProviderInfo(p: Provider): ProviderInfo` — converts `Record<string, Model>` to model array
- `toAgentInfo(a: Agent): AgentInfo` — picks name/description from SDK Agent
- `sessionStatusLabel(s: SessionStatus): string` — maps SDK's `{type:"idle"|"retry"|"busy"}` to display strings
- `toDisplayDate(timestamp: number): string` — converts SDK Unix timestamps to `toLocaleString()`

**DELETE entirely:** Session, SessionStatus, Message, Part, Event hand-rolled interfaces. DELETE response wrappers: SessionListResponse, SessionCreateResponse, SessionMessagesResponse, SessionStatusResponse, SessionChildrenResponse, SessionPromptRequest. These are unnecessary — SDK methods return typed data directly.

**CRITICAL:** SDK `SessionStatus` is `{type:"idle"} | {type:"retry",...} | {type:"busy"}` NOT a string union. Our old `'pending' | 'running' | 'completed' | 'error'` must be deleted. The `sessionStatusLabel()` helper maps the SDK shape to display strings.

**CRITICAL:** SDK `Session` uses `time: {created: number, updated: number}` NOT `createdAt: string, updatedAt: string`. All timestamp display code must use `toDisplayDate(session.time.created)`.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | head -40`
Expect: Type errors in consumer files (config.ts, sessions.ts, ide-types.ts) — this is expected and will be fixed in Task 2. Verify that engine-types.ts itself has no errors.
Also verify: `grep -c "interface Session" app/shared/engine-types.ts` returns 0 (no hand-rolled Session).
Also verify: `grep -c "from '@opencode-ai/sdk'" app/shared/engine-types.ts` returns at least 1 (SDK re-exports present).
  </verify>
  <done>engine-types.ts contains only SDK re-exports, app-level types, and helper functions. Zero hand-rolled SDK type definitions. File compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update server functions and ide-types.ts to use new SDK types</name>
  <files>app/server/config.ts, app/server/sessions.ts, app/server/sdk-client.server.ts, app/shared/ide-types.ts</files>
  <action>
Update all server-side consumers to use the new SDK-based types from engine-types.ts:

**app/server/config.ts:**
- Update `getProvidersFn`: The SDK `config.providers()` now returns `Record<string, Provider>` (from SDK). The normalization code that converts to `ProviderInfo[]` should use the `toProviderInfo()` helper from engine-types.ts instead of inline mapping. Import `toProviderInfo` and `toAgentInfo` from `../shared/engine-types`.
- Update `getAgentsFn`: SDK `app.agents()` returns agents. Use `toAgentInfo()` helper.
- Remove `as ProviderInfo[]` / `as AgentInfo[]` type assertions — use helper functions for proper conversion.

**app/server/sessions.ts:**
- Return types are now SDK `Session` (from engine-types re-export). The SDK `session.list()` returns sessions with `time.created` (number) not `createdAt` (string).
- `getSessionStatusFn`: SDK returns `SessionStatus` which is `{type:"idle"|"retry"|"busy"}`, not our old string union. Update to handle this shape.
- `getSessionMessagesFn`: SDK messages are `Message` (union of UserMessage | AssistantMessage). Parts are accessed via separate SDK method, not inline on message. Keep current behavior for now (parts will be handled in Plan 02).
- Remove any `Record<string, NonNullable<unknown>>` assertions or JSON roundtrips — SDK returns typed data.

**app/server/sdk-client.server.ts:**
- `EngineStatus` import stays the same (it's app-level, not SDK). No changes needed unless there are type mismatches.

**app/shared/ide-types.ts:**
- Update the re-export section. Remove any types that no longer exist in engine-types.ts (e.g., `SessionListResponse`, `SessionCreateResponse`).
- Keep IDE-specific types (PanelId, etc.) that are NOT from engine-types.
- Re-export the SDK types that consumers need: `Session`, `Message`, `Part`, `SessionStatus`, `ProviderInfo`, `AgentInfo`, `AppInfo`, `EngineStatus`, `toDisplayDate`, `sessionStatusLabel`.
- DELETE re-exports of deleted response wrapper types.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | head -60`
Expect: Errors only in downstream consumer components (ChatMessage.tsx, useStreaming.ts, chat routes) — NOT in server functions or type files. Server-side code should compile cleanly.
Run: `grep -r "Record<string, NonNullable<unknown>>" app/server/` — should return 0 matches.
  </verify>
  <done>All server functions use SDK typed responses. ide-types.ts barrel is updated. No Record<string, unknown> type assertions remain in server code. tsc errors limited to component consumers (addressed in Plan 02).</done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit 2>&1 | grep -c "error TS"` — errors should be ONLY in: ChatMessage.tsx, useStreaming.ts, chat.$sessionId.tsx (these are Plan 02 scope)
2. `grep -r "from '@opencode-ai/sdk'" app/shared/engine-types.ts` — confirms SDK re-exports present
3. `grep -c "interface Session " app/shared/engine-types.ts` — returns 0 (no hand-rolled Session)
4. `grep -c "interface Message " app/shared/engine-types.ts` — returns 0 (no hand-rolled Message)
5. No hand-rolled Part/Event/SessionStatus definitions in engine-types.ts
</verification>

<success_criteria>
- engine-types.ts contains ONLY SDK re-exports + app-level types + helpers (~80-120 LOC, down from 121 LOC of mixed content)
- Server functions compile with SDK types — no type assertions or JSON roundtrips
- ide-types.ts barrel updated to match new exports
- tsc errors restricted to component consumer files (Plan 02 scope)
</success_criteria>

<output>
After completion, create `.planning/phases/11-sdk-type-realignment/11-01-SUMMARY.md`
</output>
