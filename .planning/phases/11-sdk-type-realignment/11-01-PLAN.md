---
phase: 11-sdk-type-realignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/shared/engine-types.ts
  - app/shared/ide-types.ts
  - app/server/sessions.ts
autonomous: true

must_haves:
  truths:
    - "SDK types (Session, Message, Part, SessionStatus) are re-exported from @opencode-ai/sdk, not hand-rolled"
    - "App-specific types (ProviderInfo, AgentInfo, EngineStatus, etc.) remain as local definitions"
    - "Server functions in sessions.ts have explicit SDK return type annotations"
    - "tsc --noEmit passes with zero errors"
    - "npm test passes all 512 assertions"
  artifacts:
    - path: "app/shared/engine-types.ts"
      provides: "SDK re-exports + app-specific type definitions"
      contains: "from '@opencode-ai/sdk'"
    - path: "app/shared/ide-types.ts"
      provides: "Updated re-exports including SDK types (UserMessage, AssistantMessage, TextPart, etc.)"
      contains: "UserMessage"
    - path: "app/server/sessions.ts"
      provides: "Type-safe server functions with SDK return types"
      contains: "Session"
  key_links:
    - from: "app/shared/engine-types.ts"
      to: "@opencode-ai/sdk"
      via: "type re-export"
      pattern: "from '@opencode-ai/sdk'"
    - from: "app/shared/ide-types.ts"
      to: "app/shared/engine-types.ts"
      via: "re-export barrel"
      pattern: "from './engine-types'"
---

<objective>
Replace hand-rolled SDK type definitions with re-exports from @opencode-ai/sdk, and add explicit return type annotations to session server functions.

Purpose: Establish the type foundation so that all consumers import SDK-accurate types instead of incorrect hand-rolled shapes. This is the prerequisite for Plan 02 (consumer migration).

Output: `engine-types.ts` with SDK re-exports + app-specific types, `ide-types.ts` with updated barrel exports, `sessions.ts` with explicit SDK return types.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-sdk-type-realignment/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite engine-types.ts — SDK re-exports + app-specific types</name>
  <files>app/shared/engine-types.ts</files>
  <action>
  Rewrite `app/shared/engine-types.ts` to replace the 5 hand-rolled SDK type definitions (Session, Message, Part, SessionStatus, Event) with re-exports from `@opencode-ai/sdk`.

  **Remove these hand-rolled definitions (lines 37-66):**
  - `SessionStatus` (string union — SDK uses object discriminated union)
  - `Session` (flat interface — SDK has richer fields, number timestamps)
  - `Part` (bag type — SDK has rich discriminated union)
  - `Message` (flat interface — SDK has `UserMessage | AssistantMessage` union)
  - `Event` (bag type — SDK has named event types)

  **Replace with SDK re-exports:**
  ```ts
  // --- SDK type re-exports (source of truth) ---
  export type {
    Session,
    SessionStatus,
    Message,
    UserMessage,
    AssistantMessage,
    Part,
    TextPart,
    ToolPart,
    FilePart,
    ReasoningPart,
    StepStartPart,
    StepFinishPart,
    SnapshotPart,
    PatchPart,
    AgentPart,
    RetryPart,
    CompactionPart,
  } from '@opencode-ai/sdk'
  ```

  **Keep all app-specific types unchanged (no SDK equivalent):**
  - `ModelInfo`, `ProviderInfo`, `AgentInfo`, `AppInfo`
  - `EngineStatus`, `DashboardConfig`, `PortConfig`
  - `SessionPromptRequest`, `SessionListResponse`, `SessionCreateResponse`
  - `SessionMessagesResponse`, `SessionStatusResponse`, `SessionChildrenResponse`
  - `EngineErrorResponse`

  **Update response wrapper types** that reference `Session` or `Message` — they'll now reference SDK types. The response wrappers may need updating since SDK `Session` has different fields. For now, keep the wrapper interfaces but they'll use the SDK `Session` type automatically via re-export.

  **Update the file header comment** to reflect that SDK types are now re-exported, not hand-rolled.

  **CRITICAL — TanStack Start compatibility:** The `@opencode-ai/sdk` package is already in `app/vite.config.ts` as a server-only dependency (line 32, `ssr.noExternal`). This means SDK types can be imported in shared files as `type` imports (no runtime bundle impact) but the SDK module itself must not be imported at runtime on the client side. Using `import type { ... }` ensures this.
  </action>
  <verify>
  Run `npm run typecheck` — must pass with zero errors.
  Run `npm test` — must pass all 512 assertions.
  Verify SDK types are imported: `grep "from '@opencode-ai/sdk'" app/shared/engine-types.ts` returns matches.
  Verify no hand-rolled Session/Message/Part/SessionStatus definitions remain.
  </verify>
  <done>
  engine-types.ts re-exports Session, Message, Part, SessionStatus (+ sub-types) from @opencode-ai/sdk.
  App-specific types (ProviderInfo, AgentInfo, EngineStatus, etc.) remain as local definitions.
  tsc --noEmit passes. npm test passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ide-types.ts re-exports and add SDK type annotations to sessions.ts</name>
  <files>app/shared/ide-types.ts, app/server/sessions.ts</files>
  <action>
  **Part A — Update ide-types.ts re-exports:**

  Update the `export type { ... } from './engine-types'` block to include newly available SDK sub-types. Add:
  - `UserMessage`, `AssistantMessage` (Message union members)
  - `TextPart`, `ToolPart`, `FilePart`, `ReasoningPart` (Part union members — most commonly needed)
  - Remove `Event` from re-exports (replaced by specific event types, consumers should import from SDK directly if needed)

  Keep all existing Phase 5/6 types (SettingsEntry, WorkspaceConfig, PanelId, etc.) unchanged.

  **Part B — Add explicit return type annotations to sessions.ts:**

  Import SDK types in sessions.ts:
  ```ts
  import type { Session, Message } from '../shared/engine-types'
  ```

  Add explicit return type annotations to server functions that currently rely on inference through `unwrapSdkResult()`:
  - `getSessionsFn` handler return: `Promise<Session[]>` — but keep JSON.parse workaround for TanStack serialization. Actually, since `unwrapSdkResult` already infers the SDK type from the generic, and TanStack Start preserves it, we just need to verify the types flow correctly. The main value is adding explicit annotations where types are currently `NonNullable<unknown>`:
  - `getSessionMessagesFn` (line 89): Change return from `Promise<Array<Record<string, NonNullable<unknown>>>>` to `Promise<Message[]>` — this requires the JSON.parse roundtrip to strip index signatures. Cast the result: `return JSON.parse(JSON.stringify(messages)) as Message[]`
  - `getSessionStatusFn` (line 124): Change return from `Promise<NonNullable<unknown>>` to `Promise<SessionStatus>` — import `SessionStatus` and cast: `return JSON.parse(JSON.stringify(status)) as SessionStatus`

  **DO NOT change the JSON.parse(JSON.stringify()) workarounds** — these are necessary for TanStack Start serialization compatibility.
  </action>
  <verify>
  Run `npm run typecheck` — must pass with zero errors.
  Run `npm test` — must pass all 512 assertions.
  Verify `UserMessage` is exported from ide-types.ts: `grep "UserMessage" app/shared/ide-types.ts`
  Verify sessions.ts has type imports: `grep "import type" app/server/sessions.ts`
  </verify>
  <done>
  ide-types.ts re-exports SDK sub-types (UserMessage, AssistantMessage, TextPart, etc.).
  sessions.ts has explicit SDK return type annotations for getSessionMessagesFn and getSessionStatusFn.
  tsc --noEmit passes. npm test passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` — zero errors
2. `npm test` — 512 assertions, 10 suites pass
3. `grep "from '@opencode-ai/sdk'" app/shared/engine-types.ts` — returns SDK import line
4. `grep -c "interface Session" app/shared/engine-types.ts` — returns 0 (no hand-rolled Session)
5. `grep -c "interface Message" app/shared/engine-types.ts` — returns 0 (no hand-rolled Message)
6. `grep "UserMessage" app/shared/ide-types.ts` — re-exported
</verification>

<success_criteria>
- All 5 hand-rolled SDK types replaced with re-exports from @opencode-ai/sdk
- App-specific types preserved without changes
- ide-types.ts barrel updated with SDK sub-types
- sessions.ts has explicit return type annotations
- TypeScript compilation passes
- Test suite passes unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-sdk-type-realignment/11-01-SUMMARY.md`
</output>
