---
phase: 07-chat-terminal
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/settings.tsx
  - app/hooks/useSettings.ts
  - app/components/settings/ProviderCard.tsx
  - app/components/settings/SettingsSection.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a settings page with provider information and UI preferences"
    - "User can view configured AI providers and their models"
    - "User can change UI preferences (theme, font size) and they persist"
    - "Settings persist across page refreshes (stored in SQLite via Drizzle)"
    - "Engine must be running for provider/model data to load"
  artifacts:
    - path: "app/routes/settings.tsx"
      provides: "Full settings page with provider listing and preferences"
      contains: "getProvidersFn"
    - path: "app/hooks/useSettings.ts"
      provides: "Hook for reading/writing settings via server functions"
      exports: ["useSettings", "useSetting"]
    - path: "app/components/settings/ProviderCard.tsx"
      provides: "Card showing provider name, models, status"
      contains: "ProviderInfo"
  key_links:
    - from: "app/routes/settings.tsx"
      to: "app/server/config.ts"
      via: "getProvidersFn server function call"
      pattern: "getProvidersFn"
    - from: "app/hooks/useSettings.ts"
      to: "app/server/settings.ts"
      via: "getAllSettingsFn, setSettingFn server function calls"
      pattern: "setSettingFn|getAllSettingsFn"
    - from: "app/routes/settings.tsx"
      to: "app/hooks/useSettings.ts"
      via: "useSettings hook for preferences"
      pattern: "useSettings"
---

<objective>
Build the settings UI — provider listing, model information, and user preferences.

Purpose: Replace the settings stub with a functional configuration interface that shows AI providers/models from OpenCode SDK and persists user preferences (theme, font size) via the already-built Drizzle settings server functions.

Output: Settings page with provider cards, model listing, and UI preferences section — all wired to real data via server functions and TanStack Query.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-terminal/07-RESEARCH.md

Key existing files:
@app/server/settings.ts — Full CRUD (getSettingFn, setSettingFn, getAllSettingsFn, deleteSettingFn) — already working
@app/server/config.ts — getProvidersFn, getAgentsFn, healthCheckFn — returns provider/model data from SDK
@app/shared/engine-types.ts — ProviderInfo type: { id, name, models: ModelInfo[] }
@app/routes/settings.tsx — Current stub: 28 LOC, just "Configuration and preferences" text
@app/db/schema.ts — Drizzle schema with settings table (key, value, updatedAt)
@app/hooks/useEngine.ts — Pattern for TanStack Query + server functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSettings hook + SettingsSection + ProviderCard components</name>
  <files>
    app/hooks/useSettings.ts
    app/components/settings/SettingsSection.tsx
    app/components/settings/ProviderCard.tsx
  </files>
  <action>
  **Step 1: Create `app/hooks/useSettings.ts`** (~80 LOC):

  Two hooks following the pattern from `useEngine.ts`:

  `useSettings()`:
  - Uses `useQuery` with key `['settings']` to fetch all settings via `getAllSettingsFn()`
  - Returns `{ settings: Record<string, string>, isLoading, error, refetch }`
  - Transform `SettingsEntry[]` into a `Record<string, string>` map for easy access
  - Export a `useSetting(key: string, defaultValue: string)` convenience hook:
    - Returns `{ value, setValue, isLoading }`
    - `setValue` calls `useMutation` with `setSettingFn({ key, value })` then invalidates `['settings']` query

  Both hooks use `@tanstack/react-query` patterns consistent with existing hooks.

  **Step 2: Create `app/components/settings/SettingsSection.tsx`** (~30 LOC):

  Reusable section wrapper for settings groups:
  ```tsx
  interface SettingsSectionProps {
    title: string
    description?: string
    children: React.ReactNode
  }
  ```
  Renders: `<section>` with `<h2>` (text-lg font-semibold), optional `<p>` description (text-sm text-muted-foreground), and children.

  **Step 3: Create `app/components/settings/ProviderCard.tsx`** (~60 LOC):

  Accepts `ProviderInfo` (from engine-types.ts):
  ```typescript
  interface ProviderInfo {
    id: string
    name: string
    models: ModelInfo[]
  }
  interface ModelInfo {
    id: string
    name: string
  }
  ```

  Renders as a card (border rounded-lg p-4 bg-card):
  - Header: Provider name (font-semibold) + provider ID badge (text-xs bg-muted rounded px-2)
  - Model list: Each model as a row with model name + model ID in smaller text
  - If no models: "No models configured" in muted text
  - Use Tailwind classes consistent with IDE dark theme
  </action>
  <verify>
  1. `npm run typecheck` passes
  2. Files created with correct imports
  </verify>
  <done>useSettings hook wraps Drizzle CRUD with TanStack Query. useSetting provides per-key access with mutations. SettingsSection + ProviderCard components created.</done>
</task>

<task type="auto">
  <name>Task 2: Build full settings page with providers + preferences</name>
  <files>
    app/routes/settings.tsx
  </files>
  <action>
  Replace the settings stub with a full settings page (~150 LOC):

  **Layout:**
  ```
  ┌─────────────────────────────────────────────────┐
  │  Settings                                        │
  │  ─────────────────────────────────────────────── │
  │                                                   │
  │  AI Providers                                     │
  │  Configured providers and available models         │
  │  ┌──────────────┐ ┌──────────────┐               │
  │  │ Anthropic     │ │ OpenAI       │               │
  │  │ claude-4-...  │ │ gpt-4o       │               │
  │  │ claude-3-...  │ │ gpt-4o-mini  │               │
  │  └──────────────┘ └──────────────┘               │
  │                                                   │
  │  Preferences                                      │
  │  UI and editor settings                           │
  │  ┌─────────────────────────────────────┐         │
  │  │ Font Size:    [13] ▼                │         │
  │  │ Theme:        [Dark] ▼              │         │
  │  │ Editor Tab:   [2]   ▼               │         │
  │  └─────────────────────────────────────┘         │
  │                                                   │
  │  Engine                                           │
  │  Connection status and controls                   │
  │  Status: ● Running   Port: 42069                 │
  └─────────────────────────────────────────────────┘
  ```

  **Implementation:**

  1. **Providers section:**
     - Use TanStack Query: `useQuery({ queryKey: ['providers'], queryFn: () => getProvidersFn() })`
     - Map providers to `<ProviderCard>` components in a responsive grid (`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`)
     - Show loading skeleton while fetching
     - Show "Engine not running — start the engine to see providers" if engine health check fails

  2. **Preferences section:**
     - Font size: `useSetting('ui.fontSize', '13')` — `<select>` with options: 11, 12, 13, 14, 15, 16
     - Theme: `useSetting('ui.theme', 'dark')` — `<select>` with options: dark, light (light disabled for now, show "coming soon")
     - Tab size: `useSetting('editor.tabSize', '2')` — `<select>` with options: 2, 4, 8
     - Each preference row: label (w-32) + select control + description text
     - On change: call `setValue(newValue)` from useSetting hook — auto-persists

  3. **Engine section:**
     - Use `useEngine()` hook (already exists) for status
     - Show connection status: green dot "Running" or red dot "Stopped"
     - Show port number from engine status
     - Start/Stop button using engine hook's `startEngine`/`stopEngine`

  **Page wrapper:**
  - Max width container: `max-w-4xl mx-auto p-6 space-y-8`
  - Page title: `<h1 className="text-2xl font-bold">Settings</h1>`
  - Consistent with the dark theme styling used throughout the app
  - Use `SettingsSection` component for each group

  **Route setup:**
  Keep the existing `createFileRoute('/settings')` pattern. Load providers in the component (not route loader) since they depend on engine state which may change.
  </action>
  <verify>
  1. `npm run typecheck` passes
  2. Start dashboard, navigate to `/settings`
  3. See provider cards with model listings (if engine running)
  4. Change font size preference — value persists after page refresh
  5. Engine status shows correct state
  </verify>
  <done>Settings page shows provider cards with models, UI preferences with persistence, and engine status. Preferences auto-save via useSetting hook. Provider data loads from SDK via server functions.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with zero new errors
- `/settings` page shows provider information from OpenCode SDK
- Font size, theme, tab size preferences save and persist across refresh
- Engine section shows live connection status
- Error state handled: shows message when engine not running
</verification>

<success_criteria>
- Settings page has 3 sections: Providers, Preferences, Engine
- Provider cards show provider name, ID, and model list
- Preferences persist in SQLite via the existing Drizzle settings server functions
- Changing a preference auto-saves (no explicit save button needed)
- Page handles engine-offline state gracefully (shows message, doesn't crash)
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-terminal/07-03-SUMMARY.md`
</output>
