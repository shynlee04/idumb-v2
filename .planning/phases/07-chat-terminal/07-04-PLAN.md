---
phase: 07-chat-terminal
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/settings.tsx
  - app/components/settings/GeneralTab.tsx
  - app/components/settings/ProvidersTab.tsx
  - app/components/settings/AppearanceTab.tsx
  - app/components/settings/SettingsExport.tsx
  - app/components/chat/ModelPicker.tsx
  - app/routes/chat.tsx
  - app/hooks/useSettings.ts
  - app/hooks/useTheme.ts
  - app/routes/__root.tsx
  - app/routes/chat.$sessionId.tsx
autonomous: true

must_haves:
  truths:
    - "User sees settings page with 3 tabbed sections: General, Providers, Appearance"
    - "User picks AI model via dropdown in chat header for quick switching"
    - "User manages providers via list + detail panel in settings Providers tab"
    - "User toggles dark/light theme in Appearance tab and change persists"
    - "User exports settings as JSON and imports from JSON file for backup/migration"
    - "User sees full model/provider config in settings page Providers tab"
  artifacts:
    - path: "app/routes/settings.tsx"
      provides: "Settings page with tab navigation"
      min_lines: 40
    - path: "app/components/settings/ProvidersTab.tsx"
      provides: "Provider list + detail panel with model listing"
      min_lines: 60
    - path: "app/components/settings/AppearanceTab.tsx"
      provides: "Theme toggle + appearance preferences"
      min_lines: 40
    - path: "app/components/chat/ModelPicker.tsx"
      provides: "Quick model selection dropdown for chat header"
      min_lines: 40
    - path: "app/hooks/useTheme.ts"
      provides: "Theme management hook with localStorage persistence"
      min_lines: 25
    - path: "app/hooks/useSettings.ts"
      provides: "React Query hooks for settings CRUD + provider/model data"
      min_lines: 40
  key_links:
    - from: "app/routes/settings.tsx"
      to: "app/components/settings/ProvidersTab.tsx"
      via: "tab rendering"
      pattern: "ProvidersTab"
    - from: "app/routes/chat.tsx"
      to: "app/components/chat/ModelPicker.tsx"
      via: "import and render in chat header"
      pattern: "ModelPicker"
    - from: "app/hooks/useTheme.ts"
      to: "app/routes/__root.tsx"
      via: "ThemeProvider wrapping app"
      pattern: "ThemeProvider"
    - from: "app/hooks/useSettings.ts"
      to: "app/server/settings.ts"
      via: "React Query wrapping getSettingFn/setSettingFn"
      pattern: "getSettingFn|setSettingFn"
    - from: "app/hooks/useSettings.ts"
      to: "app/server/config.ts"
      via: "React Query wrapping getProvidersFn"
      pattern: "getProvidersFn"
---

<objective>
Build the settings page with 3 tabs (General, Providers, Appearance), model picker dropdown in chat header, dark/light theme toggle, and JSON settings export/import.

Purpose: Users need to configure AI models, manage providers, adjust appearance, and backup settings — both from a dedicated settings page and via quick controls in the chat interface (CHAT-05).

Output: Settings page, 4 tab components, ModelPicker, useSettings + useTheme hooks, theme system integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-terminal/07-RESEARCH.md
@.planning/phases/07-chat-terminal/07-CONTEXT.md
@app/routes/settings.tsx
@app/routes/chat.tsx
@app/routes/__root.tsx
@app/server/config.ts
@app/server/settings.ts
@app/shared/engine-types.ts
@app/styles/app.css
@app/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme system + Settings page with 3 tabs + hooks</name>
  <files>
    app/hooks/useTheme.ts
    app/hooks/useSettings.ts
    app/routes/__root.tsx
    app/routes/settings.tsx
    app/components/settings/GeneralTab.tsx
    app/components/settings/ProvidersTab.tsx
    app/components/settings/AppearanceTab.tsx
    app/components/settings/SettingsExport.tsx
    app/styles/app.css
  </files>
  <action>
**Create app/hooks/useTheme.ts** (~40 LOC):

Theme management with React context + localStorage:

```typescript
type Theme = "dark" | "light"

interface ThemeContextValue {
  theme: Theme
  setTheme: (theme: Theme) => void
  toggleTheme: () => void
}
```

- `ThemeProvider` component: reads initial theme from localStorage key `"idumb-theme"` (default: `"dark"`)
- On theme change: update `document.documentElement.className` (set `"dark"` or `"light"` class on `<html>`)
- Persist to localStorage on change
- Also persist to SQLite via `setSettingFn({ key: "theme", value: theme })` (fire-and-forget, non-blocking)
- Export: `ThemeProvider`, `useTheme`

**Create app/hooks/useSettings.ts** (~60 LOC):

React Query hooks wrapping existing server functions:

```typescript
// Settings CRUD hooks
export function useSetting(key: string)         // useQuery → getSettingFn
export function useSettings()                    // useQuery → getAllSettingsFn
export function useSetSetting()                  // useMutation → setSettingFn
export function useDeleteSetting()               // useMutation → deleteSettingFn

// Provider/model data hooks (from config.ts)
export function useProviders()                   // useQuery → getProvidersFn
export function useAgents()                      // useQuery → getAgentsFn
export function useConfig()                      // useQuery → getConfigFn

// Query key factory
export const settingsKeys = {
  all: ["settings"],
  single: (key: string) => ["settings", key],
  providers: ["providers"],
  agents: ["agents"],
  config: ["config"],
}
```

- `useProviders` returns `ProviderInfo[]` (with models nested) — server function already normalizes SDK data
- Stale time: 30s for providers (rarely change), 5s for settings (user may edit)

**Update app/routes/__root.tsx:**

1. Import `ThemeProvider` from `../hooks/useTheme`
2. Wrap the app content with `ThemeProvider` inside `QueryClientProvider`:
   ```tsx
   <QueryClientProvider client={queryClient}>
     <ThemeProvider>
       <EventStreamProvider>
         <Outlet />
       </EventStreamProvider>
     </ThemeProvider>
   </QueryClientProvider>
   ```
3. Remove the hardcoded `className="dark"` from `<html>` tag — theme is now controlled by ThemeProvider

**Update app/styles/app.css:**

Add light theme CSS variables. Use Tailwind v4's `@theme` inline pattern with a media/class selector:

```css
/* Light theme overrides (applied when <html> has class="light") */
.light {
  --color-background: oklch(0.98 0.005 260);
  --color-foreground: oklch(0.15 0.01 260);
  --color-card: oklch(0.96 0.005 260);
  --color-card-foreground: oklch(0.15 0.01 260);
  --color-muted: oklch(0.93 0.005 260);
  --color-muted-foreground: oklch(0.45 0.01 260);
  --color-border: oklch(0.88 0.01 260);
  --color-sidebar: oklch(0.96 0.005 260);
  --color-sidebar-foreground: oklch(0.20 0.01 260);
  --color-terminal: oklch(0.98 0.003 260);
  --color-terminal-foreground: oklch(0.15 0.01 260);
  /* ... other light overrides for primary, secondary, accent, etc. */
}
```

Ensure existing dark values stay as default (no class needed) so `class="dark"` or no class = dark theme.

**Rewrite app/routes/settings.tsx** (~60 LOC):

Replace the stub with a tabbed settings page:

```typescript
import { useState } from "react"
import { createFileRoute } from "@tanstack/react-router"
import { GeneralTab } from "../components/settings/GeneralTab"
import { ProvidersTab } from "../components/settings/ProvidersTab"
import { AppearanceTab } from "../components/settings/AppearanceTab"
```

- Tab navigation: horizontal tabs at top (General | Providers | Appearance)
- Use `useState<string>("general")` for active tab
- Tab buttons: `border-b-2 border-primary` for active, `text-muted-foreground` for inactive
- Render the active tab component below

**Create app/components/settings/GeneralTab.tsx** (~50 LOC):

- App info section: show project directory (from `getAppInfoFn`), engine status
- Version info: hardcoded iDumb v2 version
- Engine controls: Start/Stop/Restart buttons using `useEngine` hook
- Nothing fancy — informational panel

**Create app/components/settings/ProvidersTab.tsx** (~100 LOC):

Per user locked decision: "list + detail panel"

- Left side: provider list (from `useProviders()`)
  - Each provider: name, model count badge
  - Click to select → shows detail on right
- Right side: provider detail panel
  - Provider name
  - List of models: each model shows id, name
  - Active model indicator (if matches current config)
  - "Set as default" button for each model (will be wired to SDK config in future — for now, store in SQLite via `setSettingFn({ key: "default-model", value: JSON.stringify({ providerID, modelID }) })`)
- Empty state: "No providers configured" with instructions

**Create app/components/settings/AppearanceTab.tsx** (~50 LOC):

- Theme toggle: "Dark" / "Light" toggle buttons using `useTheme()` — per user locked decision
- Font size selector: dropdown (12, 13, 14, 16) — persisted via `setSettingFn`
- Preview: small preview box showing how theme looks
- Layout: "Reset layout" button that calls `useLayoutStore.getState().resetLayout()`

**Create app/components/settings/SettingsExport.tsx** (~60 LOC):

Per user locked decision: "JSON export/import for settings backup/migration"

- Export button: calls `getAllSettingsFn()`, creates a JSON blob, triggers `<a download>` with Blob URL
  - Filename: `idumb-settings-${date}.json`
  - Content: `{ version: "1.0", exportedAt: ISO timestamp, settings: [...entries] }`
- Import button: `<input type="file" accept=".json">`, reads file, validates JSON structure, calls `setSettingFn` for each entry
  - Show confirmation dialog (how many settings will be imported)
  - Show success/error toast-like message after import
- Place this component at the bottom of the General tab or as its own section
  </action>
  <verify>
`npm run typecheck:app` passes. `npm run build:app` succeeds. Navigate to /settings — 3 tabs render. Click Appearance → toggle theme → page switches between dark and light. Refresh → theme persists.
  </verify>
  <done>
Settings page with 3 tabs (General, Providers, Appearance) replaces the stub. Theme system with dark/light toggle integrated into __root.tsx via ThemeProvider. Light theme CSS variables exist. useSettings hooks wrap existing server functions. Provider list + detail panel shows configured providers and models. JSON export/import works for settings backup. Theme persists across page reloads via localStorage + SQLite.
  </done>
</task>

<task type="auto">
  <name>Task 2: Model picker in chat header</name>
  <files>
    app/components/chat/ModelPicker.tsx
    app/routes/chat.tsx
    app/routes/chat.$sessionId.tsx
  </files>
  <action>
**Create app/components/chat/ModelPicker.tsx** (~70 LOC):

Quick model selection dropdown for the chat header:

- Use `useProviders()` from useSettings.ts to get provider list with models
- Use `useSetting("default-model")` to get current default model
- Dropdown trigger: small button showing current model name (or "Select model" if none)
  - Format: "provider/model" (e.g. "anthropic/claude-sonnet-4-20250514")
  - Compact: `text-xs` with `ChevronDown` icon
- Dropdown menu: native `<select>` element styled with Tailwind (simpler than custom dropdown)
  - Option groups by provider: `<optgroup label="Anthropic">` with models inside
  - On change: save to SQLite via `setSettingFn({ key: "default-model", value: JSON.stringify({ providerID, modelID }) })`
  - Invalidate the settings query so other components reflect the change
- Alternative: if `<select>` looks too plain, use a custom dropdown with `useState(isOpen)`:
  - Position: absolute below trigger, `z-50`
  - Items: grouped by provider, each model clickable
  - Close on click outside or Escape

The model picker does NOT actually change the model for existing streams — it sets the default for the NEXT prompt. The `sendPrompt` function in `useStreaming.ts` already accepts `options.modelID` and `options.providerID`.

**Update app/routes/chat.tsx:**

1. Import `ModelPicker` from `../components/chat/ModelPicker`
2. Add ModelPicker to the chat header bar (next to the "iDumb Chat" title):
   ```tsx
   <header className="flex items-center justify-between px-4 py-2 border-b border-border bg-background/80 backdrop-blur-sm">
     <h1 className="text-sm font-semibold">iDumb Chat</h1>
     <div className="flex items-center gap-3">
       <ModelPicker />
       <EngineStatus />
     </div>
   </header>
   ```
3. The ModelPicker should be compact enough to sit alongside EngineStatus without overwhelming the header

**Wire selected model into chat prompts** (in chat.$sessionId.tsx, small update):
- Read the default model from settings: `const defaultModel = useSetting("default-model")`
- Parse the JSON value to get `{ providerID, modelID }`
- Pass to `sendPrompt(sessionId, text, { modelID, providerID })` when sending
- This makes the model picker functional — selecting a model actually changes which model responds

Per user locked decision: "Model picker in both places — quick dropdown in chat header for fast switching + full config in settings page"
  </action>
  <verify>
`npm run typecheck:app` passes. Navigate to /chat — model picker dropdown appears in header next to engine status. Click dropdown — shows providers grouped with their models. Select a model — it persists (check /settings Providers tab shows same selection). Send a prompt — the selected model should be used (verify in SSE events that providerID/modelID are sent).
  </verify>
  <done>
ModelPicker component renders a compact model selection dropdown in the chat header. Selecting a model persists the choice to SQLite via settings. The selected model is passed to sendPrompt for subsequent messages. Settings Providers tab and chat header ModelPicker share the same data source (useProviders). User can quickly switch models without leaving the chat.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — succeeds
3. Navigate to /settings — 3 tabs render correctly with content
4. Settings > Appearance — toggle theme between dark and light, verify visual change
5. Settings > Providers — see provider list, click to see models
6. Settings > General — JSON export downloads file, import restores settings
7. Navigate to /chat — model picker dropdown in header shows providers/models
8. Select a model, send a prompt — model selection is used
9. Refresh page — theme and model selection persist
</verification>

<success_criteria>
- Settings page has 3 tabbed sections: General, Providers, Appearance (user locked decision)
- Model picker exists in BOTH chat header AND settings page (user locked decision)
- Provider management via list + detail panel (user locked decision)
- Dark + light theme toggle works and persists (user locked decision)
- JSON export/import for settings backup (user locked decision)
- Persistence is split: SDK for provider/model config, SQLite for app preferences (user locked decision)
- NO keybindings UI (user deferred decision)
- Theme change reflects immediately across the app
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-terminal/07-04-SUMMARY.md`
</output>
