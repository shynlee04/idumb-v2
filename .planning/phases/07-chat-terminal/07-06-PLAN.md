---
phase: 07-chat-terminal
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ide/IDEShell.tsx
  - app/stores/layout-store.ts
  - app/components/file-tree/FileTree.tsx
  - app/components/chat/parts/ToolCallAccordion.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Integrated terminal is visible in IDE bottom panel on first visit"
    - "Terminal can be toggled via button click or Cmd+J keyboard shortcut"
    - "File tree displays full file/folder names and folders expand to show children"
    - "Tool call accordions have copy buttons on input/output sections"
  artifacts:
    - path: "app/components/ide/IDEShell.tsx"
      provides: "Terminal toggle button outside react-resizable-panels Group"
      contains: "togglePanel"
    - path: "app/stores/layout-store.ts"
      provides: "Clean initial state with terminal NOT collapsed"
      contains: "collapsed: []"
    - path: "app/components/file-tree/FileTree.tsx"
      provides: "Lazy-loading file tree with folder expansion"
      contains: "onToggle"
    - path: "app/components/chat/parts/ToolCallAccordion.tsx"
      provides: "Copy buttons on tool call input and output"
      contains: "CopyButton"
  key_links:
    - from: "app/components/ide/IDEShell.tsx"
      to: "app/stores/layout-store.ts"
      via: "useLayoutStore for collapsed state + togglePanel"
      pattern: "useLayoutStore"
    - from: "app/components/file-tree/FileTree.tsx"
      to: "app/hooks/useFiles.ts"
      via: "useDirectory hook for lazy subdirectory loading"
      pattern: "useDirectory"
---

<objective>
Fix three UI component UAT gaps: terminal panel visibility (Gap 2), file tree regression (Gap 7), and tool call copy buttons (Gap 1).

Purpose: These are visual/interactive component bugs that prevent users from accessing the terminal, browsing files, and copying tool outputs. All have diagnosed root causes.
Output: Visible terminal panel with toggle, functional file tree with folder expansion, and copy-enabled tool accordions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-terminal/07-UAT.md

@app/components/ide/IDEShell.tsx
@app/stores/layout-store.ts
@app/shared/ide-types.ts
@app/components/file-tree/FileTree.tsx
@app/components/file-tree/FileTreeNode.tsx
@app/hooks/useFiles.ts
@app/server/files.ts
@app/components/chat/parts/ToolCallAccordion.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix terminal panel visibility (Gap 2)</name>
  <files>app/components/ide/IDEShell.tsx, app/stores/layout-store.ts</files>
  <action>
**Root cause:** Persisted collapsed state in localStorage (key: 'idumb-ide-layout') has `collapsed:['terminal']` from a previous session. On mount, the hydration effect collapses the terminal to zero height. The toggle button exists but is placed INSIDE the `<Group>` component — react-resizable-panels only accepts `<Panel>` and `<Separator>` as direct Group children, so the button may not render properly.

**Fix 1 — Move toggle button outside Group (IDEShell.tsx):**

The collapsed terminal indicator button (currently between `</Panel>` for terminal and `</Group>` for ide-vertical) must be moved OUTSIDE the Group. Change the editor-area Panel content from:

```tsx
<Panel id="editor-area" minSize={40}>
  <Group id="ide-vertical" orientation="vertical" onLayoutChange={...}>
    <Panel id="editor">...</Panel>
    <Separator>...</Separator>
    <Panel id="terminal">...</Panel>
    {isTerminalCollapsed && <button>...</button>}  // WRONG: inside Group
  </Group>
</Panel>
```

To:

```tsx
<Panel id="editor-area" minSize={40}>
  <div className="flex flex-col h-full">
    <Group id="ide-vertical" orientation="vertical" onLayoutChange={...}>
      <Panel id="editor">...</Panel>
      <Separator>...</Separator>
      <Panel id="terminal">...</Panel>
    </Group>
    {isTerminalCollapsed && (
      <button
        onClick={() => {
          terminalRef.current?.expand()
          togglePanel('terminal')
        }}
        className="flex h-7 w-full items-center gap-1.5 border-t border-border bg-terminal px-3 text-xs text-muted-foreground transition-colors hover:bg-accent hover:text-foreground"
        title="Toggle terminal (Cmd+J)"
      >
        <TerminalIcon size={12} />
        <span className="font-medium">Terminal</span>
        <ChevronUp size={12} className="ml-auto" />
      </button>
    )}
  </div>
</Panel>
```

The key change: wrap Group + button in a `<div className="flex flex-col h-full">` and place the button AFTER the Group as a sibling, not a Group child.

**Fix 2 — Ensure defaultSizes sum to 100 (layout-store.ts):**

Verify the vertical group panel defaults sum to 100:
- `editor.defaultSize: 70` + `terminal.defaultSize: 30` = 100 (correct)

If editor is not 70, change it to 70. The horizontal group has sidebar (20) and editor-area (80 — implicitly, since react-resizable-panels auto-fills).

**Fix 3 — Clear stale collapsed state:**

The persisted localStorage may have `collapsed: ['terminal']` from past sessions. To handle this:
- In layout-store.ts, do NOT change the initial state (`collapsed: []` is correct)
- The fix is in the hydration behavior: if the toggle button is properly visible (Fix 1), users can re-expand the terminal
- The Cmd+J shortcut (already implemented) also provides a way to toggle

**Fix 4 — Ensure Group gets flex-1:**

The `<Group>` inside the flex container needs `className="flex-1"` or the Group should fill available space. React-resizable-panels Groups default to fill their container, but verify by adding `style={{ flex: 1 }}` to the Group if needed.
  </action>
  <verify>
1. `npm run typecheck:app` — zero errors
2. In browser: navigate to /ide — terminal panel should be visible in bottom area
3. Collapse terminal via drag — toggle button should appear at bottom
4. Click toggle button — terminal should expand
5. Press Cmd+J — terminal should toggle
  </verify>
  <done>
- Terminal panel visible in IDE on first visit (not collapsed)
- Toggle button renders outside Group, visible when terminal is collapsed
- Cmd+J keyboard shortcut toggles terminal visibility
- Panel sizes sum to 100 in vertical group
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix file tree name display + folder expansion (Gap 7)</name>
  <files>app/components/file-tree/FileTree.tsx</files>
  <action>
**Root cause (Phase 6 regression):** Two issues: (1) File tree names display as single characters. (2) Folders cannot expand because `children: null` in the server response marks folders as "unloaded branches" but NO lazy-loading mechanism exists — when the user clicks to expand, react-arborist tries to render null children.

**Fix — Add lazy-loading tree data management:**

Refactor `FileTree.tsx` to manage hierarchical tree state with lazy-loaded subdirectories:

1. **Track tree data in component state** instead of rendering server data directly. Initialize state from the root `useDirectory` query data.

2. **Add `childrenAccessor` function** — react-arborist supports a `childrenAccessor` prop to control how children are resolved. Use this OR manage the data prop to include fetched children.

3. **Implement folder expansion** — When a folder is toggled open:
   - Call `listDirectoryFn` with the folder's `id` (which is the relative path)
   - Merge the returned `FileNode[]` into the tree data as children of the expanded folder
   - Update the tree data state to trigger re-render

Implementation approach (state-managed tree):

```tsx
import { useState, useCallback, useEffect } from "react"
import { Tree } from "react-arborist"
import { useDirectory } from "../../hooks/useFiles"
import { listDirectoryFn } from "../../server/files"
import { FileTreeNode } from "./FileTreeNode"
import type { FileNode } from "../../shared/ide-types"

export function FileTree({ rootPath }: { rootPath: string }) {
  const { data: rootData, isLoading, error } = useDirectory(rootPath)
  const [treeData, setTreeData] = useState<FileNode[]>([])

  // Initialize tree data from root query
  useEffect(() => {
    if (rootData) {
      setTreeData(rootData.map(node => ({
        ...node,
        // Folders get empty children array (expandable, not yet loaded)
        // Files get no children property (leaf nodes)
        children: node.isFolder ? [] : undefined,
      })))
    }
  }, [rootData])

  // Lazy-load children when a folder is toggled open
  const handleToggle = useCallback(async (id: string) => {
    // Find the node in tree data
    const findAndUpdate = async (nodes: FileNode[]): Promise<FileNode[]> => {
      return Promise.all(nodes.map(async (node) => {
        if (node.id === id && node.isFolder) {
          // Only fetch if children are empty (not yet loaded)
          if (!node.children || node.children.length === 0) {
            try {
              const children = await listDirectoryFn({ data: { dirPath: node.id } })
              return {
                ...node,
                children: children.map(child => ({
                  ...child,
                  children: child.isFolder ? [] : undefined,
                })),
              }
            } catch {
              return node // Keep as-is on error
            }
          }
          return node
        }
        if (node.children && node.children.length > 0) {
          return { ...node, children: await findAndUpdate(node.children) }
        }
        return node
      }))
    }

    setTreeData(prev => {
      findAndUpdate(prev).then(setTreeData)
      return prev
    })
  }, [])

  // ... existing loading/error/empty states ...

  return (
    <div className="h-full w-full">
      <Tree<FileNode>
        data={treeData}
        indent={16}
        rowHeight={28}
        overscanCount={5}
        openByDefault={false}
        disableDrag
        disableDrop
        onToggle={handleToggle}
      >
        {FileTreeNode}
      </Tree>
    </div>
  )
}
```

Key points:
- Convert `children: null` from server to `children: []` (empty array = expandable in react-arborist)
- `onToggle` callback fetches subdirectory contents via `listDirectoryFn` server function
- Children are fetched once per folder (check if children array is empty before fetching)
- The tree data is managed as component state, updated on lazy load

**Important:** The `onToggle` prop in react-arborist v3 receives the toggled node ID. Check the actual API signature using the installed version — it might be `onToggle?: (id: string) => void` or accept a node object. Adapt accordingly.

**For the single-character name issue:** This may be caused by `children: null` confusing react-arborist's rendering pipeline. The fix above (using `[]` instead of `null`) should resolve it. If it persists after the fix, check:
- Whether `node.data.name` in FileTreeNode.tsx actually contains the full name
- Whether there's a CSS width constraint truncating text
  </action>
  <verify>
1. `npm run typecheck:app` — zero errors
2. In browser: navigate to /ide — file tree should show full file/folder names
3. Click a folder — it should expand and show its children
4. Click again — it should collapse
5. Navigate deep folders — each level should lazy-load on first expansion
  </verify>
  <done>
- File tree displays full file and folder names (not single characters)
- Folders expand on click, fetching subdirectory contents lazily
- Tree navigation works at arbitrary depth
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify tool call copy buttons exist (Gap 1)</name>
  <files>app/components/chat/parts/ToolCallAccordion.tsx</files>
  <action>
**Root cause:** The UAT reported "no buttons for download or copy" on tool operations. However, the current ToolCallAccordion.tsx already has `CopyButton` components on the Input section (line 128) and Output section (line 140) in the expanded view. FilePartRenderer.tsx also has download buttons on both image and non-image branches.

**Verification only** — confirm the following exist in ToolCallAccordion.tsx:

1. `CopyButton` component defined (accepts `text: string`, uses `navigator.clipboard.writeText`)
2. `<CopyButton text={JSON.stringify(state.input, null, 2)} />` in the Input section header
3. `<CopyButton text={state.output} />` in the Output section header (inside `state.status === "completed"` guard)
4. Both `Copy` and `Check` icons imported from `lucide-react`

If all four exist, this gap is already resolved by the current code. No changes needed.

If any are missing (e.g., if the working directory changes are incomplete):
- Add the CopyButton component as a local helper
- Wire it into the Input and Output section headers with appropriate text props

**Note:** The UAT gap mentions "download button on FilePartRenderer image branch" — but looking at the current FilePartRenderer.tsx, the image branch already has a download `<a>` with the `Download` icon (lines 31-38). Verify this is present; if so, Gap 1 is fully resolved.
  </action>
  <verify>
1. `grep -n "CopyButton" app/components/chat/parts/ToolCallAccordion.tsx` — should find definition + two usages
2. `grep -n "Download" app/components/chat/parts/FilePartRenderer.tsx` — should find download icon/link
3. `npm run typecheck:app` — zero errors
  </verify>
  <done>
- ToolCallAccordion has copy-to-clipboard buttons on input and output sections
- FilePartRenderer has download buttons on both image and non-image file cards
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — builds successfully
3. In /ide: terminal panel visible, toggle button works when collapsed, Cmd+J toggles
4. In /ide: file tree shows full names, folders expand on click to show children
5. In /chat: tool call accordions have copy buttons in expanded view
</verification>

<success_criteria>
- Terminal panel is visible on first visit to /ide and can be toggled via button or Cmd+J
- File tree displays full file/folder names and supports folder expansion with lazy loading
- Tool call accordions have copy buttons on input and output sections
- Zero TypeScript errors, app builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-terminal/07-06-SUMMARY.md`
</output>
