---
phase: 07-chat-terminal
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/index.server.ts
  - app/styles/app.css
  - app/routes/api/sessions.$id.prompt.ts
  - app/hooks/useStreaming.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settings page persists changes — CRUD operations work without 'no such table' errors"
    - "Settings export downloads a JSON file with all settings"
    - "Theme toggle switches between dark and light color schemes immediately"
    - "AI streaming terminates properly — last message renders without manual abort"
  artifacts:
    - path: "app/db/index.server.ts"
      provides: "Drizzle migration runs on DB init"
      contains: "migrate(db"
    - path: "app/styles/app.css"
      provides: "CSS custom properties referenced by utilities via var()"
      contains: "@theme {"
    - path: "app/routes/api/sessions.$id.prompt.ts"
      provides: "Server-side stream termination on session.idle/error"
      contains: "session.idle"
    - path: "app/hooks/useStreaming.ts"
      provides: "Client-side terminal event detection"
      contains: "session.idle"
  key_links:
    - from: "app/db/index.server.ts"
      to: "drizzle/0000_white_slyde.sql"
      via: "migrate() loads SQL from migrationsFolder"
      pattern: "migrationsFolder.*drizzle"
    - from: "app/styles/app.css"
      to: ".light class overrides"
      via: "@theme generates CSS custom properties, .light overrides them"
      pattern: "@theme \\{"
    - from: "app/routes/api/sessions.$id.prompt.ts"
      to: "app/hooks/useStreaming.ts"
      via: "SSE stream close triggers client-side done=true"
      pattern: "event\\.type.*session\\.idle"
---

<objective>
Fix three infrastructure-level UAT gaps: database migrations (Gap 3/5), theme CSS (Gap 4), and stream termination (Gap 6).

Purpose: These are data/transport layer bugs that prevent settings persistence, theme switching, and proper streaming lifecycle. All have diagnosed root causes and known fixes.
Output: Working settings persistence, functional theme toggle, and self-terminating AI streams.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-terminal/07-UAT.md

@app/db/index.server.ts
@app/db/schema.ts
@drizzle/0000_white_slyde.sql
@app/styles/app.css
@app/hooks/useTheme.tsx
@app/routes/api/sessions.$id.prompt.ts
@app/hooks/useStreaming.ts
@app/shared/engine-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix DB migration + theme CSS (Gap 3/5, Gap 4)</name>
  <files>app/db/index.server.ts, app/styles/app.css</files>
  <action>
**Gap 3/5 — Database migration (also fixes settings export Gap 5):**

Verify `app/db/index.server.ts` contains a `migrate()` call that runs on module load. The correct implementation:

1. Import `migrate` from `drizzle-orm/better-sqlite3/migrator`
2. After creating the drizzle client, call `migrate(db, { migrationsFolder: resolve(import.meta.dirname, '../../drizzle') })`
3. Wrap in try/catch — migration failures are non-fatal (log to stderr, NOT console.log)
4. The `drizzle/` folder contains `0000_white_slyde.sql` which creates the `settings` table
5. `migrate()` is idempotent — it tracks applied migrations in `__drizzle_migrations` table

If the migrate() call is already present (it may have been added during UAT debugging), verify:
- The migrationsFolder path is correct: `resolve(import.meta.dirname, '../../drizzle')` (from `app/db/` up two levels to project root)
- Error handling uses `process.stderr.write()` not `console.log` (TUI safety)
- The migration runs AFTER WAL pragma is set

**Gap 4 — Theme toggle CSS:**

Verify `app/styles/app.css` line 5 uses `@theme {` (NOT `@theme inline {`).

Why: Tailwind v4's `@theme inline` bakes color values directly into utility classes (e.g., `bg-background` compiles to `background-color: oklch(0.145 0.013 260)`). With `@theme` (no inline), utilities reference CSS custom properties via `var(--color-background)`. This allows the `.light` class (lines 67-97) to override those properties and actually change the theme.

If already correct, no changes needed. If it still says `@theme inline`, change to `@theme`.
  </action>
  <verify>
1. `grep -n "migrate" app/db/index.server.ts` — should show migrate import and call
2. `head -6 app/styles/app.css` — line 5 should be `@theme {` (no "inline")
3. `npm run typecheck:app` — zero errors
  </verify>
  <done>
- DB migration runs on startup, `settings` table exists, `getAllSettingsFn()` returns results without error
- CSS uses `@theme` (not `@theme inline`), enabling `.light` class overrides to work
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix stream termination — server + client (Gap 6)</name>
  <files>app/routes/api/sessions.$id.prompt.ts, app/hooks/useStreaming.ts</files>
  <action>
**Server-side (sessions.$id.prompt.ts):**

The for-await loop over `eventResult.stream` must break on terminal SDK events. Verify the loop body (after `sendEvent(event.type, event)`) contains these break conditions:

```typescript
// Break on terminal status — SDK uses discriminated unions:
// - EventSessionIdle: { type: "session.idle", properties: { sessionID } }
// - EventSessionError: { type: "session.error", properties: { sessionID?, error } }
// - EventSessionStatus: { type: "session.status", properties: { sessionID, status: { type: "idle"|"busy"|"retry" } } }
if (event.type === "session.idle") break
if (event.type === "session.error") break
if (event.type === "session.status") {
  const statusObj = props?.status as { type?: string } | undefined
  if (statusObj?.type === "idle") break
}
```

Critical: Do NOT compare `props?.status === 'idle'` (string comparison with an object). The SDK's `EventSessionStatus.properties.status` is `{ type: "idle" | "busy" | "retry" }`, not a string. Must check `statusObj?.type === "idle"`.

If these checks are already present (they may have been added during UAT), verify the exact comparison pattern.

**Client-side (useStreaming.ts):**

Add client-side terminal event detection inside the SSE line parsing loop. After the `setState` call that accumulates events/parts (around line 174), add:

```typescript
// Detect terminal events client-side for robustness
// (server closes stream, but client should also stop if it sees these events)
if (
  eventType === "session.idle" ||
  eventType === "session.error" ||
  (eventType === "error" && data.error)
) {
  setState((prev) => ({
    ...prev,
    isStreaming: false,
    ...(data.error ? { error: String((data.properties as Record<string, unknown>)?.error ?? data.error) } : {}),
  }))
  // Invalidate messages to load final state from server
  queryClient.invalidateQueries({ queryKey: sessionKeys.messages(sessionId) })
  reader.cancel()
  return
}
```

This ensures the client stops streaming even if the SSE stream close event is delayed. The `reader.cancel()` call closes the fetch response body.

Note: The existing `data.error` check (around line 177) handles server-side error events (`sendEvent("error", { error: "..." })`). The new check handles SDK `session.error` events where the error is at `data.properties.error`.
  </action>
  <verify>
1. `grep -n "session.idle" app/routes/api/sessions.$id.prompt.ts` — should find break condition
2. `grep -n "session.idle" app/hooks/useStreaming.ts` — should find client-side detection
3. `grep -n "statusObj.*type.*idle" app/routes/api/sessions.$id.prompt.ts` — should find nested object check (NOT string comparison)
4. `npm run typecheck:app` — zero errors
  </verify>
  <done>
- Server-side: for-await loop breaks on session.idle, session.error, and session.status(idle) events
- Client-side: streaming state transitions to isStreaming=false on terminal events
- AI streaming completes naturally without manual abort
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — builds successfully
3. Start dev server, navigate to /settings, verify General tab loads without "no such table" error
4. In Settings > Appearance, toggle theme — color scheme should change immediately
5. In /chat, send a prompt — stream should terminate naturally, last message should render
</verification>

<success_criteria>
- Settings table exists and all CRUD operations work
- Theme toggle switches colors immediately using CSS custom property overrides
- AI streaming terminates on its own — no manual abort needed for the last message to appear
- Zero TypeScript errors, app builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-terminal/07-05-SUMMARY.md`
</output>
