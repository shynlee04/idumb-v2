---
phase: 07-chat-terminal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/chat/ChatMessage.tsx
  - app/components/chat/parts/CodeBlock.tsx
  - app/components/chat/parts/ToolCallAccordion.tsx
  - app/components/chat/parts/ReasoningCollapse.tsx
  - app/components/chat/parts/FilePartRenderer.tsx
  - app/styles/app.css
autonomous: true

must_haves:
  truths:
    - "User sees markdown code blocks with syntax highlighting, copy button on hover, line numbers in gutter, and language badge in top corner"
    - "User sees tool calls as collapsed accordions showing tool name + status badge, click to expand full input/output"
    - "User sees thinking/reasoning sections collapsed by default with 'Thinking...' label, click to expand reasoning text"
    - "User sees file attachments rendered with filename, mime type indicator, and image preview for image files"
    - "User sees balanced message density with small role indicators (not avatars) and clear message boundaries"
  artifacts:
    - path: "app/components/chat/parts/CodeBlock.tsx"
      provides: "Custom react-markdown code component with copy button, line numbers, language badge"
      min_lines: 60
    - path: "app/components/chat/parts/ToolCallAccordion.tsx"
      provides: "Collapsible accordion for ToolPart with state-aware display"
      min_lines: 50
    - path: "app/components/chat/parts/ReasoningCollapse.tsx"
      provides: "Collapsed-by-default reasoning section with duration display"
      min_lines: 30
    - path: "app/components/chat/parts/FilePartRenderer.tsx"
      provides: "File/image rendering for FilePart"
      min_lines: 30
    - path: "app/components/chat/ChatMessage.tsx"
      provides: "Rewritten message component using new part renderers"
      min_lines: 40
  key_links:
    - from: "app/components/chat/ChatMessage.tsx"
      to: "app/components/chat/parts/CodeBlock.tsx"
      via: "react-markdown components prop"
      pattern: "components.*code.*CodeBlock"
    - from: "app/components/chat/ChatMessage.tsx"
      to: "app/components/chat/parts/ToolCallAccordion.tsx"
      via: "PartRenderer switch case 'tool'"
      pattern: "case.*tool.*ToolCallAccordion"
    - from: "app/components/chat/parts/ToolCallAccordion.tsx"
      to: "engine-types.ts"
      via: "import type ToolPart"
      pattern: "import.*ToolPart.*engine-types"
---

<objective>
Upgrade chat message rendering with rich Part-specific components — syntax-highlighted code blocks with copy/line-numbers/language-badge, tool call accordions, collapsible reasoning, and file/image previews.

Purpose: Replace the basic Part renderers in ChatMessage.tsx with production-quality components that match the user's locked decisions for chat message rendering (CHAT-01).

Output: 5 component files (4 new part renderers + rewritten ChatMessage.tsx) + highlight.js CSS.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-terminal/07-RESEARCH.md
@.planning/phases/07-chat-terminal/07-CONTEXT.md
@app/components/chat/ChatMessage.tsx
@app/components/chat/ChatMessages.tsx
@app/shared/engine-types.ts
@app/server/sdk-validators.ts
@app/styles/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Part renderer components</name>
  <files>
    app/components/chat/parts/CodeBlock.tsx
    app/components/chat/parts/ToolCallAccordion.tsx
    app/components/chat/parts/ReasoningCollapse.tsx
    app/components/chat/parts/FilePartRenderer.tsx
  </files>
  <action>
Create 4 new part renderer components in `app/components/chat/parts/`:

**CodeBlock.tsx** (~80 LOC):
- Custom `code` component for react-markdown's `components` prop
- Detect inline vs block code (`className` starts with `language-` for blocks)
- For block code:
  - Extract language from `className` (e.g. `language-typescript` -> `typescript`)
  - Show **language badge** top-right corner (small pill, e.g. "TypeScript")
  - Show **line numbers** in a gutter column (use CSS grid: gutter | code)
  - Show **copy button** on hover (top-right, uses `navigator.clipboard.writeText`)
  - Use `rehype-highlight` for syntax highlighting (already installed) — highlight.js adds `hljs` classes
  - Wrap in `<pre>` with `overflow-x-auto` and rounded border
- For inline code: render as `<code>` with bg-muted padding
- Import `Copy`, `Check` from `lucide-react` for copy button icon states
- Use `useState` for copy feedback (show checkmark for 2s after copy)

**ToolCallAccordion.tsx** (~70 LOC):
- Props: `{ part: ToolPart }` — import `ToolPart` from `../../shared/engine-types`
- **Collapsed state** (default): Single row showing:
  - Tool name (`part.tool`) in monospace
  - Status badge: colored dot + text (`pending` yellow, `running` blue pulse, `completed` green, `error` red)
  - Title (`state.title`) if running/completed — truncated to one line
  - Duration if running/completed: compute from `state.time.start` (epoch ms) — show "2.1s" or "Running..."
  - Chevron icon (right for collapsed, down for expanded)
- **Expanded state** (click to toggle): Shows additional:
  - Input section: `JSON.stringify(state.input, null, 2)` in scrollable pre block (max-h-48)
  - Output section (completed only): `state.output` in scrollable pre block (max-h-48)
  - Error section (error only): `state.error` in red text
- Use Tailwind `group` for hover effects, `transition-all` for smooth expand
- Per user decision: "accordions, not heavy cards — minimal visual weight when collapsed"

**ReasoningCollapse.tsx** (~40 LOC):
- Props: `{ part: ReasoningPart }` — import from `../../shared/engine-types`
- **Collapsed by default** (user locked decision)
- Header: "Thinking..." label in muted text + chevron
- If `part.time` exists, show duration: `((part.time.end ?? Date.now()) - part.time.start) / 1000` formatted as "X.Xs"
- Expanded: reasoning text in italic muted foreground, whitespace-pre-wrap
- Use HTML `<details>` element for native collapse behavior (accessible, no JS state needed)

**FilePartRenderer.tsx** (~50 LOC):
- Props: `{ part: FilePart }` — import from `../../shared/engine-types`
- If `part.mime` starts with `image/`: render `<img>` with `part.url` as src, `max-w-md max-h-64 rounded-md`
- Otherwise: render file attachment card with:
  - File icon from lucide-react (`FileText` for text, `File` for generic)
  - Filename (`part.filename || 'Untitled'`)
  - Mime type in muted text
  - Link to `part.url` (download)
- Border + subtle background, rounded corners

All components: Use `cn()` from `@/lib/utils`, Tailwind classes only, no external CSS.
Import SDK types from `../../shared/engine-types` (NOT directly from `@opencode-ai/sdk`).
  </action>
  <verify>
`npm run typecheck:app` passes with zero errors. All 4 files exist and export their components.
  </verify>
  <done>
Four part renderer components exist in app/components/chat/parts/ — CodeBlock handles copy/line-numbers/language-badge, ToolCallAccordion renders collapsed accordion with status, ReasoningCollapse is collapsed-by-default with thinking label, FilePartRenderer shows images inline and other files as download cards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite ChatMessage.tsx and add highlight.js CSS</name>
  <files>
    app/components/chat/ChatMessage.tsx
    app/styles/app.css
  </files>
  <action>
**Rewrite ChatMessage.tsx** (~60 LOC):

1. Keep the existing `ChatMessageData` interface and `getTextContent` export unchanged (other files depend on them).

2. Update the `ChatMessage` component for **balanced density** per user decision:
   - Remove the large circular avatar badges (User/Bot icons in 7x7 circles)
   - Replace with **small role indicators**: tiny colored dot (4px) + role text ("You" / "AI") inline, no circle
   - Tighter vertical padding: `py-3` instead of `py-4`
   - Keep `border-b border-border` between messages

3. Update `MessageBody`:
   - When rendering markdown (both `content` string and TextPart), pass custom `components` to `ReactMarkdown`:
     ```tsx
     <ReactMarkdown
       remarkPlugins={[remarkGfm]}
       rehypePlugins={[rehypeHighlight]}
       components={{ code: CodeBlock }}
     >
     ```
   - Add `rehypeHighlight` to rehypePlugins array (import from `rehype-highlight`)
   - Pass `CodeBlock` as the `code` component

4. Update `PartRenderer` switch cases:
   - `case "text"`: Use ReactMarkdown with `remarkGfm` + `rehypeHighlight` + `components: { code: CodeBlock }`
   - `case "tool"`: Render `<ToolCallAccordion part={part} />` instead of inline ToolPartRenderer
   - `case "reasoning"`: Render `<ReasoningCollapse part={part} />` instead of inline `<details>`
   - `case "file"`: Render `<FilePartRenderer part={part} />` instead of inline filename text
   - Meta parts (step-start, step-finish, etc.): Keep returning `null` (these are handled by StepCluster in Plan 02)

5. Delete the old `ToolPartRenderer` and `ToolStatusBadge` functions (replaced by ToolCallAccordion).

**Update app.css**:
- Import a highlight.js dark theme that matches the app's color scheme
- Add: `@import "highlight.js/styles/github-dark.css";` at the top (after tailwindcss import)
- This provides syntax highlighting classes used by rehype-highlight

**Imports to add to ChatMessage.tsx:**
```tsx
import rehypeHighlight from "rehype-highlight"
import { CodeBlock } from "./parts/CodeBlock"
import { ToolCallAccordion } from "./parts/ToolCallAccordion"
import { ReasoningCollapse } from "./parts/ReasoningCollapse"
import { FilePartRenderer } from "./parts/FilePartRenderer"
```
  </action>
  <verify>
`npm run typecheck:app` passes. `npm run build:app` succeeds (highlight.js CSS resolves). Visually: code blocks should have syntax colors, tool calls should be clickable accordions, reasoning should be collapsed.
  </verify>
  <done>
ChatMessage.tsx uses the 4 new part renderers — code blocks have copy/line-numbers/language-badge via CodeBlock, tool calls render as ToolCallAccordion, reasoning uses ReasoningCollapse, files use FilePartRenderer. Message density is balanced with small role indicators. highlight.js dark theme CSS is loaded for syntax highlighting.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — succeeds (no missing CSS imports, no bundle errors)
3. Visual check: navigate to /chat, send a message with code — code blocks should show syntax highlighting, language badge, copy button, line numbers
4. Visual check: tool calls from AI should render as collapsed accordions, not inline cards
5. Visual check: reasoning sections should be collapsed by default with "Thinking..." label
</verification>

<success_criteria>
- All 5 component files exist and typecheck
- ChatMessage.tsx uses new part renderers (no inline ToolPartRenderer/ToolStatusBadge)
- Code blocks have: syntax highlighting, copy button, line numbers, language badge
- Tool calls are collapsed accordions with status indicators
- Reasoning sections are collapsed by default
- File parts show image preview or download card
- highlight.js CSS is loaded in app.css
- No regressions: existing chat flow still works (streaming + history)
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-terminal/07-01-SUMMARY.md`
</output>
