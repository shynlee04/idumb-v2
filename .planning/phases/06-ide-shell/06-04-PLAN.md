---
phase: 06-ide-shell
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ide/IDEShell.tsx
  - app/components/layout/SessionSidebar.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Panel sizes persist between page reloads — resizing sidebar to 30% and reloading restores 30%"
    - "Collapsed panels remain collapsed after reload — collapsing terminal and reloading keeps it collapsed"
    - "Cmd+B toggles sidebar collapse/expand"
    - "User can navigate to /ide from the chat sidebar"
  artifacts:
    - path: "app/components/ide/IDEShell.tsx"
      provides: "Layout persistence wiring and Cmd+B shortcut"
      contains: "panelSizes.sidebar"
    - path: "app/components/layout/SessionSidebar.tsx"
      provides: "IDE navigation link"
      contains: "/ide"
  key_links:
    - from: "app/components/ide/IDEShell.tsx"
      to: "app/stores/layout-store.ts"
      via: "useLayoutStore() → panelSizes feeds defaultSize, onResize syncs collapsed"
      pattern: "useLayoutStore.*panelSizes"
    - from: "app/components/layout/SessionSidebar.tsx"
      to: "app/routes/ide.tsx"
      via: "TanStack Router Link to /ide"
      pattern: "to.*\\/ide"
---

<objective>
Close 2 verification gaps from 06-VERIFICATION.md:
1. Panel sizes don't actually restore from localStorage on reload (defaultSize uses hardcoded constants)
2. No navigation link to reach /ide from the existing dashboard

Purpose: Complete Phase 6 must-haves — "layout persists" and "IDE accessible from nav"
Output: Fixed IDEShell.tsx with working persistence, SessionSidebar.tsx with IDE link
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ide-shell/06-01-SUMMARY.md
@.planning/phases/06-ide-shell/06-VERIFICATION.md
@app/stores/layout-store.ts
@app/shared/ide-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire layout persistence and collapse state into IDEShell</name>
  <files>app/components/ide/IDEShell.tsx</files>
  <action>
Fix the disconnect between Zustand's persisted state and the actual Panel `defaultSize` props.

**1. Keep hardcoded defaultSize — these are initial/fallback values only:**

Currently each Panel uses `defaultSize={IDE_PANELS.sidebar.defaultSize}` (hardcoded 20/50/30).
KEEP these as-is — `defaultSize` is an uncontrolled prop read only on first mount. Zustand's persist middleware rehydrates asynchronously, so the store values equal the hardcoded defaults on first render anyway. Actual size restoration happens imperatively in step 2.

```tsx
const { panelSizes, collapsed, setPanelSizes, togglePanel } = useLayoutStore()
```

**2. Restore persisted sizes AND collapse state after Zustand hydration:**

Use `useRef` + `useCallback` with the `ref` prop on Panel (NOT `usePanelRef` — use `useRef<ImperativePanelHandle>(null)` directly) to get imperative handles for sidebar, editor, and terminal panels. Subscribe to Zustand's persist hydration to restore sizes:

```tsx
import { type ImperativePanelHandle } from 'react-resizable-panels'

const sidebarRef = useRef<ImperativePanelHandle>(null)
const editorRef = useRef<ImperativePanelHandle>(null) 
const terminalRef = useRef<ImperativePanelHandle>(null)

useEffect(() => {
  // Wait for Zustand persist to rehydrate from localStorage
  const unsub = useLayoutStore.persist.onFinishHydration((state) => {
    // Restore sizes imperatively (defaultSize is uncontrolled, only read on first mount)
    sidebarRef.current?.resize(state.panelSizes.sidebar)
    editorRef.current?.resize(state.panelSizes.editor)
    terminalRef.current?.resize(state.panelSizes.terminal)
    
    // Restore collapsed state
    if (state.collapsed.includes('sidebar')) {
      sidebarRef.current?.collapse()
    }
    if (state.collapsed.includes('terminal')) {
      terminalRef.current?.collapse()
    }
  })
  
  // If already hydrated (e.g., hot reload), restore immediately
  if (useLayoutStore.persist.hasHydrated()) {
    const state = useLayoutStore.getState()
    sidebarRef.current?.resize(state.panelSizes.sidebar)
    editorRef.current?.resize(state.panelSizes.editor)
    terminalRef.current?.resize(state.panelSizes.terminal)
    if (state.collapsed.includes('sidebar')) {
      sidebarRef.current?.collapse()
    }
    if (state.collapsed.includes('terminal')) {
      terminalRef.current?.collapse()
    }
  }
  
  return unsub
}, [])
```

Pass `ref={sidebarRef}`, `ref={editorRef}`, `ref={terminalRef}` to the respective Panel components.

Pass `ref={sidebarRef}`, `ref={terminalRef}` to the respective Panel components.

**3. Sync collapse state changes to store:**

Add `onResize` callbacks to collapsible panels (sidebar, terminal) to detect collapse/expand and sync to Zustand:

```tsx
const handleSidebarResize = useCallback((size: PanelSize) => {
  const numSize = typeof size === 'object' ? size.sizePercentage : size
  const isNowCollapsed = numSize <= (IDE_PANELS.sidebar.collapsedSize ?? 0) + 0.1
  const wasCollapsed = collapsed.includes('sidebar')
  if (isNowCollapsed && !wasCollapsed) {
    togglePanel('sidebar')
  } else if (!isNowCollapsed && wasCollapsed) {
    togglePanel('sidebar')
  }
}, [collapsed, togglePanel])
```

Similarly for terminal. Apply via `onResize={handleSidebarResize}` on each Panel.

Note: PanelSize in react-resizable-panels v4 may be a number or object — check the actual type. If it's just a number (percentage), use it directly. The `onResize` callback signature is: `(panelSize: PanelSize, id: string | number | undefined, prevPanelSize: PanelSize | undefined) => void`.

**4. Add Cmd+B keyboard shortcut for sidebar toggle:**

```tsx
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
      e.preventDefault()
      const panel = sidebarRef.current
      if (panel) {
        if (panel.isCollapsed()) {
          panel.expand()
        } else {
          panel.collapse()
        }
      }
    }
  }
  document.addEventListener('keydown', handleKeyDown)
  return () => document.removeEventListener('keydown', handleKeyDown)
}, [])
```

**Important constraints:**
- Do NOT use `autoSaveId` on Group — we use Zustand persistence instead (autoSaveId would create a conflicting localStorage entry)
- Keep the existing `onLayoutChange` handlers that sync sizes to Zustand — they are correct and working
- The `defaultSize` prop is only read on initial mount — actual restoration uses imperative `resize()` after Zustand hydration
- Import `ImperativePanelHandle` type from `react-resizable-panels` for the refs
  </action>
  <verify>
1. `cd app && npx tsc --noEmit` — zero TypeScript errors
2. Start dev server: `npm run dashboard` — loads without console errors
3. Manual test: Resize sidebar to ~30%, reload page → sidebar restores at ~30%
4. Manual test: Collapse terminal via drag, reload → terminal stays collapsed
5. Manual test: Press Cmd+B → sidebar collapses; press again → expands
6. Check localStorage key `idumb-ide-layout` has updated sizes after resize
  </verify>
  <done>
Panel sizes restore from localStorage on reload. Collapsed panels stay collapsed after reload. Cmd+B toggles sidebar. onLayoutChange still syncs to Zustand on resize.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IDE navigation link to SessionSidebar</name>
  <files>app/components/layout/SessionSidebar.tsx</files>
  <action>
Add a navigation link to `/ide` in the SessionSidebar component. This is the primary navigation surface for the dashboard (visible on all `/chat/*` routes).

**Add a footer section** at the bottom of the sidebar (after the session list `<nav>`, before closing `</aside>`):

```tsx
{/* Navigation footer */}
<div className="p-2 border-t border-border">
  <Link
    to="/ide"
    className={cn(
      "flex items-center gap-2 rounded-md px-2 py-1.5 text-sm transition-colors",
      "text-muted-foreground hover:bg-accent/50 hover:text-accent-foreground"
    )}
  >
    <Code2 className="w-3.5 h-3.5 flex-shrink-0" />
    <span>IDE</span>
  </Link>
</div>
```

Import `Code2` from `lucide-react` (already a project dependency — add to the existing import line).

The Link component and `cn` utility are already imported. The `to="/ide"` prop uses TanStack Router's type-safe routing — no params needed since ide.tsx is a simple route.

**Do NOT:**
- Add complex navigation tabs or restructure the layout
- Add active state detection (IDE is a separate full-screen route, so the sidebar won't be visible on /ide)
- Add any icons or components not already in the project dependencies
  </action>
  <verify>
1. `cd app && npx tsc --noEmit` — zero TypeScript errors
2. Start dev server → navigate to `/chat/new` → see "IDE" link at bottom of sidebar
3. Click "IDE" link → navigates to `/ide` and shows the IDE shell
  </verify>
  <done>
SessionSidebar has a visible "IDE" link at the bottom that navigates to /ide when clicked.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd app && npx tsc --noEmit` passes
2. Layout persistence: Resize panels → reload → sizes restored
3. Collapse persistence: Collapse sidebar/terminal → reload → still collapsed
4. Keyboard shortcut: Cmd+B toggles sidebar
5. Navigation: Click "IDE" in chat sidebar → arrives at /ide
6. No regressions: Existing resize, drag, and Monaco editor still work
</verification>

<success_criteria>
- All 4 must-have truths verified manually
- TypeScript compilation clean
- No regressions in existing Phase 6 functionality (resize, editor, file tree)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ide-shell/06-04-SUMMARY.md`
</output>
