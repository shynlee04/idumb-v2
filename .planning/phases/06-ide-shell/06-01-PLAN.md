---
phase: 06-ide-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app/stores/ide-store.ts
  - app/shared/file-types.ts
  - app/server/files.ts
  - app/components/layout/IDELayout.tsx
  - app/routes/index.tsx
  - app/vite.config.ts
autonomous: true

must_haves:
  truths:
    - "User sees a three-panel IDE layout (sidebar, editor area, chat placeholder) when navigating to /"
    - "User can drag dividers between panels to resize them"
    - "User can collapse and expand sidebar and chat panels"
    - "Layout sizes persist across page refresh via localStorage"
    - "File server functions accept paths and return file/directory data with path traversal protection"
  artifacts:
    - path: "app/stores/ide-store.ts"
      provides: "Zustand IDE state store with 4 slices (tabs, tree, layout, editor)"
      min_lines: 80
    - path: "app/server/files.ts"
      provides: "File CRUD server functions with safePath security"
      exports: ["listDirectory", "readFile", "writeFile", "createFileOrFolder", "deleteFileOrFolder", "renameFileOrFolder"]
    - path: "app/components/layout/IDELayout.tsx"
      provides: "Three-panel resizable layout using react-resizable-panels v4"
      min_lines: 40
    - path: "app/shared/file-types.ts"
      provides: "Shared TypeScript types for file operations"
  key_links:
    - from: "app/routes/index.tsx"
      to: "app/components/layout/IDELayout.tsx"
      via: "import and render"
      pattern: "import.*IDELayout"
    - from: "app/stores/ide-store.ts"
      to: "localStorage"
      via: "zustand persist middleware with skipHydration"
      pattern: "persist.*skipHydration"
---

<objective>
Install Phase 6 dependencies, create the IDE foundation (Zustand store, file server functions, resizable panel layout), and wire the IDE layout as the root `/` route.

Purpose: Establish all shared infrastructure that the File Tree (06-02) and Monaco Editor (06-03) plans will import from.
Output: Working three-panel layout at `/`, file CRUD server functions, Zustand IDE store.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ide-shell/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create Zustand store and shared types, update Vite config</name>
  <files>package.json, app/stores/ide-store.ts, app/shared/file-types.ts, app/vite.config.ts</files>
  <action>
  1. Install Phase 6 dependencies:
     ```bash
     npm install react-resizable-panels@^4.6.2 @monaco-editor/react@^4.7.0 monaco-editor@^0.55.1 react-arborist@^3.4.3 radix-ui@^1.4.3 zustand@^5.0.11 immer@^10.1.1
     ```

  2. Create `app/shared/file-types.ts` with shared types:
     - `FileNode`: `{ id: string; name: string; isFolder: boolean; children?: FileNode[] | null }`
     - `Tab`: `{ path: string; name: string; isDirty: boolean }` — NO content field (content lives in Monaco models)
     - `ContextTarget`: `{ path: string; name: string; isFolder: boolean }`

  3. Create `app/stores/ide-store.ts` following research Example 3 but with these adjustments:
     - Import `create` from 'zustand', `persist` from 'zustand/middleware', `immer` from 'zustand/middleware/immer'
     - Import `Tab` from '../shared/file-types'
     - Tab type has NO `content` field — just `{ path, name, isDirty }`
     - 4 slices: tabSlice (openTabs, activeTabId, openFile, closeTab, setActiveTab, markDirty, markClean), layoutSlice (sidebarCollapsed, chatCollapsed, toggleSidebar, toggleChat), editorSlice (viewStates Map, saveViewState), treeSlice (expandedNodes Set, selectedNode, toggleNode, selectNode)
     - Use `persist` middleware with `skipHydration: true` (pitfall P6 — SSR hydration mismatch)
     - `partialize` to only persist: openTabs (without content, with isDirty reset to false), activeTabId, sidebarCollapsed, chatCollapsed
     - DO NOT persist viewStates or expandedNodes (transient)
     - `openFile` action: check if tab already exists by path; if not, push new Tab; set activeTabId to path
     - `closeTab` action: remove tab, update activeTabId to adjacent tab or null
     - Computed `activeTab` getter: `get() { return openTabs.find(t => t.path === activeTabId) }`
     - `contextTarget` state: `ContextTarget | null` with `setContextTarget` action (for context menu)

  4. Update `app/vite.config.ts`:
     - Add `manualChunks` to existing `rollupOptions` for Monaco code splitting:
       ```typescript
       rollupOptions: {
         external: ["@opencode-ai/sdk", /^node:/],
         output: {
           manualChunks: {
             'monaco-editor': ['monaco-editor'],
           },
         },
       },
       ```
     - Remove the dead `@shared` alias (points to deleted `../src/dashboard/shared`)
  </action>
  <verify>
  - `npm ls react-resizable-panels zustand monaco-editor @monaco-editor/react react-arborist radix-ui immer` — all installed
  - `cat app/stores/ide-store.ts` — has persist + immer + skipHydration + 4 slices + no content in Tab
  - `cat app/shared/file-types.ts` — FileNode, Tab, ContextTarget types exported
  - `cat app/vite.config.ts` — manualChunks for monaco-editor present, @shared alias removed
  </verify>
  <done>All Phase 6 dependencies installed. Zustand store created with 4 slices, persist + immer middleware, skipHydration: true. Shared file types defined. Vite config updated with Monaco chunk splitting. Dead @shared alias cleaned up.</done>
</task>

<task type="auto">
  <name>Task 2: Create file server functions with path traversal protection</name>
  <files>app/server/files.ts</files>
  <action>
  Create `app/server/files.ts` following research Example 5 with these specifics:

  1. Import `createServerFn` from '@tanstack/react-start', `z` from 'zod', `fs` from 'node:fs/promises', `path` from 'node:path'

  2. Implement `safePath(projectRoot, userPath)` function:
     - `decodeURIComponent` the user path
     - `path.resolve(projectRoot, decoded)`
     - Check `resolved.startsWith(projectRoot + path.sep) || resolved === projectRoot`
     - Throw `Error('Path traversal blocked')` if check fails

  3. Implement `getProjectRoot()`: return `process.env.IDUMB_PROJECT_ROOT ?? process.cwd()`

  4. Create 6 server functions using `.inputValidator()` (NOT `.validator()` — match existing codebase pattern):

     - `listDirectory` (GET): accepts `{ dirPath: string }`, returns `FileNode[]` sorted folders-first then alphabetical, filters out dotfiles by default, sets `children: null` for directories (lazy-load signal)
     - `readFile` (GET): accepts `{ filePath: string }`, rejects files >5MB, returns `{ content: string, size: number }`
     - `writeFile` (POST): accepts `{ filePath: string, content: string }`, returns `{ success: true }`
     - `createFileOrFolder` (POST): accepts `{ parentPath: string, name: string, type: 'file' | 'folder' }`, creates file (empty) or folder (recursive)
     - `deleteFileOrFolder` (POST): accepts `{ targetPath: string }`, uses `fs.rm({ recursive: true })`
     - `renameFileOrFolder` (POST): accepts `{ oldPath: string, newName: string }`, computes new path in same directory

  5. EVERY function MUST call `safePath()` before ANY fs operation — no exceptions.

  6. Wrap each handler in try/catch returning `{ error: string }` on failure (don't let raw Node.js errors leak to client).
  </action>
  <verify>
  - `cat app/server/files.ts` — has safePath function, 6 server functions, all using `.inputValidator()`
  - Grep for `safePath` — called in every server function handler
  - Grep for `.inputValidator(` — used for all validators (not `.validator()`)
  - No raw `fs.readFile`/`fs.writeFile` calls without `safePath` guard
  </verify>
  <done>File server functions created with path traversal protection. 6 operations: listDirectory, readFile, writeFile, createFileOrFolder, deleteFileOrFolder, renameFileOrFolder. All use safePath() and .inputValidator(). Error handling wraps all fs operations.</done>
</task>

<task type="auto">
  <name>Task 3: Create IDE panel layout and wire as root route</name>
  <files>app/components/layout/IDELayout.tsx, app/routes/index.tsx</files>
  <action>
  1. Create `app/components/layout/IDELayout.tsx` using react-resizable-panels **v4 API** (NOT v3):
     - Import `{ Group, Panel, Separator }` from 'react-resizable-panels' (NOT PanelGroup/PanelResizeHandle — those are deprecated v3 names, see pitfall P4)
     - Import `useIDEStore` from '../../stores/ide-store'
     - Import `useEffect` from 'react'

     Layout structure (horizontal Group):
     ```
     <Group orientation="horizontal" autoSaveId="ide-main">
       <Panel defaultSize={20} minSize={15} maxSize={35} collapsible>
         {/* Sidebar — placeholder div with "File Explorer" text, will be replaced by FileTree in 06-02 */}
       </Panel>
       <Separator className="w-1.5 bg-zinc-800 hover:bg-blue-500/50 transition-colors cursor-col-resize" />
       <Panel defaultSize={55} minSize={30}>
         {/* Editor area — placeholder div with "Open a file to start editing", will be replaced by TabBar + Monaco in 06-03 */}
       </Panel>
       <Separator className="w-1.5 bg-zinc-800 hover:bg-blue-500/50 transition-colors cursor-col-resize" />
       <Panel defaultSize={25} minSize={15} maxSize={40} collapsible>
         {/* Chat panel — placeholder div with "Chat — Phase 7" */}
       </Panel>
     </Group>
     ```

     - Use `autoSaveId="ide-main"` for built-in layout persistence to localStorage
     - Add `useEffect` for Zustand rehydration: `useIDEStore.persist.rehydrate()` on mount (pitfall P6)
     - Full height: wrapper div with `className="h-screen flex flex-col"`, Group with `className="flex-1"`
     - Each panel placeholder: centered text, `bg-zinc-950` background, `border-r border-zinc-800` for visual separation

  2. Rewrite `app/routes/index.tsx`:
     - Remove the `redirect` to `/chat/new`
     - Import and render `IDELayout` as the component:
       ```typescript
       import { createFileRoute } from "@tanstack/react-router"
       import { IDELayout } from "../components/layout/IDELayout"

       export const Route = createFileRoute("/")(
         component: IDELayout,
       })
       ```
  </action>
  <verify>
  - `npm run dev:app` — starts without errors
  - Navigate to `http://localhost:5180/` — shows three-panel layout (NOT redirect to /chat/new)
  - Drag dividers — panels resize
  - Double-click sidebar divider — sidebar collapses
  - Refresh page — layout sizes are remembered
  - `npm run build:app` — builds without errors (no SSR crash from Monaco — no Monaco imported yet)
  </verify>
  <done>IDE layout renders at root `/` with three resizable panels. Sidebar (20%), editor (55%), chat (25%) with collapsible sidebar and chat. Layout persists via autoSaveId. No more redirect to /chat/new.</done>
</task>

</tasks>

<verification>
- `npm run dev:app` starts, navigating to `/` shows three-panel IDE layout
- `npm run build:app` succeeds (no SSR issues — Monaco not yet imported)
- Panel resizing works with drag dividers
- Layout persistence works across refresh
- `app/server/files.ts` has safePath protection on all 6 operations
- Zustand store has skipHydration and persist middleware
</verification>

<success_criteria>
1. Three-panel IDE layout renders at `/` with resizable dividers
2. File CRUD server functions exist with path traversal protection
3. Zustand IDE store created with 4 slices and persistence
4. Vite config updated with Monaco chunk splitting
5. No regressions — existing routes (/chat, /settings, /tasks) still work
</success_criteria>

<output>
After completion, create `.planning/phases/06-ide-shell/06-01-SUMMARY.md`
</output>
