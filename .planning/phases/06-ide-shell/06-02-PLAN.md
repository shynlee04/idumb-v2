---
phase: 06-ide-shell
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/shared/ide-types.ts
  - app/stores/ide-store.ts
  - app/server/files.ts
  - app/hooks/useFiles.ts
  - app/components/file-tree/FileTreeNode.tsx
  - app/components/file-tree/FileTree.tsx
  - app/components/file-tree/FileTreeContextMenu.tsx
  - app/components/ide/IDEShell.tsx
autonomous: true

must_haves:
  truths:
    - "User can see project files and folders in the sidebar panel"
    - "User can expand/collapse folders to navigate the hierarchy"
    - "User can click a file to open it as a tab in the editor area"
    - "User can right-click a file or folder to get a context menu with New File, New Folder, Rename, Delete"
    - "User can create new files/folders, rename, and delete via context menu actions"
    - "File tree re-renders after mutations (create, rename, delete) without manual refresh"
  artifacts:
    - path: "app/stores/ide-store.ts"
      provides: "Zustand store for file/tab management (openFile, closeTab, markDirty, markClean, saveViewState, contextTarget)"
      exports: ["useIDEStore"]
    - path: "app/server/files.ts"
      provides: "TanStack Start server functions for file CRUD operations"
      exports: ["listDirectory", "readFile", "writeFile", "createFileOrFolder", "deleteFileOrFolder", "renameFileOrFolder"]
    - path: "app/hooks/useFiles.ts"
      provides: "React Query hooks wrapping file server functions"
      exports: ["fileKeys", "useDirectoryListing", "useFileContent", "useCreateFile", "useDeleteFile", "useRenameFile"]
    - path: "app/components/file-tree/FileTree.tsx"
      provides: "File tree component using react-arborist with lazy-load children"
      min_lines: 40
    - path: "app/components/file-tree/FileTreeNode.tsx"
      provides: "Tree node renderer with folder/file icons and click handlers"
      min_lines: 25
    - path: "app/components/file-tree/FileTreeContextMenu.tsx"
      provides: "Single shared Radix context menu with CRUD actions"
      min_lines: 50
  key_links:
    - from: "app/hooks/useFiles.ts"
      to: "app/server/files.ts"
      via: "imports server functions (listDirectory, readFile, etc.)"
      pattern: "import.*from.*server/files"
    - from: "app/components/file-tree/FileTree.tsx"
      to: "app/hooks/useFiles.ts"
      via: "useDirectoryListing for tree data"
      pattern: "useDirectoryListing"
    - from: "app/components/file-tree/FileTreeNode.tsx"
      to: "app/stores/ide-store.ts"
      via: "openFile action on file click"
      pattern: "useIDEStore.*openFile"
    - from: "app/components/ide/IDEShell.tsx"
      to: "app/components/file-tree/FileTree.tsx"
      via: "renders FileTree in sidebar panel (replacing SidebarPlaceholder)"
      pattern: "import.*FileTree"
---

<objective>
Build the file tree explorer with supporting infrastructure (file types, server functions, IDE store) and wire it into the IDE sidebar panel.

Purpose: Enable users to browse, navigate, and manage project files visually — the primary entry point for opening files in the editor (06-03). Also creates the file/tab management store and file server functions that 06-01 deferred.
Output: Working file tree in the sidebar panel with expand/collapse, file/folder icons, click-to-open, and right-click context menu (New File, New Folder, Rename, Delete). IDE store with tab management. File CRUD server functions.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ide-shell/06-RESEARCH.md
@.planning/phases/06-ide-shell/06-01-SUMMARY.md

These files from 06-01 ALREADY EXIST (actual paths from 06-01 execution):
- app/stores/layout-store.ts (Zustand store for PANEL LAYOUT only — panelSizes, collapsed, activePanel)
- app/components/ide/IDEShell.tsx (three-panel layout with SidebarPlaceholder, EditorPlaceholder, TerminalPlaceholder)
- app/shared/ide-types.ts (PanelId, PanelConfig, IDELayout types — NO file/tab types yet)
- app/routes/ide.tsx (IDE route at /ide)

This plan CREATES (infrastructure deferred from 06-01):
- app/stores/ide-store.ts — NEW file/tab Zustand store (separate from layout-store.ts)
- app/server/files.ts — NEW file CRUD server functions
- FileNode, Tab, ContextTarget types added to app/shared/ide-types.ts

IMPORTANT: Do NOT run `npm run build` or `npm test` after individual tasks. Only verify via file existence checks, grep, and typecheck at end.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file types, file server functions, IDE store, and React Query hooks</name>
  <files>app/shared/ide-types.ts, app/server/files.ts, app/stores/ide-store.ts, app/hooks/useFiles.ts</files>
  <action>
  1. Add file/tab types to `app/shared/ide-types.ts` (append after existing Phase 6 panel types):

     ```typescript
     // Phase 6 additions — File tree + tab types

     /** A node in the file tree (file or directory) */
     export interface FileNode {
       /** Unique ID — the full relative path (e.g., "src/lib/utils.ts") */
       id: string
       /** Display name (e.g., "utils.ts") */
       name: string
       /** True if directory */
       isFolder: boolean
       /** Children — null means not loaded yet (lazy), [] means empty dir */
       children?: FileNode[] | null
     }

     /** An open file tab in the editor */
     export interface Tab {
       /** File path (unique key) */
       path: string
       /** Display name */
       name: string
       /** Has unsaved changes */
       isDirty: boolean
     }

     /** Context menu target info */
     export interface ContextTarget {
       path: string
       name: string
       isFolder: boolean
     }
     ```

  2. Create `app/server/files.ts` — TanStack Start server functions for file operations:

     Follow the EXACT pattern from `app/server/sessions.ts` (createServerFn + .validator()):
     ```typescript
     import { createServerFn } from "@tanstack/react-start/server"
     import fs from "node:fs/promises"
     import path from "node:path"
     ```

     Path traversal protection — helper function:
     ```typescript
     function safePath(userPath: string): string {
       const resolved = path.resolve(process.cwd(), userPath)
       if (!resolved.startsWith(process.cwd())) {
         throw new Error("Path traversal detected")
       }
       return resolved
     }
     ```

     6 server functions:
     - `listDirectory` — input: `{ dirPath: string }`, reads dir with `fs.readdir(safePath(dirPath), { withFileTypes: true })`, returns `FileNode[]` sorted (folders first, then files, alphabetical within each). Each entry: `{ id: path.join(dirPath, entry.name), name: entry.name, isFolder: entry.isDirectory(), children: entry.isDirectory() ? null : undefined }`
     - `readFile` — input: `{ filePath: string }`, reads with `fs.readFile(safePath(filePath), 'utf-8')`, returns `{ content: string, size: number }`
     - `writeFile` — input: `{ filePath: string, content: string }`, writes with `fs.writeFile(safePath(filePath), content, 'utf-8')`, returns `{ success: true }`
     - `createFileOrFolder` — input: `{ parentPath: string, name: string, type: 'file' | 'folder' }`, creates file (empty string) or folder (`fs.mkdir` recursive), returns `{ path: string }`
     - `deleteFileOrFolder` — input: `{ targetPath: string }`, removes with `fs.rm(safePath(targetPath), { recursive: true })`, returns `{ success: true }`
     - `renameFileOrFolder` — input: `{ oldPath: string, newName: string }`, renames with `fs.rename`, returns `{ newPath: string }`

     Use `.validator()` with inline zod-free validation (or simple runtime checks) matching the pattern in `app/server/validators.ts` if it exists.

     NOTE: Check `app/server/sessions.ts` for the exact createServerFn pattern used in this project — follow it precisely (method chaining: `createServerFn({ method: 'GET' }).validator(...).handler(...)` or whichever pattern is used).

  3. Create `app/stores/ide-store.ts` — Zustand store for file/tab management:

     This is SEPARATE from `layout-store.ts` (which handles panel sizes). This store manages file operations and editor tabs.

     ```typescript
     import { create } from 'zustand'
     import { immer } from 'zustand/middleware/immer'
     import type { Tab, ContextTarget } from '@/shared/ide-types'
     ```

     State interface:
     ```typescript
     interface IDEState {
       // Tab management
       openTabs: Tab[]
       activeTabId: string | null
       
       // View state cache (Monaco cursor/scroll positions)
       viewStates: Map<string, unknown>
       
       // Context menu target
       contextTarget: ContextTarget | null

       // Actions
       openFile: (path: string, name: string) => void
       closeTab: (path: string) => void
       setActiveTab: (path: string) => void
       markDirty: (uriString: string) => void
       markClean: (uriString: string) => void
       saveViewState: (uriString: string, state: unknown) => void
       setContextTarget: (target: ContextTarget | null) => void
     }
     ```

     Implementation details:
     - `openFile(path, name)`: If tab exists → just setActiveTab. Otherwise push new `{ path, name, isDirty: false }` to openTabs and set activeTabId.
     - `closeTab(path)`: Remove from openTabs. If it was active, activate the previous tab (or next, or null).
     - `setActiveTab(path)`: Set activeTabId.
     - `markDirty(uriString)`: Extract path from URI (strip 'file://'), find tab, set isDirty=true.
     - `markClean(uriString)`: Same but isDirty=false.
     - `saveViewState(uriString, state)`: Store in viewStates Map.
     - `setContextTarget(target)`: Set contextTarget.

     Do NOT persist this store — tab state is ephemeral per session.

  4. Create `app/hooks/useFiles.ts` following the EXACT pattern from `app/hooks/useSession.ts` (query key factory + hooks + mutations):

     ```typescript
     import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query"
     import { listDirectory, readFile, createFileOrFolder, deleteFileOrFolder, renameFileOrFolder } from "../server/files"
     ```

     Query key factory:
     ```typescript
     export const fileKeys = {
       all: ["files"] as const,
       directory: (dirPath: string) => [...fileKeys.all, "dir", dirPath] as const,
       content: (filePath: string) => [...fileKeys.all, "content", filePath] as const,
     }
     ```

     Hooks:
     - `useDirectoryListing(dirPath: string)` — calls `listDirectory({ data: { dirPath } })`, returns `FileNode[]`
     - `useFileContent(filePath: string | null)` — calls `readFile({ data: { filePath: filePath! } })`, `enabled: Boolean(filePath)`, returns `{ content, size }`
     - `useCreateFile()` — mutation calling `createFileOrFolder`, `onSuccess` invalidates `fileKeys.directory(parentPath)`
     - `useDeleteFile()` — mutation calling `deleteFileOrFolder`, `onSuccess` invalidates `fileKeys.all` (broad invalidation since parent unknown)
     - `useRenameFile()` — mutation calling `renameFileOrFolder`, `onSuccess` invalidates `fileKeys.all`

     NOTE: Check how `useSession.ts` calls server functions — match the exact calling convention (it may be direct function calls or `.fetch()` pattern).
  </action>
  <verify>
  - `cat app/shared/ide-types.ts` — has FileNode, Tab, ContextTarget interfaces
  - `cat app/server/files.ts` — has 6 server functions with safePath protection
  - `cat app/stores/ide-store.ts` — has useIDEStore with openFile, closeTab, markDirty, markClean
  - `cat app/hooks/useFiles.ts` — has fileKeys factory, 5 hooks
  - `grep -r "import.*from.*server/files" app/hooks/` — useFiles.ts imports server functions
  - `npx tsc --noEmit 2>&1 | head -20` — quick typecheck, fix any errors
  </verify>
  <done>File/tab types added to ide-types.ts. 6 file CRUD server functions with path traversal protection. IDE store with tab management (open, close, dirty tracking, view state caching, context target). React Query hooks for all file operations. All follow existing codebase patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create FileTree components, context menu, and wire into IDEShell sidebar</name>
  <files>app/components/file-tree/FileTreeNode.tsx, app/components/file-tree/FileTree.tsx, app/components/file-tree/FileTreeContextMenu.tsx, app/components/ide/IDEShell.tsx</files>
  <action>
  1. Create `app/components/file-tree/FileTreeNode.tsx` — individual tree node renderer for react-arborist:

     - Import `NodeRendererProps` from `react-arborist`
     - Import `FileIcon, FolderIcon, FolderOpen, ChevronRight, ChevronDown` from `lucide-react`
     - Import `useIDEStore` from `../../stores/ide-store`
     - Import `FileNode` from `../../shared/ide-types`
     - Import `readFile` from `../../server/files`

     Component renders:
     - Folder icon: `ChevronRight`/`ChevronDown` toggle when clicked (calls `node.toggle()`)
     - File icon: `FileIcon` from lucide
     - `node.data.name` text, truncated with `truncate` class
     - Selected state: `bg-zinc-700/50` background
     - Hover state: `hover:bg-zinc-800` background
     - Indent via react-arborist's built-in `style` prop

     Click behavior:
     - **Folder click** → `node.toggle()` to expand/collapse
     - **File click** → call `useIDEStore.getState().openFile(node.data.id, node.data.name)` to register the tab

     Right-click behavior:
     - `onContextMenu` → call `useIDEStore.getState().setContextTarget({ path: node.data.id, name: node.data.name, isFolder: node.data.isFolder })` to set context target in store

  2. Create `app/components/file-tree/FileTree.tsx` — tree wrapper with react-arborist:

     - Import `Tree` from `react-arborist`
     - Import `useDirectoryListing` from `../../hooks/useFiles`
     - Import `FileTreeNode` from `./FileTreeNode`
     - Import `FileNode` from `../../shared/ide-types`

     Component:
     ```typescript
     export function FileTree({ rootPath }: { rootPath: string }) {
       const { data, isLoading, error } = useDirectoryListing(rootPath);
       
       if (isLoading) return <div className="p-3 text-xs text-muted-foreground">Loading files...</div>;
       if (error) return <div className="p-3 text-xs text-red-400">Error loading files</div>;
       if (!data?.length) return <div className="p-3 text-xs text-muted-foreground">No files found</div>;
       
       return (
         <Tree<FileNode>
           data={data}
           width="100%"
           indent={16}
           rowHeight={28}
           overscanCount={5}
           openByDefault={false}
         >
           {FileTreeNode}
         </Tree>
       );
     }
     ```

     Note: `rootPath` defaults to `"."` (project root). Directories with `children: null` trigger lazy-load when expanded.

  3. Create `app/components/file-tree/FileTreeContextMenu.tsx` — single shared Radix ContextMenu:

     - Import from `radix-ui` (unified package, NOT `@radix-ui/react-context-menu`)
     - Import `FilePlus, FolderPlus, Pencil, Trash2` from `lucide-react`
     - Import `useIDEStore` from `../../stores/ide-store`
     - Import `useCreateFile, useDeleteFile, useRenameFile` from `../../hooks/useFiles`

     Architecture (from research — single shared root):
     ```typescript
     export function FileTreeContextMenu({ children }: { children: ReactNode }) {
       const contextTarget = useIDEStore(s => s.contextTarget);
       const createFile = useCreateFile();
       const deleteFile = useDeleteFile();
       const renameFile = useRenameFile();
     ```

     The `ContextMenu.Trigger` wraps the entire FileTree. Target node determined by `contextTarget` in Zustand store.

     Menu items:
     - **New File**: calls `createFile.mutate({ parentPath, name, type: 'file' })` — use `window.prompt()` for name
     - **New Folder**: calls `createFile.mutate({ parentPath, name, type: 'folder' })` — use `window.prompt()` for name
     - **Separator**
     - **Rename**: calls `renameFile.mutate({ oldPath, newName })` — use `window.prompt()` pre-filled with current name
     - **Delete** (red text + Trash2 icon): calls `deleteFile.mutate({ targetPath })` — use `window.confirm()` for safety

     Styling:
     - `ContextMenu.Content`: `min-w-48 rounded-md bg-zinc-900 border border-zinc-700 p-1 shadow-lg z-50`
     - `ContextMenu.Item`: `flex items-center gap-2 px-2 py-1.5 text-sm rounded cursor-pointer hover:bg-zinc-800 outline-none`
     - Delete item: add `text-red-400`
     - `ContextMenu.Separator`: `h-px bg-zinc-700 my-1`

  4. Modify `app/components/ide/IDEShell.tsx` — replace SidebarPlaceholder with FileTree:

     - Import `FileTree` from `../file-tree/FileTree`
     - Import `FileTreeContextMenu` from `../file-tree/FileTreeContextMenu`

     Replace the `SidebarPlaceholder` component AND its usage in the sidebar Panel with:
     ```tsx
     <div className="flex h-full flex-col bg-sidebar text-sidebar-foreground">
       <div className="flex h-10 items-center border-b border-border px-3">
         <span className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
           Explorer
         </span>
       </div>
       <div className="flex-1 overflow-auto">
         <FileTreeContextMenu>
           <FileTree rootPath="." />
         </FileTreeContextMenu>
       </div>
     </div>
     ```

     Keep EditorPlaceholder and TerminalPlaceholder unchanged — those are replaced in 06-03 and Phase 7 respectively.
  </action>
  <verify>
  - `cat app/components/file-tree/FileTree.tsx` — uses react-arborist Tree with FileNode generic
  - `cat app/components/file-tree/FileTreeNode.tsx` — renders folder/file icons, handles click + right-click
  - `cat app/components/file-tree/FileTreeContextMenu.tsx` — has ContextMenu.Root wrapping children, 4 menu items
  - `grep -r "FileTree" app/components/ide/IDEShell.tsx` — IDEShell imports and renders FileTree
  - `grep -r "SidebarPlaceholder" app/components/ide/IDEShell.tsx` — should NOT appear (replaced)
  - `npx tsc --noEmit 2>&1 | head -20` — quick typecheck, fix any errors
  </verify>
  <done>File tree renders in sidebar with expand/collapse, file/folder icons, click-to-open-tab, right-click context menu with New File, New Folder, Rename, Delete. All mutations invalidate React Query cache. SidebarPlaceholder replaced in IDEShell.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero type errors
- Navigate to `/ide` — sidebar shows project file tree (not placeholder text)
- Expand/collapse folders — directory contents load
- Click a file — Zustand store registers a new tab
- Right-click → context menu appears with New File, New Folder, Rename, Delete
- No regressions — editor and terminal placeholders still render in their panels
</verification>

<success_criteria>
1. File tree renders in sidebar with expand/collapse, file/folder icons
2. Click-to-open registers a tab in Zustand store (editor wiring in 06-03)
3. Right-click context menu with New File, New Folder, Rename, Delete
4. All mutations invalidate React Query cache → tree re-renders
5. No regressions — editor and terminal placeholders still render in their panels
6. IDE store provides tab management API for 06-03
7. File server functions provide CRUD for all file operations
</success_criteria>

<output>
After completion, create `.planning/phases/06-ide-shell/06-02-SUMMARY.md`
</output>
