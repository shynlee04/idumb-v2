---
phase: 06-ide-shell
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/hooks/useFiles.ts
  - app/components/file-tree/FileTreeNode.tsx
  - app/components/file-tree/FileTree.tsx
  - app/components/file-tree/FileTreeContextMenu.tsx
  - app/components/layout/IDELayout.tsx
autonomous: true

must_haves:
  truths:
    - "User can see project files and folders in the sidebar panel"
    - "User can expand/collapse folders to navigate the hierarchy"
    - "User can click a file to open it as a tab in the editor area"
    - "User can right-click a file or folder to get a context menu with New File, New Folder, Rename, Delete"
    - "User can create new files/folders, rename, and delete via context menu actions"
    - "File tree re-renders after mutations (create, rename, delete) without manual refresh"
  artifacts:
    - path: "app/hooks/useFiles.ts"
      provides: "React Query hooks wrapping file server functions"
      exports: ["fileKeys", "useDirectoryListing", "useFileContent", "useCreateFile", "useDeleteFile", "useRenameFile"]
    - path: "app/components/file-tree/FileTree.tsx"
      provides: "File tree component using react-arborist with lazy-load children"
      min_lines: 40
    - path: "app/components/file-tree/FileTreeNode.tsx"
      provides: "Tree node renderer with folder/file icons and click handlers"
      min_lines: 25
    - path: "app/components/file-tree/FileTreeContextMenu.tsx"
      provides: "Single shared Radix context menu with CRUD actions"
      min_lines: 50
  key_links:
    - from: "app/hooks/useFiles.ts"
      to: "app/server/files.ts"
      via: "imports server functions (listDirectory, readFile, etc.)"
      pattern: "import.*from.*server/files"
    - from: "app/components/file-tree/FileTree.tsx"
      to: "app/hooks/useFiles.ts"
      via: "useDirectoryListing for tree data"
      pattern: "useDirectoryListing"
    - from: "app/components/file-tree/FileTreeNode.tsx"
      to: "app/stores/ide-store.ts"
      via: "openFile action on file click"
      pattern: "useIDEStore.*openFile"
    - from: "app/components/layout/IDELayout.tsx"
      to: "app/components/file-tree/FileTree.tsx"
      via: "renders FileTree in sidebar panel"
      pattern: "import.*FileTree"
---

<objective>
Build the file tree explorer with context menu and wire it into the IDE sidebar panel.

Purpose: Enable users to browse, navigate, and manage project files visually — the primary entry point for opening files in the editor (06-03).
Output: Working file tree in the sidebar panel with expand/collapse, file/folder icons, click-to-open, and right-click context menu (New File, New Folder, Rename, Delete).
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ide-shell/06-RESEARCH.md
@.planning/phases/06-ide-shell/06-01-PLAN.md

These files from 06-01 MUST exist before this plan runs:
- app/stores/ide-store.ts (Zustand store with openFile, selectNode, toggleNode, contextTarget, setContextTarget)
- app/server/files.ts (listDirectory, readFile, createFileOrFolder, deleteFileOrFolder, renameFileOrFolder)
- app/shared/file-types.ts (FileNode, Tab, ContextTarget types)
- app/components/layout/IDELayout.tsx (three-panel layout with sidebar placeholder)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create React Query file hooks and FileTree + FileTreeNode components</name>
  <files>app/hooks/useFiles.ts, app/components/file-tree/FileTree.tsx, app/components/file-tree/FileTreeNode.tsx</files>
  <action>
  1. Create `app/hooks/useFiles.ts` following the EXACT pattern from `app/hooks/useSession.ts` (query key factory + hooks + mutations):

     ```typescript
     import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query"
     import { listDirectory, readFile, createFileOrFolder, deleteFileOrFolder, renameFileOrFolder } from "../server/files"
     ```

     Query key factory:
     ```typescript
     export const fileKeys = {
       all: ["files"] as const,
       directory: (dirPath: string) => [...fileKeys.all, "dir", dirPath] as const,
       content: (filePath: string) => [...fileKeys.all, "content", filePath] as const,
     }
     ```

     Hooks:
     - `useDirectoryListing(dirPath: string)` — calls `listDirectory({ data: { dirPath } })`, returns `FileNode[]`
     - `useFileContent(filePath: string | null)` — calls `readFile({ data: { filePath: filePath! } })`, `enabled: Boolean(filePath)`, returns `{ content, size }`
     - `useCreateFile()` — mutation calling `createFileOrFolder`, `onSuccess` invalidates `fileKeys.directory(parentPath)`
     - `useDeleteFile()` — mutation calling `deleteFileOrFolder`, `onSuccess` invalidates `fileKeys.all` (broad invalidation since parent unknown)
     - `useRenameFile()` — mutation calling `renameFileOrFolder`, `onSuccess` invalidates `fileKeys.all`

  2. Create `app/components/file-tree/FileTreeNode.tsx` — individual tree node renderer for react-arborist:

     - Import `NodeRendererProps` from `react-arborist`
     - Import `FileIcon, FolderIcon, FolderOpen, ChevronRight, ChevronDown` from `lucide-react`
     - Import `useIDEStore` from `../../stores/ide-store`
     - Import `FileNode` from `../../shared/file-types`
     - Import `readFile` from `../../server/files`

     Component renders:
     - Folder icon: `ChevronRight`/`ChevronDown` toggle when clicked (calls `node.toggle()`)
     - File icon: `FileIcon` from lucide
     - `node.data.name` text, truncated with `truncate` class
     - Selected state: `bg-zinc-700/50` background
     - Hover state: `hover:bg-zinc-800` background
     - Indent via react-arborist's built-in `style` prop

     Click behavior:
     - **Folder click** → `node.toggle()` to expand/collapse (react-arborist handles child loading)
     - **File click** → call `readFile({ data: { filePath: node.data.id } })` to fetch content, then `useIDEStore.getState().openFile(node.data.id, node.data.name)` to register the tab. Content is NOT stored in Zustand — it will be used by MonacoEditor in 06-03 to create a Monaco model.

     Right-click behavior:
     - `onContextMenu` → call `useIDEStore.getState().setContextTarget({ path: node.data.id, name: node.data.name, isFolder: node.data.isFolder })` to set context target in store

  3. Create `app/components/file-tree/FileTree.tsx` — tree wrapper with react-arborist:

     - Import `Tree` from `react-arborist`
     - Import `useDirectoryListing` from `../../hooks/useFiles`
     - Import `FileTreeNode` from `./FileTreeNode`
     - Import `FileNode` from `../../shared/file-types`

     Component:
     ```typescript
     export function FileTree({ rootPath }: { rootPath: string }) {
       const { data, isLoading, error } = useDirectoryListing(rootPath);
       
       if (isLoading) return <div className="p-3 text-zinc-500 text-sm">Loading files...</div>;
       if (error) return <div className="p-3 text-red-400 text-sm">Error loading files</div>;
       if (!data?.length) return <div className="p-3 text-zinc-500 text-sm">No files found</div>;
       
       return (
         <Tree<FileNode>
           data={data}
           width="100%"
           indent={16}
           rowHeight={28}
           overscanCount={5}
           openByDefault={false}
         >
           {FileTreeNode}
         </Tree>
       );
     }
     ```

     Note: `rootPath` defaults to `"."` (project root). The `Tree` component from react-arborist expects `data` as the top-level array of `FileNode`. Directories with `children: null` trigger lazy-load when expanded — react-arborist calls the tree's `childLoader` callback.

     For lazy-loading, use react-arborist's `childrenAccessor` pattern: when `children` is `null`, pass an `onToggle` handler that fetches children via `listDirectory` and updates the tree data. Alternatively, use the simpler approach: pass `initialData` and let the tree manage open state internally.
  </action>
  <verify>
  - `cat app/hooks/useFiles.ts` — has fileKeys factory, 5 hooks matching useSession.ts pattern
  - `cat app/components/file-tree/FileTree.tsx` — uses react-arborist Tree with FileNode generic
  - `cat app/components/file-tree/FileTreeNode.tsx` — renders folder/file icons, handles click + right-click
  - `grep -r "import.*from.*server/files" app/hooks/` — useFiles.ts imports server functions
  - `grep -r "useIDEStore" app/components/file-tree/` — FileTreeNode uses store for openFile + setContextTarget
  </verify>
  <done>React Query hooks for all 6 file operations created. FileTree component renders project structure with react-arborist. FileTreeNode handles click-to-open-file and right-click context target. All follow existing codebase patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create context menu and wire FileTree into IDELayout sidebar</name>
  <files>app/components/file-tree/FileTreeContextMenu.tsx, app/components/layout/IDELayout.tsx</files>
  <action>
  1. Create `app/components/file-tree/FileTreeContextMenu.tsx` — single shared Radix ContextMenu:

     - Import `ContextMenu` from `radix-ui` (unified package, NOT `@radix-ui/react-context-menu`)
     - Import `FilePlus, FolderPlus, Pencil, Trash2` from `lucide-react`
     - Import `useIDEStore` from `../../stores/ide-store`
     - Import `useCreateFile, useDeleteFile, useRenameFile` from `../../hooks/useFiles`
     - Import `useState, type ReactNode` from `react`

     Architecture (from research pattern 5 — single shared root):
     ```typescript
     export function FileTreeContextMenu({ children }: { children: ReactNode }) {
       const contextTarget = useIDEStore(s => s.contextTarget);
       const createFile = useCreateFile();
       const deleteFile = useDeleteFile();
       const renameFile = useRenameFile();
       const [renaming, setRenaming] = useState(false);
       // ... state for new file/folder name input
     ```

     The `ContextMenu.Trigger` wraps the entire FileTree. The target node is determined by `contextTarget` in Zustand store (set by FileTreeNode's `onContextMenu`).

     Menu items (conditionally shown based on `contextTarget?.isFolder`):
     - **New File** (always shown, uses target folder or parent of target file): calls `createFile.mutate({ parentPath, name, type: 'file' })`
     - **New Folder** (always shown): calls `createFile.mutate({ parentPath, name, type: 'folder' })`
     - **Separator**
     - **Rename** (always shown): calls `renameFile.mutate({ oldPath, newName })`
     - **Delete** (always shown, red text + Trash2 icon): calls `deleteFile.mutate({ targetPath })` — use `window.confirm()` for MVP safety check

     Styling (from research Example 6):
     - `ContextMenu.Content`: `min-w-48 rounded-md bg-zinc-900 border border-zinc-700 p-1 shadow-lg z-50`
     - `ContextMenu.Item`: `flex items-center gap-2 px-2 py-1.5 text-sm rounded cursor-pointer hover:bg-zinc-800 outline-none`
     - Delete item: add `text-red-400`
     - `ContextMenu.Separator`: `h-px bg-zinc-700 my-1`

     For "New File" and "New Folder" actions, use `window.prompt()` for MVP to get the name. This avoids inline input complexity — we can upgrade to inline rename later.

     For "Rename", also use `window.prompt()` pre-filled with current name.

  2. Modify `app/components/layout/IDELayout.tsx` — replace sidebar placeholder with FileTree:

     - Import `FileTree` from `../file-tree/FileTree`
     - Import `FileTreeContextMenu` from `../file-tree/FileTreeContextMenu`

     Replace the sidebar placeholder `<div>` (currently showing "File Explorer" text) with:
     ```tsx
     <div className="h-full flex flex-col bg-zinc-950">
       <div className="px-3 py-2 text-xs font-semibold text-zinc-400 uppercase tracking-wider border-b border-zinc-800">
         Explorer
       </div>
       <div className="flex-1 overflow-auto">
         <FileTreeContextMenu>
           <FileTree rootPath="." />
         </FileTreeContextMenu>
       </div>
     </div>
     ```

     The `FileTreeContextMenu` wraps `FileTree` so right-click anywhere in the tree triggers the shared context menu. The `rootPath="."` starts from the project root.

     Keep the editor and chat placeholder `<div>`s unchanged — those are replaced in 06-03 and Phase 7 respectively.
  </action>
  <verify>
  - `cat app/components/file-tree/FileTreeContextMenu.tsx` — has ContextMenu.Root wrapping children, 4 menu items
  - `grep -r "import.*ContextMenu.*from.*radix-ui" app/components/` — uses unified radix-ui package
  - `grep -r "FileTree" app/components/layout/IDELayout.tsx` — IDELayout imports and renders FileTree
  - `npm run dev:app` — starts without errors, sidebar shows file tree
  - Navigate to `http://localhost:5180/` — sidebar shows project files with expand/collapse
  - Right-click a file — context menu appears with New File, New Folder, Rename, Delete
  - Click a file — console or Zustand devtools shows openFile called (tab appears in store, editor integration in 06-03)
  </verify>
  <done>Context menu with 4 CRUD actions working via radix-ui. FileTree wired into IDELayout sidebar panel replacing the placeholder. Right-click any node shows context menu, click files triggers openFile. Full file browsing experience functional.</done>
</task>

</tasks>

<verification>
- `npm run dev:app` starts without errors
- Navigate to `/` — sidebar shows project file tree (not placeholder text)
- Expand/collapse folders — directory contents load lazily
- Click a file — Zustand store registers a new tab (visible in React DevTools or console)
- Right-click → context menu appears with New File, New Folder, Rename, Delete
- Create a new file via context menu → file appears in tree
- Delete a file via context menu → file removed from tree
- Rename a file via context menu → file updated in tree
- `npm run build:app` — builds without errors
</verification>

<success_criteria>
1. File tree renders in sidebar with expand/collapse, file/folder icons
2. Click-to-open registers a tab in Zustand store (editor wiring in 06-03)
3. Right-click context menu with New File, New Folder, Rename, Delete
4. All mutations invalidate React Query cache → tree re-renders
5. No regressions — editor and chat placeholders still render in their panels
</success_criteria>

<output>
After completion, create `.planning/phases/06-ide-shell/06-02-SUMMARY.md`
</output>
