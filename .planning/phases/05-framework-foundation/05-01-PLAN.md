---
phase: 05-framework-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - tsconfig.app.json
  - app/entry.client.tsx
  - app/router.tsx
  - app/start.ts
  - app/routes/__root.tsx
  - app/routes/index.tsx
  - app/routes/chat.tsx
  - app/routes/chat.$sessionId.tsx
  - app/components/
  - app/hooks/
  - app/pages/
  - app/styles/
  - app/shared/
autonomous: true

must_haves:
  truths:
    - "User runs one command and TanStack Start SPA loads in browser"
    - "User navigates between routes using file-based routing"
    - "Existing Phase 1 AppShell layout and ChatPage component render inside TanStack Start routes"
  artifacts:
    - path: "vite.config.ts"
      provides: "TanStack Start SPA + Monaco worker + Tailwind config"
      contains: "tanstackStart"
    - path: "app/routes/__root.tsx"
      provides: "Root layout wrapping AppShell + QueryClientProvider"
      contains: "createRootRoute"
    - path: "app/routes/chat.$sessionId.tsx"
      provides: "Chat route wrapping existing ChatPage"
      contains: "createFileRoute"
    - path: "app/router.tsx"
      provides: "Router configuration with route tree"
      contains: "createRouter"
    - path: "app/entry.client.tsx"
      provides: "Client-side entry point for SPA hydration"
      contains: "createRoot"
  key_links:
    - from: "app/routes/__root.tsx"
      to: "app/components/layout/AppShell.tsx"
      via: "import and render as layout wrapper"
      pattern: "import.*AppShell"
    - from: "app/routes/chat.$sessionId.tsx"
      to: "app/pages/ChatPage.tsx"
      via: "import and render as route component"
      pattern: "import.*ChatPage"
    - from: "vite.config.ts"
      to: "app/router.tsx"
      via: "tanstackStart plugin discovers routes"
      pattern: "tanstackStart"
---

<objective>
Create the TanStack Start project scaffold with SPA mode, file-based routing, Vite config with Monaco worker plugin, and migrate existing Phase 1 components into the new routing structure.

Purpose: Establishes the application foundation that Plans 02 and 03 build upon. Proves TanStack Start SPA mode works with existing React components.
Output: Running TanStack Start dev server with file-based routing, AppShell layout, and ChatPage component rendering (API calls will 404 until Plan 02 — expected).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-framework-foundation/05-CONTEXT.md
@.planning/phases/05-framework-foundation/05-RESEARCH.md
@src/dashboard/frontend/package.json
@src/dashboard/frontend/vite.config.ts
@src/dashboard/frontend/src/App.tsx
@src/dashboard/shared/engine-types.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project Restructure + Dependencies + Vite Config + Entry Files</name>
  <files>
    package.json
    vite.config.ts
    tsconfig.app.json
    app/entry.client.tsx
    app/router.tsx
    app/start.ts
  </files>
  <action>
    **1. Update root package.json:**
    - Add to dependencies: @tanstack/react-start ^1.159.5, @tanstack/react-router ^1.159.5, react ^18.2.0, react-dom ^18.2.0, @tanstack/react-query ^5.17.19, lucide-react ^0.344.0, react-markdown ^9.0.1, rehype-highlight ^7.0.0, rehype-raw ^7.0.0, remark-gfm ^4.0.0, clsx ^2.1.0, tailwind-merge ^2.2.1, drizzle-orm ^0.45.1
    - Add to devDependencies: @tanstack/router-cli ^1.159.5, vite ^6.1.0, @vitejs/plugin-react ^4.2.1, @tailwindcss/vite ^4.1.18, tailwindcss ^4.1.18, vite-plugin-monaco-editor ^1.1.0, drizzle-kit ^0.31.9, @types/react ^18.2.48, @types/react-dom ^18.2.18
    - REMOVE from dependencies: express, cors
    - REMOVE from devDependencies: @types/express, @types/cors
    - KEEP: better-sqlite3, ws, @types/ws, @types/better-sqlite3, chokidar, open, tsx, typescript, @types/node
    - Add scripts: "dev:app": "vite", "build:app": "vite build", "preview:app": "vite preview", "db:generate": "drizzle-kit generate", "db:migrate": "drizzle-kit migrate", "db:studio": "drizzle-kit studio"
    - Keep existing scripts unchanged (build, dev, typecheck, test — these are for the plugin)
    - Run `npm install`

    **2. Create vite.config.ts at project root:**
    ```typescript
    import { defineConfig } from 'vite'
    import { tanstackStart } from '@tanstack/react-start/plugin/vite'
    import monacoEditorPlugin from 'vite-plugin-monaco-editor'
    import tailwindcss from '@tailwindcss/vite'
    import { resolve } from 'path'

    export default defineConfig({
      plugins: [
        tanstackStart({
          spa: { enabled: true },
        }),
        monacoEditorPlugin({
          languageWorkers: ['editorWorkerService', 'typescript', 'json', 'css', 'html'],
        }),
        tailwindcss(),
      ],
      resolve: {
        alias: {
          '@': resolve(__dirname, './app'),
        },
      },
    })
    ```
    CRITICAL: Use `{ tanstackStart }` (named export) from `@tanstack/react-start/plugin/vite` — NOT a default import. Do NOT use `app.config.ts` — TanStack Start uses `vite.config.ts` exclusively. The `srcDirectory` option may be needed to point routes to `app/routes/` if the default `src/routes/` doesn't work — check TanStack Start docs and adjust.

    **3. Create tsconfig.app.json** (separate from root tsconfig.json which builds plugin code):
    ```json
    {
      "compilerOptions": {
        "target": "ES2022",
        "module": "ESNext",
        "moduleResolution": "bundler",
        "jsx": "react-jsx",
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "baseUrl": ".",
        "paths": {
          "@/*": ["./app/*"]
        }
      },
      "include": ["app/**/*"],
      "exclude": ["node_modules"]
    }
    ```

    **4. Create TanStack Start entry files:**

    `app/entry.client.tsx` — Client entry for SPA mode. This bootstraps the app via createRoot (not hydrateRoot since there's no SSR in SPA mode):
    ```typescript
    import { createRoot } from 'react-dom/client'
    import { StartClient } from '@tanstack/react-start/client'
    import { createRouter } from './router'

    const router = createRouter()
    const root = createRoot(document.getElementById('root')!)
    root.render(<StartClient router={router} />)
    ```
    NOTE: The exact SPA entry pattern may differ. If TanStack Start provides a different SPA bootstrap API, follow the framework's convention. The key is: no SSR hydration, pure client-side render.

    `app/router.tsx` — Router configuration:
    ```typescript
    import { createRouter as createTanStackRouter } from '@tanstack/react-router'
    import { routeTree } from './routeTree.gen'

    export function createRouter() {
      return createTanStackRouter({
        routeTree,
        defaultPreload: 'intent',
      })
    }

    declare module '@tanstack/react-router' {
      interface Register {
        router: ReturnType<typeof createRouter>
      }
    }
    ```

    `app/start.ts` — Global middleware config (CORS replaces `cors` npm package):
    ```typescript
    import { createStart } from '@tanstack/react-start'

    export default createStart({
      // CORS middleware for development (browser -> server function calls)
      // In production, same-origin so no CORS needed
    })
    ```

    **5. Verify entry file conventions:**
    If TanStack Start expects specific file names or locations (e.g., `app/ssr.tsx`, `app/client.tsx`), adapt accordingly. The research validated the API surface but exact file naming may vary. Check `@tanstack/react-start` package exports for hints.
  </action>
  <verify>
    - `npm install` completes without errors
    - `express` and `cors` no longer in node_modules (or at least not in package.json)
    - vite.config.ts exists at project root
    - tsconfig.app.json exists at project root
    - app/entry.client.tsx, app/router.tsx, app/start.ts exist
    - `npx tsc --noEmit -p tsconfig.app.json` — zero errors on the entry files (may warn about missing routeTree.gen — that's OK, created in Task 2)
  </verify>
  <done>
    All dependencies installed, Vite config with TanStack Start SPA mode + Monaco worker + Tailwind ready, entry files created, tsconfig.app.json separates app build from plugin build.
  </done>
</task>

<task type="auto">
  <name>Task 2: Component Migration + File-Based Routing + SPA Verification</name>
  <files>
    app/components/
    app/hooks/
    app/pages/
    app/styles/
    app/shared/
    app/routes/__root.tsx
    app/routes/index.tsx
    app/routes/chat.tsx
    app/routes/chat.$sessionId.tsx
  </files>
  <action>
    **1. Copy existing frontend code to app/ directory:**
    ```bash
    cp -r src/dashboard/frontend/src/components app/components
    cp -r src/dashboard/frontend/src/hooks app/hooks
    cp -r src/dashboard/frontend/src/pages app/pages
    cp -r src/dashboard/frontend/src/styles app/styles
    cp -r src/dashboard/shared app/shared
    cp src/dashboard/frontend/src/vite-env.d.ts app/ 2>/dev/null || true
    ```
    The existing files use `@/` path aliases (e.g., `import { AppShell } from '@/components/layout/AppShell'`). Since tsconfig.app.json maps `@/*` to `./app/*`, these internal imports continue to work without modification.

    Check if any files import from `@shared/` — update those to `@/shared/` (the alias changed from `../shared` to within app/).

    **2. Create route files:**

    `app/routes/__root.tsx` — Root layout (replaces App.tsx's BrowserRouter + AppShell wrapper):
    ```tsx
    import { createRootRoute, Outlet } from '@tanstack/react-router'
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
    import { AppShell } from '@/components/layout/AppShell'
    import { ErrorBoundary } from '@/components/layout/ErrorBoundary'

    const queryClient = new QueryClient({
      defaultOptions: {
        queries: {
          refetchInterval: 5000,
          staleTime: 2000,
        },
      },
    })

    export const Route = createRootRoute({
      component: RootLayout,
    })

    function RootLayout() {
      return (
        <QueryClientProvider client={queryClient}>
          <ErrorBoundary>
            <AppShell>
              <Outlet />
            </AppShell>
          </ErrorBoundary>
        </QueryClientProvider>
      )
    }
    ```
    NOTE: AppShell currently uses `<Outlet />` from react-router-dom. It needs to be updated to use `<Outlet />` from @tanstack/react-router, OR the AppShell should accept children as props instead. Check AppShell.tsx — if it renders `<Outlet />` from react-router-dom, change it to accept `{children}` and render children. The root route's RootLayout already provides the TanStack Outlet.

    `app/routes/index.tsx` — Root route, redirects to /chat (per user decision: chat is the "it works" proof):
    ```tsx
    import { createFileRoute, redirect } from '@tanstack/react-router'

    export const Route = createFileRoute('/')({
      beforeLoad: () => {
        throw redirect({ to: '/chat' })
      },
    })
    ```

    `app/routes/chat.tsx` — Chat layout route (parent for /chat and /chat/:sessionId):
    ```tsx
    import { createFileRoute, Outlet } from '@tanstack/react-router'

    export const Route = createFileRoute('/chat')({
      component: () => <Outlet />,
    })
    ```

    `app/routes/chat.$sessionId.tsx` — Chat session route wrapping existing ChatPage:
    ```tsx
    import { createFileRoute } from '@tanstack/react-router'
    import { ChatPage } from '@/pages/ChatPage'

    export const Route = createFileRoute('/chat/$sessionId')({
      component: ChatSessionPage,
    })

    function ChatSessionPage() {
      const { sessionId } = Route.useParams()
      return <ChatPage />
    }
    ```
    NOTE: ChatPage currently reads sessionId from `useParams()` (react-router-dom). It needs to be updated to read from TanStack Router's `Route.useParams()` or receive sessionId as a prop. The simplest fix: update ChatPage to accept an optional `sessionId` prop and fall back to route params. Or update all `useParams` imports from react-router-dom to @tanstack/react-router.

    Also create `app/routes/chat.index.tsx` for /chat without a sessionId (shows empty state or creates new session):
    ```tsx
    import { createFileRoute } from '@tanstack/react-router'
    import { ChatPage } from '@/pages/ChatPage'

    export const Route = createFileRoute('/chat/')({
      component: ChatPage,
    })
    ```

    **3. Update React Router imports to TanStack Router:**
    - In ALL moved component/page files, replace `import { ... } from 'react-router-dom'` with `import { ... } from '@tanstack/react-router'`
    - Key mapping: `useParams` -> `useParams` (same name, different package), `useNavigate` -> `useNavigate`, `Link` -> `Link`, `Navigate` -> `redirect`, `Outlet` -> `Outlet`
    - AppShell.tsx: If it uses `<Outlet />` from react-router-dom, update to accept children prop instead. The root route provides the TanStack Outlet.
    - Sidebar.tsx: If it uses `<Link>` or `useLocation` from react-router-dom, update to TanStack Router equivalents.
    - ChatPage.tsx: Update `useParams` and `useNavigate` imports.

    **4. Generate route tree:**
    ```bash
    npx tsr generate
    ```
    This creates app/routeTree.gen.ts (or wherever TanStack Router CLI puts it). If the CLI expects routes in `src/routes/` by default, configure it via `tsr.config.json` or the Vite plugin's `srcDirectory` option to point to `app/routes/`.

    **5. Remove react-router-dom dependency:**
    - Remove `react-router-dom` from package.json (it was in frontend's package.json, now absorbed)
    - Ensure no remaining imports of react-router-dom

    **6. Verify SPA loads:**
    ```bash
    npm run dev:app
    ```
    - Opens browser at localhost URL
    - Should see AppShell layout render
    - Navigate to /chat — ChatPage component renders
    - API calls (engine status, sessions) will 404 — that is expected and fixed in Plan 02
    - Console should NOT show React Router errors (all imports updated to TanStack Router)
  </action>
  <verify>
    - `npm run dev:app` starts without build errors
    - Browser loads SPA at localhost — no blank page, no hydration errors
    - AppShell layout visible (sidebar + main content area)
    - Navigate to /chat — ChatPage component renders (even if data doesn't load)
    - No console errors about react-router-dom (all imports migrated to @tanstack/react-router)
    - `npx tsc --noEmit -p tsconfig.app.json` passes (zero type errors)
    - routeTree.gen.ts exists and contains routes for /, /chat, /chat/$sessionId
  </verify>
  <done>
    TanStack Start SPA loads with file-based routing. AppShell layout renders. Chat route wraps existing ChatPage component. All react-router-dom imports replaced with @tanstack/react-router. Monaco worker plugin configured for Phase 6. No Express dependency remains.
  </done>
</task>

</tasks>

<verification>
**Phase-level checks (run after all plans complete):**
1. `npm run dev:app` starts TanStack Start dev server
2. SPA loads at localhost with file-based routing
3. No Express server process — all transport via TanStack Start
4. No react-router-dom imports remaining
5. Plugin build (`npm run build`) still works (tsconfig.json unchanged)
6. Plugin tests (`npm test`) still pass (plugin code untouched)
</verification>

<success_criteria>
- TanStack Start SPA mode running with Vite
- File-based routing: __root.tsx, index, chat, chat.$sessionId
- Existing AppShell + ChatPage components render inside TanStack routes
- Monaco worker plugin configured in Vite (ready for Phase 6)
- Express and react-router-dom removed as dependencies
- Plugin build chain unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/05-framework-foundation/05-01-SUMMARY.md`
</output>
