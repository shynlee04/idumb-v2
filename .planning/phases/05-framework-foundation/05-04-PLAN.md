---
phase: 05-framework-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/client.tsx
  - app/router.tsx
  - app/routes/__root.tsx
  - app/ssr.tsx (DELETE)
  - app/start.ts (DELETE)
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Dev server starts and SPA renders route components (not stuck on spinner)"
    - "Navigating to /chat/new, /tasks, /settings renders each route component"
    - "Engine auto-start fires on client load and failure is non-fatal"
  artifacts:
    - path: "app/client.tsx"
      provides: "Correct SPA hydration entry with startTransition"
      contains: "startTransition"
    - path: "app/router.tsx"
      provides: "Router factory without forced defaultPendingMs: 0"
    - path: "app/routes/__root.tsx"
      provides: "Root route with engine init in useEffect (not beforeLoad)"
      contains: "useEffect"
  key_links:
    - from: "app/client.tsx"
      to: "react-dom/client"
      via: "hydrateRoot wrapped in startTransition"
      pattern: "startTransition.*hydrateRoot"
    - from: "app/routes/__root.tsx"
      to: "app/server/engine.ts"
      via: "useEffect calling ensureEngineFn"
      pattern: "useEffect.*ensureEngineFn"
---

<objective>
Fix TanStack Start SPA hydration failure — the app currently shows an eternal spinner because
`client.tsx` is missing the `startTransition` wrapper around `hydrateRoot`. Additionally, clean up
dead files (`ssr.tsx`, `start.ts`) that were added in a previous fix attempt, and move engine
initialization from `beforeLoad` to `useEffect` for proper separation of concerns.

Purpose: Unblock all Phase 5 UAT tests (Tests 1-5) by fixing the root cause of the SPA black
screen / eternal spinner. Without this fix, no route component ever renders and Phase 6+ cannot
proceed.

Output: Working SPA that loads, navigates between routes, and auto-starts the engine.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-framework-foundation/05-04-RESEARCH.md
@.planning/phases/05-framework-foundation/05-01-SUMMARY.md
@.planning/phases/05-framework-foundation/05-02-SUMMARY.md
@.planning/phases/05-framework-foundation/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SPA hydration entry + clean up dead files</name>
  <files>
    app/client.tsx
    app/router.tsx
    app/ssr.tsx (DELETE)
    app/start.ts (DELETE)
  </files>
  <action>
    This task fixes the PRIMARY root cause of the eternal spinner and removes dead files.

    **1. Fix `app/client.tsx` — add `startTransition` (ROOT CAUSE FIX)**

    The file is missing `startTransition` around `hydrateRoot`. Without it, hydration happens
    synchronously, and the index route's `throw redirect()` in `beforeLoad` fires during
    synchronous hydration, locking the router in pending state permanently.

    Replace the entire file with the correct TanStack Start client entry pattern:

    ```tsx
    /**
     * client.tsx — TanStack Start client entry point.
     *
     * SPA mode: hydrates the app using StartClient.
     * CRITICAL: startTransition wraps hydrateRoot to handle concurrent React features.
     * Without it, redirects in beforeLoad fire during synchronous hydration and
     * lock the router in pending state.
     *
     * Matches the framework default at packages/react-start/src/default-entry/client.tsx
     */

    import { StrictMode, startTransition } from "react"
    import { hydrateRoot } from "react-dom/client"
    import { StartClient } from "@tanstack/react-start/client"

    startTransition(() => {
      hydrateRoot(
        document,
        <StrictMode>
          <StartClient />
        </StrictMode>,
      )
    })
    ```

    **2. Remove `defaultPendingMs: 0` from `app/router.tsx`**

    In the `getRouter()` function, remove the `defaultPendingMs: 0` line. This setting forces the
    spinner to show immediately on every navigation. The framework default handles SPA shell
    rendering correctly. Keep `defaultPendingComponent` and `defaultNotFoundComponent` — those are
    fine for consistent loading/404 UX.

    The router config should become:
    ```typescript
    const router = createTanStackRouter({
      routeTree,
      defaultPreload: "intent",
      scrollRestoration: true,
      defaultPendingComponent: DefaultPendingComponent,
      defaultNotFoundComponent: DefaultNotFoundComponent,
    })
    ```

    **3. Delete `app/ssr.tsx`**

    This is a DEAD FILE. TanStack Start resolves the server entry by looking for `server.ts`,
    NOT `ssr.tsx` (verified from `resolve-entries.ts` in TanStack Start source). The file was added
    in commit 8f31b48 as a fix attempt but is never loaded by the framework. Its presence causes
    confusion and has a misleading comment claiming it's "Required even in SPA mode."

    Run: `rm app/ssr.tsx`

    **4. Delete `app/start.ts`**

    This file creates an empty `createStart()` instance. The framework default exports `undefined`.
    The empty config does nothing functionally and can be recreated if middleware is needed later.

    Run: `rm app/start.ts`

    After deletion, verify the route tree regenerates correctly by running `npm run dev` briefly
    (Ctrl+C after route tree generates) or `npx tsc --noEmit -p tsconfig.app.json`.
  </action>
  <verify>
    1. `app/ssr.tsx` does NOT exist: `! test -f app/ssr.tsx`
    2. `app/start.ts` does NOT exist: `! test -f app/start.ts`
    3. `app/client.tsx` contains `startTransition`: `grep -q 'startTransition' app/client.tsx`
    4. `app/router.tsx` does NOT contain `defaultPendingMs`: `! grep -q 'defaultPendingMs' app/router.tsx`
    5. TypeScript clean: `npx tsc --noEmit -p tsconfig.app.json` exits 0
    6. Existing test suite: `npm test` passes
  </verify>
  <done>
    client.tsx has startTransition wrapping hydrateRoot, ssr.tsx and start.ts are deleted,
    router.tsx no longer forces defaultPendingMs: 0, typecheck passes, test suite passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move engine init from beforeLoad to useEffect</name>
  <files>
    app/routes/__root.tsx
  </files>
  <action>
    Move the `ensureEngineFn()` call from the root route's `beforeLoad` to a `useEffect` in
    `RootComponent`. This separates routing concerns (beforeLoad) from application initialization
    (engine start), and ensures the engine init only fires on the client (no need for the
    `typeof window !== "undefined"` guard that beforeLoad required).

    **Modify `app/routes/__root.tsx`:**

    1. Add `useEffect` import from React:
       ```typescript
       import { useEffect } from "react"
       ```
       (Replace the existing `import type { ReactNode } from "react"` with
       `import { useEffect, type ReactNode } from "react"`)

    2. Move ensureEngineFn into RootComponent:
       ```tsx
       function RootComponent() {
         useEffect(() => {
           ensureEngineFn().catch(() => {
             // Engine init failure is non-fatal — dashboard runs in degraded mode
           })
         }, [])

         return (
           <RootDocument>
             <QueryClientProvider client={queryClient}>
               <EventStreamProvider>
                 <Outlet />
               </EventStreamProvider>
             </QueryClientProvider>
           </RootDocument>
         )
       }
       ```

    3. Remove the `beforeLoad` property entirely from the `createRootRoute()` config:
       ```typescript
       export const Route = createRootRoute({
         head: () => ({
           meta: [
             { title: "iDumb Dashboard" },
             { name: "description", content: "Intelligent Delegation Using Managed Boundaries" },
           ],
           links: [
             { rel: "stylesheet", href: appCss },
           ],
         }),
         component: RootComponent,
         errorComponent: RootErrorComponent,
       })
       ```

    The `ensureEngineFn` import stays unchanged — it is still needed.
  </action>
  <verify>
    1. `app/routes/__root.tsx` contains `useEffect`: `grep -q 'useEffect' app/routes/__root.tsx`
    2. `app/routes/__root.tsx` does NOT contain `beforeLoad`: `! grep -q 'beforeLoad' app/routes/__root.tsx`
    3. TypeScript clean: `npx tsc --noEmit -p tsconfig.app.json` exits 0
    4. Existing test suite: `npm test` passes
  </verify>
  <done>
    Engine init moved to useEffect in RootComponent, beforeLoad removed from root route,
    typecheck passes, test suite passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify SPA loads and routes render</name>
  <what-built>
    Fixed TanStack Start SPA hydration failure by:
    1. Adding startTransition to client.tsx (root cause of eternal spinner)
    2. Deleting dead file ssr.tsx (was never loaded by framework)
    3. Deleting unnecessary start.ts (framework defaults suffice)
    4. Removing defaultPendingMs: 0 from router (let framework decide)
    5. Moving engine init from beforeLoad to useEffect (cleaner separation)
  </what-built>
  <how-to-verify>
    1. Run `cd app && npm run dev` (or `npm run dev` from project root if configured)
    2. Open browser at http://localhost:5180
    3. EXPECT: The `/` route should redirect to `/chat/new` — you should see the chat route component render (not an eternal spinner)
    4. Navigate to http://localhost:5180/tasks — EXPECT: Tasks route renders its component
    5. Navigate to http://localhost:5180/settings — EXPECT: Settings route renders its component
    6. Check browser console — EXPECT: No hydration mismatch errors, no React warnings about startTransition
    7. Check terminal/server logs — EXPECT: Engine init attempt visible (may fail if OpenCode is not running, that is OK)
    8. Use browser back button — EXPECT: Navigation works, routes transition without spinner lock
  </how-to-verify>
  <resume-signal>Type "approved" if SPA loads and routes render, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Phase 05 Gap Closure verification:
1. SPA loads without eternal spinner — route components render
2. File-based routing works — /chat/new, /tasks, /settings all render
3. Engine auto-start fires via useEffect (check server logs)
4. No dead files: ssr.tsx and start.ts are gone
5. TypeScript clean: `npx tsc --noEmit -p tsconfig.app.json`
6. Test suite passes: `npm test`
</verification>

<success_criteria>
- Dev server starts and SPA renders route components (spinner resolves to actual content)
- All 4 route stubs (index redirect, chat, tasks, settings) are reachable
- Engine auto-start fires on client load without blocking rendering
- Zero TypeScript errors in app/ code
- Existing test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-framework-foundation/05-04-SUMMARY.md`
</output>
