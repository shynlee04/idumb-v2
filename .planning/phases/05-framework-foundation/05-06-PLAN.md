---
phase: 05-framework-foundation
plan: 06
type: execute
wave: 1
depends_on: ["05-04"]
files_modified:
  - app/routes/api/events.ts
  - app/routes/api/sessions.$id.prompt.ts
  - app/_server-routes/ (deleted)
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "SSE endpoint GET /api/events returns Content-Type: text/event-stream"
    - "SSE endpoint POST /api/sessions/$id/prompt streams chat events as SSE"
    - "Drizzle ORM runtime verified — settings CRUD writes/reads from SQLite"
    - "npm run build:app succeeds with zero errors"
  artifacts:
    - path: "app/routes/api/events.ts"
      provides: "Global SSE event relay server route"
      contains: "text/event-stream"
    - path: "app/routes/api/sessions.$id.prompt.ts"
      provides: "Chat SSE streaming server route"
      contains: "text/event-stream"
  key_links:
    - from: "app/routes/api/events.ts"
      to: "app/server/sdk-client.server.ts"
      via: "import { getClient, sdkQuery }"
      pattern: "import.*getClient.*sdk-client\\.server"
    - from: "app/routes/api/sessions.$id.prompt.ts"
      to: "app/server/sdk-client.server.ts"
      via: "import { getClient, sdkQuery }"
      pattern: "import.*getClient.*sdk-client\\.server"
    - from: "app/hooks/useStreaming.ts"
      to: "app/routes/api/sessions.$id.prompt.ts"
      via: "fetch('/api/sessions/${sessionId}/prompt')"
      pattern: "fetch.*api/sessions"
    - from: "app/hooks/useEventStream.tsx"
      to: "app/routes/api/events.ts"
      via: "EventSource('/api/events')"
      pattern: "EventSource.*api/events"
---

<objective>
Close the SSE blocker preventing Phase 5 completion, fix build:app, and verify all 4 Phase 5 success criteria at runtime.

Purpose: SSE routes are in `app/_server-routes/` — the underscore prefix excludes them from TanStack Router's route tree. Moving them to `app/routes/api/` makes them discoverable. This is the ONLY remaining blocker for Phase 5.
Output: Working SSE endpoints + verified Phase 5 completion
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-framework-foundation/05-04-RESEARCH.md
@.planning/phases/05-framework-foundation/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move SSE routes into route tree + fix build</name>
  <files>app/routes/api/events.ts, app/routes/api/sessions.$id.prompt.ts, app/_server-routes/ (delete)</files>
  <action>
Move both SSE server route files from the excluded `app/_server-routes/` directory into `app/routes/api/` so TanStack Start's Vite plugin discovers them:

1. Create directory `app/routes/api/` (if not already present from prior work — may have been deleted)

2. Move `app/_server-routes/events.ts` → `app/routes/api/events.ts`
   - Update import path: change `"../server/sdk-client.server"` to `"../../server/sdk-client.server"` (one level deeper now)
   - Keep the `as any` spread pattern for `server.handlers` — TanStack Start types may not include `server.handlers` in SPA mode, so the type workaround is intentional

3. Move `app/_server-routes/sessions.$id.prompt.ts` → `app/routes/api/sessions.$id.prompt.ts`
   - Update import path: change `"../server/sdk-client.server"` to `"../../server/sdk-client.server"`
   - Keep the `as any` spread pattern for same reason

4. Delete the now-empty `app/_server-routes/` directory

5. Run `npm install` from project root to refresh npm's script cache (fixes `build:app` "Missing script" error from UAT test 2)

6. Run `npm run build:app` to verify the build succeeds

7. Run `npx tsc --noEmit -p tsconfig.app.json` to verify zero type errors

8. Start the dev server briefly (`npm run dev:app`) and observe if `routeTree.gen.ts` regenerates with `/api/*` routes. Server routes may or may not appear in routeTree.gen.ts — what matters is that the Vite plugin picks them up for server-side dispatch.

IMPORTANT: Do NOT modify any SSE implementation logic. The route handlers are correct — only the file location and import paths need to change.

Research reference: TanStack Start server routes confirmed (Context7): files MUST be in the `routes/` directory. `createFileRoute('/api/hello')({ server: { handlers: { GET: ... } } })` is the official pattern.
  </action>
  <verify>
1. `ls app/routes/api/events.ts app/routes/api/sessions.\$id.prompt.ts` — both files exist
2. `ls app/_server-routes/ 2>/dev/null` — directory no longer exists
3. `grep -n "../../server/sdk-client.server" app/routes/api/events.ts` — import path updated
4. `grep -n "../../server/sdk-client.server" app/routes/api/sessions.\$id.prompt.ts` — import path updated
5. `npm run build:app` — completes without errors
6. `npx tsc --noEmit -p tsconfig.app.json` — zero errors
  </verify>
  <done>
SSE route files live in `app/routes/api/`, import paths correct, build succeeds, typecheck passes. The `app/_server-routes/` directory is deleted.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Runtime verification — all 4 Phase 5 success criteria</name>
  <files>No files modified — verification only</files>
  <action>
Present the user with the Phase 5 runtime verification checklist. All 4 success criteria must be confirmed at runtime by the user. Claude starts the dev server (`npm run dev:app`) and runs automated curl checks first, then asks the user to verify browser behavior.

What was built: SSE routes moved to correct location in route tree. Build script fixed. All static verification passes.
  </action>
  <verify>
Start dev server and verify ALL 4 Phase 5 success criteria at runtime:

**Criterion 1: SPA loads with routing**
1. Run `npm run dev:app` from project root
2. Open http://localhost:5180 in browser
3. Verify app loads (dark theme, layout visible)
4. Navigate to /tasks, /settings, /chat/new — each renders

**Criterion 2: Server functions return typed data**
(Already verified in UAT tests 8-10 — spot-check one)
5. Open DevTools Network tab, navigate routes, confirm no Express-related XHR calls

**Criterion 3: SSE streaming (the blocker)**
6. In terminal: `curl -N http://localhost:5180/api/events`
   Expected: Response with `Content-Type: text/event-stream`, NOT HTML or error JSON
   You should see SSE events (at minimum a "connected" event) or a connection that stays open
7. In terminal: `curl -X POST http://localhost:5180/api/sessions/test/prompt -H 'Content-Type: application/json' -d '{"prompt":"hello"}'`
   Expected: SSE-formatted response (event/data lines), NOT HTML page

**Criterion 4: Drizzle persistence**
8. Navigate to /settings in browser
9. Check if `.data/idumb.db` file was created (may need settings interaction)
   Or run: `ls -la .data/idumb.db` from project root

Report results for all 4 criteria. Type "approved" if all 4 criteria pass, or describe which criteria failed with error details.
  </verify>
  <done>User confirms all 4 Phase 5 success criteria pass at runtime: SPA loads, server functions work, SSE streams connect, Drizzle persists data.</done>
</task>

</tasks>

<verification>
Phase 5 verification checklist (from ROADMAP.md success criteria):
1. ✓ SPA loads with file-based routing (verified in UAT tests 4-7)
2. ✓ Server functions return typed data (verified in UAT tests 8-10)
3. ? SSE streaming through server routes (THIS plan fixes it)
4. ? Drizzle ORM runtime (schema verified, runtime needs human check)

All 4 must pass for Phase 5 to be marked complete.
</verification>

<success_criteria>
- SSE routes discoverable by TanStack Start (files in `app/routes/api/`)
- `curl /api/events` returns `text/event-stream` (not HTML or error)
- `curl -X POST /api/sessions/test/prompt` returns SSE stream (not HTML 404)
- `npm run build:app` succeeds
- `npx tsc --noEmit -p tsconfig.app.json` passes
- Human confirms all 4 Phase 5 success criteria at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/05-framework-foundation/05-06-SUMMARY.md`
</output>
