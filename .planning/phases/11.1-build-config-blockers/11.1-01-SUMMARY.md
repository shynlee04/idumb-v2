---
phase: 11.1-build-config-blockers
plan: 01
subsystem: build, types, config
tags: [vite, typescript, sdk-governance, manualChunks, tsconfig, package.json]

# Dependency graph
requires:
  - phase: 11-sdk-type-realignment
    provides: engine-types.ts SDK type gateway, sdk-validators.ts Zod boundary validation
provides:
  - Clean app build pipeline (client + SSR) without manualChunks conflict
  - Complete SDK type gateway (Provider, Agent, Path, VcsInfo added)
  - All app/ SDK imports routed through engine-types.ts
  - Type-safe SessionStatus casts replacing Record<string, unknown>
  - Accurate test baselines in CLAUDE.md and AGENTS.md (591 assertions)
  - Clean package.json (no zombie entry points to archived src/index.ts)
affects: [phase-7-chat-terminal, phase-11.2-contamination-purge]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "SDK type gateway pattern: all app/ SDK imports through engine-types.ts"
    - "TanStack Start serialization: leave return types inferred for JSON roundtrips on SDK types"

key-files:
  created: []
  modified:
    - app/vite.config.ts
    - app/routes/__root.tsx
    - tsconfig.app.json
    - app/shared/engine-types.ts
    - app/server/config.ts
    - app/server/sessions.ts
    - CLAUDE.md
    - AGENTS.md
    - package.json

key-decisions:
  - "GOV-3 assertion skipped: TanStack Start rejects SDK Message type's `unknown` index signatures in explicit return types. Return type left inferred per existing design."
  - "CLAUDE.md @shared alias entry removed from Known Issues (fixed, no longer applies)"

patterns-established:
  - "TanStack Start JSON roundtrip: never add explicit type assertions on server function returns containing SDK types with unknown index signatures — leave inferred"

# Metrics
duration: 11min
completed: 2026-02-12
---

# Phase 11.1 Plan 01: Build/Config/Type Blockers Summary

**7 build/config/type gaps closed: manualChunks SSR conflict removed, SDK imports centralized through engine-types.ts, unsafe casts replaced with typed SessionStatus, dead @shared alias purged, test baselines corrected to 591, zombie package.json entry points removed**

## Performance

- **Duration:** 11 min
- **Started:** 2026-02-11T17:07:27Z
- **Completed:** 2026-02-11T17:18:50Z
- **Tasks:** 3
- **Files modified:** 9

## Accomplishments

- Production build pipeline fixed: `npm run build:app` succeeds for both client and SSR builds
- SDK type governance enforced: all app/ imports go through engine-types.ts gateway, no direct SDK imports in consuming files
- Documentation drift corrected: test baselines match actual output (591 assertions), dead config entries removed

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix build pipeline** - `821af8a` (fix) — Remove manualChunks, stale @ts-expect-error, dead @shared alias
2. **Task 2: Fix SDK type governance** - `4565346` (fix) — Centralize imports and replace unsafe casts
3. **Task 3: Fix documentation drift** - `ec2b2eb` (chore) — Update test baselines to 591 and remove stale entry points

## Files Created/Modified

- `app/vite.config.ts` — Removed manualChunks output block and dead @shared alias
- `app/routes/__root.tsx` — Removed stale @ts-expect-error directive
- `tsconfig.app.json` — Removed dead @shared/* path mapping
- `app/shared/engine-types.ts` — Added Provider, Agent, Path, VcsInfo to SDK re-exports
- `app/server/config.ts` — Redirected SDK import through engine-types.ts gateway
- `app/server/sessions.ts` — Replaced `Record<string, unknown>` with `Record<string, SessionStatus>`, added SessionStatus assertion to JSON roundtrip
- `CLAUDE.md` — Updated test baseline to 591, removed @shared from path aliases table and known issues
- `AGENTS.md` — Updated 3 test baseline references to 591
- `package.json` — Removed main, types, exports fields (zombie references to archived src/index.ts)

## Decisions Made

1. **GOV-3 messages assertion skipped** — The plan called for adding `as Array<{ info: Message; parts: Part[] }>` to the getSessionMessagesFn JSON roundtrip return. However, TanStack Start's serialization constraint rejects SDK `Message` type's `unknown` index signatures when the return type is explicit. The return type was correctly left inferred per the existing design comment. This is the documented known false alarm in AGENTS.md.

2. **CLAUDE.md @shared cleanup** — Beyond the plan's scope, also removed the @shared alias from the path aliases table and the Known Issues section since the alias was deleted in Task 1. This keeps documentation consistent.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] GOV-3 type assertion breaks TanStack Start serialization**
- **Found during:** Task 2 (SDK type governance)
- **Issue:** Plan specified adding `as Array<{ info: Message; parts: Part[] }>` to getSessionMessagesFn return, but SDK `Message` type contains `{ [key: string]: unknown }` in nested error union, which TanStack Start's handler type constraint rejects (expects `{}` not `unknown` in index signatures)
- **Fix:** Reverted the assertion, keeping return type inferred (matching existing design). Removed unused Message/Part imports.
- **Files modified:** app/server/sessions.ts
- **Verification:** `npm run typecheck:app` passes with zero errors
- **Committed in:** 4565346 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug — plan's assertion incompatible with TanStack Start type system)
**Impact on plan:** GOV-3 is partially addressed — the Zod validation (`validateMessages`) still proves shape at runtime, and the JSON roundtrip handles serialization. The only gap is the missing compile-time assertion, which is blocked by TanStack Start's serialization type constraint. Acceptable tradeoff.

## Issues Encountered

None beyond the GOV-3 deviation documented above.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `npm run build:app` succeeds cleanly (both client and SSR)
- `npm run typecheck:app` passes with zero errors
- `npm run build` (src/) succeeds
- `npm test` passes all 10 suites (591 assertions)
- Phase 11.2 (Contamination Purge) can proceed
- Phase 7 (Chat + Terminal) unblocked after 11.2 completes

## Verification Results

All 7 final verification checks passed:

| # | Check | Result |
|---|-------|--------|
| 1 | `npm run build:app` succeeds | PASS |
| 2 | `npm run typecheck:app` zero errors | PASS |
| 3 | `npm run build` succeeds | PASS |
| 4 | `npm test` 10 suites, 591 assertions | PASS |
| 5 | SDK imports: only engine-types.ts + sdk-client.server.ts | PASS |
| 6 | @shared alias removed from tsconfig + vite config | PASS |
| 7 | package.json: no main/types/exports | PASS |

## Gap Closure Status

| Gap | Description | Status |
|-----|-------------|--------|
| GAP-1 | manualChunks SSR build conflict | CLOSED |
| GAP-2 | Stale @ts-expect-error (TS2578) | CLOSED |
| GOV-1 | Missing SDK type re-exports | CLOSED |
| GOV-2 | Unsafe `Record<string, unknown>` cast | CLOSED |
| GOV-3 | Untyped JSON roundtrip in messages | PARTIAL (runtime Zod validation in place, compile-time assertion blocked by TanStack) |
| DRIFT-1 | Dead @shared alias | CLOSED |
| DRIFT-2 | Stale test baselines | CLOSED |
| CONFIG-1 | Zombie package.json entry points | CLOSED |
| CONFIG-2 | Phantom @opencode-ai/plugin peer dep | ACCEPTED (harmless lockfile artifact) |

---
*Phase: 11.1-build-config-blockers*
*Completed: 2026-02-12*
