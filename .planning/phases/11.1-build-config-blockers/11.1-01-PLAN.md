---
phase: 11.1-build-config-blockers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/vite.config.ts
  - app/routes/__root.tsx
  - tsconfig.app.json
  - app/shared/engine-types.ts
  - app/server/config.ts
  - app/server/sessions.ts
  - CLAUDE.md
  - AGENTS.md
  - package.json
autonomous: true

must_haves:
  truths:
    - "`npm run build:app` succeeds (both client and SSR builds) without manualChunks conflict"
    - "`npm run typecheck:app` passes with zero errors (no stale @ts-expect-error, no dead aliases)"
    - "All app/ SDK type imports route through engine-types.ts — zero direct @opencode-ai/sdk imports in consuming files"
    - "No path aliases in tsconfig.app.json or vite.config.ts point to deleted directories"
    - "package.json entry point fields removed (no zombie references to archived src/index.ts)"
    - "CLAUDE.md and AGENTS.md test baselines match actual npm test output (591 assertions)"
  artifacts:
    - path: "app/vite.config.ts"
      provides: "Clean build config — no manualChunks, no dead @shared alias"
      contains: "external: [\"@opencode-ai/sdk\""
    - path: "app/shared/engine-types.ts"
      provides: "Complete SDK type gateway with Provider, Agent, Path, VcsInfo re-exports"
      contains: "Provider"
    - path: "app/server/config.ts"
      provides: "Compliant SDK type import via engine-types.ts"
      contains: "from \"../shared/engine-types\""
    - path: "app/server/sessions.ts"
      provides: "Type-safe casts replacing Record<string, unknown> and untyped JSON roundtrips"
      contains: "as Record<string, SessionStatus>"
  key_links:
    - from: "app/server/config.ts"
      to: "app/shared/engine-types.ts"
      via: "import type { Provider, Agent, Path, VcsInfo }"
      pattern: "from.*engine-types"
    - from: "app/vite.config.ts"
      to: "SSR build pipeline"
      via: "rollupOptions without manualChunks"
      pattern: "external.*@opencode-ai/sdk"
    - from: "app/server/sessions.ts"
      to: "app/server/sdk-validators.ts"
      via: "Zod validation before JSON roundtrip"
      pattern: "validateMessages|validateSessionStatus"
---

<objective>
Fix 7 build/config/type blockers identified in the v2.0 milestone audit that prevent Phase 7 from starting.

Purpose: Phase 7 (Chat + Terminal) cannot begin until `npm run build:app` and `npm run typecheck:app` both pass cleanly, SDK type governance is compliant, and project configuration is accurate.

Output: All 7 gaps closed — GAP-1, GAP-2, GOV-1, GOV-2, GOV-3, DRIFT-1, DRIFT-2, CONFIG-1 resolved. CONFIG-2 (phantom @opencode-ai/plugin peer dep) accepted as harmless per research.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-build-config-blockers/11.1-RESEARCH.md
@app/shared/engine-types.ts
@app/server/sdk-validators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix build pipeline — remove manualChunks, stale @ts-expect-error, and dead @shared alias</name>
  <files>app/vite.config.ts, app/routes/__root.tsx, tsconfig.app.json</files>
  <action>
    **GAP-1: Remove manualChunks from vite.config.ts** (fixes SSR build failure)

    In `app/vite.config.ts`, remove the `output` block inside `rollupOptions` (lines 35-39):
    ```
    output: {
      // Monaco editor is ~4MB — isolate into its own chunk for on-demand loading
      manualChunks: {
        'monaco-editor': ['monaco-editor'],
      },
    },
    ```
    Monaco code splitting is already handled by `MonacoEditor.lazy.tsx` via dynamic `import()`. The `manualChunks` conflicts with SSR externals because `monaco-editor` is browser-only and resolves as external during SSR build.

    **DRIFT-1a: Remove dead @shared alias from vite.config.ts**

    In the same file, remove line 20:
    ```
    "@shared": resolve(__dirname, "../src/dashboard/shared"),
    ```
    The target directory `src/dashboard/shared/` was deleted in Phase 1A. No code uses this alias (verified by grep).

    **GAP-2: Remove stale @ts-expect-error from __root.tsx**

    In `app/routes/__root.tsx`, remove line 23:
    ```
    // @ts-expect-error -- Vite ?url import, resolved at build time
    ```
    This suppression is no longer needed — Vite/TanStack Start type declarations now cover `?url` imports. Keeping it causes TS2578 ("Unused @ts-expect-error directive").

    **DRIFT-1b: Remove dead @shared alias from tsconfig.app.json**

    In `tsconfig.app.json`, remove the `@shared/*` entry from `paths` (line 18):
    ```
    "@shared/*": ["./src/dashboard/shared/*"]
    ```
    Same dead alias as in vite.config.ts — target directory doesn't exist.
  </action>
  <verify>
    Run `npm run build:app` from `/Users/apple/Documents/coding-projects/idumb/v2` — must succeed for both client and SSR builds without "manualChunks" error.
    Run `npm run typecheck:app` — must pass with zero errors (no TS2578 for unused @ts-expect-error, no dead alias issues).
  </verify>
  <done>
    Production build succeeds (both client and SSR). App typecheck passes with zero errors. No dead path aliases remain in tsconfig.app.json or vite.config.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SDK type governance — centralize imports and replace unsafe casts</name>
  <files>app/shared/engine-types.ts, app/server/config.ts, app/server/sessions.ts</files>
  <action>
    **GOV-1: Add missing SDK type re-exports to engine-types.ts and fix config.ts import**

    In `app/shared/engine-types.ts`, add 4 types to the existing SDK import/export blocks:
    - Add `Provider`, `Agent`, `Path`, `VcsInfo` to the `import type { ... } from '@opencode-ai/sdk'` statement (after `Event,`)
    - Add the same 4 types to the `export type { ... }` statement (after `Event,`)

    In `app/server/config.ts`:
    - Change line 17 from:
      `import type { Provider, Agent, Path, VcsInfo } from "@opencode-ai/sdk"`
      to:
      `import type { Provider, Agent, Path, VcsInfo } from "../shared/engine-types"`
    - Update the file header comment (line 11) to remove "SDK types imported directly from @opencode-ai/sdk" — the imports now go through the gateway.

    **GOV-2: Replace `as Record<string, unknown>` cast in sessions.ts**

    In `app/server/sessions.ts`, add an import for the `SessionStatus` type:
    ```typescript
    import type { SessionStatus } from "../shared/engine-types"
    ```

    Change line 143 from:
    ```typescript
    const statusMap = unwrapSdkResult(result) as Record<string, unknown>
    ```
    to:
    ```typescript
    const statusMap = unwrapSdkResult(result) as Record<string, SessionStatus>
    ```

    Also add type assertion to line 150 — change:
    ```typescript
    return JSON.parse(JSON.stringify(status))
    ```
    to:
    ```typescript
    return JSON.parse(JSON.stringify(status)) as SessionStatus
    ```

    **GOV-3: Add type assertion to JSON roundtrip in getSessionMessagesFn**

    In `app/server/sessions.ts`, add imports for `Message` and `Part` types (extend the existing import):
    ```typescript
    import type { SessionStatus, Message, Part } from "../shared/engine-types"
    ```

    Change lines 107-108 from:
    ```typescript
    validateMessages(messages)
    return JSON.parse(JSON.stringify(messages))
    ```
    to:
    ```typescript
    validateMessages(messages)
    return JSON.parse(JSON.stringify(messages)) as Array<{ info: Message; parts: Part[] }>
    ```

    **Why `as` type assertions are acceptable here:** The JSON roundtrip is required for TanStack Start serialization compatibility (SDK types use `unknown` in index signatures). The Zod validation (`validateMessages`, `validateSessionStatus`) already proves the shape. The `as` assertions restore the type information that JSON roundtrip erases — they don't bypass type safety, they restore it after serialization.
  </action>
  <verify>
    Run `npm run typecheck:app` — must pass with zero errors.
    Verify with grep: `grep -r "from.*@opencode-ai/sdk" app/ --include="*.ts" --include="*.tsx"` should show only `engine-types.ts` and `sdk-client.server.ts` — no other files should import directly from the SDK.
  </verify>
  <done>
    All app/ SDK type imports go through engine-types.ts gateway. No `Record<string, unknown>` casts on SDK types in sessions.ts. All JSON roundtrips have type assertions restoring type information. `npm run typecheck:app` passes clean.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix documentation drift and stale package.json entry point</name>
  <files>CLAUDE.md, AGENTS.md, package.json</files>
  <action>
    **DRIFT-2: Update test baselines in CLAUDE.md and AGENTS.md**

    Actual test output (verified in research): 10 suites, 591 countable assertions (65+89+54+44+52+56+112+40+79).

    In `CLAUDE.md`, find the testing section and update:
    - Change `**Current baseline:** 10 suites, ~512 assertions.` to `**Current baseline:** 10 suites, 591 assertions.`

    In `AGENTS.md`, update both test baseline references:
    - Change `**Test baseline:** \`npm test\` → **512 assertions** across **10** test suites` to `**Test baseline:** \`npm test\` → **591 assertions** across **10** test suites`
    - Change `npm test             # 10 test suites via tsx (466 core assertions; SQLite-dependent assertions are conditional)` to `npm test             # 10 test suites via tsx (591 assertions; SQLite-dependent assertions are conditional)`

    **CONFIG-1: Remove stale package.json entry point fields**

    In `package.json`, remove three fields that reference the archived `src/index.ts`:
    - Remove line `"main": "dist/index.js",` (line 6)
    - Remove line `"types": "dist/index.d.ts",` (line 7)
    - Remove the entire `"exports"` block (lines 11-15):
      ```json
      "exports": {
        ".": {
          "import": "./dist/index.js",
          "types": "./dist/index.d.ts"
        }
      },
      ```

    The `bin` field for CLI usage (`"idumb-v2": "./bin/cli.mjs"`) is preserved and unaffected. idumb-v2 is consumed only via CLI, not as a library import.

    **CONFIG-2: No action (accepted as harmless)**

    The phantom `@opencode-ai/plugin` in `package-lock.json` comes from `hivemind-context-governance`'s non-optional peer dependency. This is a lockfile artifact, not a build or runtime issue. No change needed.
  </action>
  <verify>
    Run `npm run build` (src/ build) — must succeed without entry point errors.
    Run `npm test` — must pass all 10 suites. Count in output should match 591.
    Verify CLAUDE.md mentions "591 assertions" (search the file).
    Verify AGENTS.md mentions "591 assertions" (search the file).
    Verify `package.json` has no `"main"`, `"types"`, or `"exports"` fields (only `"bin"` remains for CLI).
  </verify>
  <done>
    CLAUDE.md and AGENTS.md test baselines match actual npm test output (591 assertions). package.json no longer references archived src/index.ts via main/types/exports fields. CLI entry point (bin) is preserved.
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete, run the full verification suite:

1. `npm run build:app` — production build succeeds (client + SSR)
2. `npm run typecheck:app` — zero errors
3. `npm run build` — src/ build succeeds
4. `npm test` — 10 suites pass, 591 assertions
5. `grep -r "from.*@opencode-ai/sdk" app/ --include="*.ts" --include="*.tsx"` — only engine-types.ts and sdk-client.server.ts
6. `grep "@shared" tsconfig.app.json app/vite.config.ts` — no matches (dead alias removed)
7. `grep '"main"' package.json` — no match (entry point removed)

All 7 checks must pass for Phase 11.1 to be complete.
</verification>

<success_criteria>
Phase 11.1 is complete when ALL of these are true:
- `npm run build:app` succeeds without "manualChunks" errors (GAP-1 closed)
- `npm run typecheck:app` passes with zero errors (GAP-2 closed)
- All app/ SDK imports go through engine-types.ts gateway (GOV-1 closed)
- No `as Record<string, unknown>` on SDK types in sessions.ts (GOV-2 closed)
- All JSON roundtrips have type assertions (GOV-3 closed)
- No dead path aliases in tsconfig.app.json or vite.config.ts (DRIFT-1 closed)
- CLAUDE.md and AGENTS.md test baselines say "591 assertions" (DRIFT-2 closed)
- package.json has no main/types/exports fields (CONFIG-1 closed)
- `npm test` passes all 10 suites
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-build-config-blockers/11.1-01-SUMMARY.md`
</output>
