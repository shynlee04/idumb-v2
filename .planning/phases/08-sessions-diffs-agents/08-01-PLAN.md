---
phase: 08-sessions-diffs-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/server/validators.ts
  - app/server/sessions.ts
  - app/hooks/useSession.ts
  - app/components/layout/SessionSidebar.tsx
  - app/components/chat/ChatMessage.tsx
  - app/routes/chat.$sessionId.tsx
  - app/components/chat/ChatMessages.tsx
autonomous: true

must_haves:
  truths:
    - "User can search sessions by title in the sidebar"
    - "User can rename a session via inline edit in the sidebar"
    - "User can trigger auto-title generation on a session"
    - "User can revert a session to any previous message"
    - "User can unrevert (restore) a reverted session"
    - "Revert checkpoint indicator appears in the conversation at the revert point"
    - "Unrevert button appears when session is in reverted state"
  artifacts:
    - path: "app/server/validators.ts"
      provides: "Zod schemas for rename, summarize, revert input validation"
      contains: "RenameSessionSchema"
    - path: "app/server/sessions.ts"
      provides: "Server functions wrapping SDK session.update, session.summarize, session.revert, session.unrevert"
      exports: ["renameSessionFn", "summarizeSessionFn", "revertSessionFn", "unrevertSessionFn"]
    - path: "app/hooks/useSession.ts"
      provides: "React Query mutation hooks for session management"
      exports: ["useRenameSession", "useSummarizeSession", "useRevertSession", "useUnrevertSession"]
    - path: "app/components/layout/SessionSidebar.tsx"
      provides: "Session list with search, inline rename, auto-title, revert indicators"
      min_lines: 120
    - path: "app/components/chat/ChatMessage.tsx"
      provides: "ChatMessageData interface extended with messageId field"
      contains: "messageId"
    - path: "app/components/chat/ChatMessages.tsx"
      provides: "RevertCheckpoint component rendered at revert point"
      contains: "RevertCheckpoint"
    - path: "app/routes/chat.$sessionId.tsx"
      provides: "Session detail fetch for revert state, revert/unrevert handlers"
      contains: "useSession"
  key_links:
    - from: "app/components/layout/SessionSidebar.tsx"
      to: "app/hooks/useSession.ts"
      via: "useRenameSession, useSummarizeSession"
      pattern: "useRenameSession|useSummarizeSession"
    - from: "app/hooks/useSession.ts"
      to: "app/server/sessions.ts"
      via: "server function imports"
      pattern: "renameSessionFn|summarizeSessionFn|revertSessionFn|unrevertSessionFn"
    - from: "app/server/sessions.ts"
      to: "SDK session API"
      via: "client.session.update, client.session.summarize, client.session.revert, client.session.unrevert"
      pattern: "session\\.(update|summarize|revert|unrevert)"
    - from: "app/routes/chat.$sessionId.tsx"
      to: "app/components/chat/ChatMessages.tsx"
      via: "revertInfo prop"
      pattern: "revertInfo"
---

<objective>
Add full session lifecycle management: search, rename, auto-title, revert, and unrevert.

Purpose: Fulfills CHAT-03 (session CRUD + search + rename + auto-title) and CHAT-04 (revert to any message + unrevert with visual checkpoint indicators). All operations wrap existing SDK APIs through the established server function + React Query pattern.

Output: Extended server layer (4 new server functions), extended hooks (4 new React Query mutations), enhanced SessionSidebar with search/rename/auto-title, and revert checkpoint rendering in chat messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sessions-diffs-agents/08-RESEARCH.md

@app/server/sessions.ts
@app/server/validators.ts
@app/server/sdk-client.server.ts
@app/server/sdk-validators.ts
@app/hooks/useSession.ts
@app/components/layout/SessionSidebar.tsx
@app/components/chat/ChatMessage.tsx
@app/components/chat/ChatMessages.tsx
@app/routes/chat.$sessionId.tsx
@app/shared/engine-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server functions + validators + hooks for rename, summarize, revert, unrevert</name>
  <files>
    app/server/validators.ts
    app/server/sessions.ts
    app/hooks/useSession.ts
  </files>
  <action>
    **1. Add Zod schemas to `app/server/validators.ts`:**

    Add these schemas below the existing `CreateSessionSchema`:

    ```typescript
    /** Validate session rename input. */
    export const RenameSessionSchema = z.object({
      id: z.string().min(1, "Session ID is required"),
      title: z.string().min(1, "Title is required").max(200, "Title too long"),
    })

    /** Validate session summarize (auto-title) input. */
    export const SummarizeSessionSchema = z.object({
      id: z.string().min(1, "Session ID is required"),
      providerID: z.string().optional(),
      modelID: z.string().optional(),
    })

    /** Validate session revert input. */
    export const RevertSessionSchema = z.object({
      id: z.string().min(1, "Session ID is required"),
      messageID: z.string().min(1, "Message ID is required"),
      partID: z.string().optional(),
    })
    ```

    **2. Add server functions to `app/server/sessions.ts`:**

    Import the new schemas alongside existing imports. Add these 4 server functions after the existing `getSessionChildrenFn`:

    - `renameSessionFn` (POST): Uses `client.session.update({ path: { id }, body: { title } })`. Returns `validateSession(unwrapSdkResult(result))`.

    - `summarizeSessionFn` (POST): Uses `client.session.summarize({ path: { id }, body: data.modelID ? { providerID: data.providerID!, modelID: data.modelID } : undefined })`. Returns `unwrapSdkResult(result)` (boolean). Falls back to no body if model not provided.

    - `revertSessionFn` (POST): Uses `client.session.revert({ path: { id }, body: { messageID: data.messageID, ...(data.partID ? { partID: data.partID } : {}) } })`. Returns `validateSession(unwrapSdkResult(result))`.

    - `unrevertSessionFn` (POST): Uses `client.session.unrevert({ path: { id } })`. Reuses `SessionIdSchema` for input. Returns `validateSession(unwrapSdkResult(result))`.

    All server functions follow the try/catch + descriptive error pattern used by existing functions. Use `sdkQuery(getProjectDir())` in query params where the SDK method requires it.

    **3. Add React Query hooks to `app/hooks/useSession.ts`:**

    Import the 4 new server functions. Add these hooks after the existing `useAbortSession`:

    - `useRenameSession()`: useMutation wrapping `renameSessionFn`. On success, invalidate `sessionKeys.detail(id)` and `sessionKeys.lists()`.

    - `useSummarizeSession()`: useMutation wrapping `summarizeSessionFn`. On success, invalidate `sessionKeys.detail(id)` and `sessionKeys.lists()` (title changes after summarize).

    - `useRevertSession()`: useMutation wrapping `revertSessionFn`. On success, invalidate `sessionKeys.detail(id)` AND `sessionKeys.messages(id)` (message list changes after revert).

    - `useUnrevertSession()`: useMutation wrapping `unrevertSessionFn`. On success, invalidate `sessionKeys.detail(id)` AND `sessionKeys.messages(id)`.

    Each hook uses `useQueryClient()` for invalidation, matching the pattern of existing hooks.
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. All 4 server functions are exported from sessions.ts
    3. All 4 hooks are exported from useSession.ts
    4. All 3 new schemas are exported from validators.ts
  </verify>
  <done>
    Server layer complete: renameSessionFn, summarizeSessionFn, revertSessionFn, unrevertSessionFn are callable from client hooks. Input validation via Zod schemas. Query invalidation correctly targets session detail + messages on revert/unrevert.
  </done>
</task>

<task type="auto">
  <name>Task 2: SessionSidebar search/rename/auto-title + ChatMessageData messageId + revert checkpoint UI</name>
  <files>
    app/components/chat/ChatMessage.tsx
    app/components/layout/SessionSidebar.tsx
    app/routes/chat.$sessionId.tsx
    app/components/chat/ChatMessages.tsx
  </files>
  <action>
    **1. Add `messageId` to `ChatMessageData` in `app/components/chat/ChatMessage.tsx`:**

    Update the ChatMessageData interface to include messageId for revert point matching:
    ```typescript
    export interface ChatMessageData {
      role: "user" | "assistant"
      content?: string
      parts?: Part[]
      messageId?: string    // SDK Message.id â€” used for revert point matching
    }
    ```

    No other changes to ChatMessage.tsx in this task.

    **2. Extend `app/components/layout/SessionSidebar.tsx`:**

    Add these features to the existing SessionSidebar:

    **Search:** Add a search input below the header (above the IDE Shell link). Use controlled state (`searchQuery`). Filter sessions with `useMemo`:
    ```typescript
    const filteredSessions = useMemo(() => {
      if (!searchQuery.trim()) return sessions
      const q = searchQuery.toLowerCase()
      return sessions?.filter(s =>
        (s.title || '').toLowerCase().includes(q) ||
        s.id.toLowerCase().includes(q)
      )
    }, [sessions, searchQuery])
    ```
    Import `Search` icon from lucide-react. Render `<Search className="w-3.5 h-3.5" />` inside the input as a prefix icon. Use `filteredSessions` instead of `sessions` in the map.

    **Inline Rename:** Add state `editingId` and `editTitle`. When user double-clicks on a session title, set `editingId = session.id` and `editTitle = session.title`. Replace the span with an input:
    ```tsx
    {editingId === session.id ? (
      <input
        type="text"
        value={editTitle}
        onChange={e => setEditTitle(e.target.value)}
        onBlur={() => commitRename(session.id)}
        onKeyDown={e => {
          if (e.key === 'Enter') commitRename(session.id)
          if (e.key === 'Escape') setEditingId(null)
        }}
        autoFocus
        className="flex-1 bg-transparent border-b border-primary text-sm outline-none"
      />
    ) : (
      <span
        onDoubleClick={() => { setEditingId(session.id); setEditTitle(session.title || '') }}
        className="flex-1 truncate"
      >
        {session.title || `Session ${session.id.slice(0, 8)}`}
      </span>
    )}
    ```
    `commitRename` calls `renameSession.mutate({ id, title: editTitle })` and sets `editingId = null`.

    Import `useRenameSession` and `useSummarizeSession` from `@/hooks/useSession`.

    **Auto-title:** Add a `Sparkles` icon button (from lucide-react) next to each session that calls `summarizeSession.mutate({ id: session.id })`. Show `Loader2 animate-spin` while pending. Only show the button on hover (same `group-hover:opacity-100` pattern as delete button).

    **Revert indicator:** If `session.revert` is truthy (SDK Session type has `revert?: { messageID, ... }`), show a small `RotateCcw` icon (from lucide-react) next to the session icon in muted amber color (`text-amber-500/70`).

    **3. Extend `app/routes/chat.$sessionId.tsx`:**

    In the `ChatSession` component:

    - Import `useSession`, `useRevertSession`, `useUnrevertSession` from hooks
    - Add `const { data: sessionDetail } = useSession(sessionId)` to fetch session detail
    - Derive `revertInfo` from session detail:
      ```typescript
      const revertInfo = useMemo(() => {
        if (!sessionDetail?.revert) return null
        return {
          messageID: sessionDetail.revert.messageID,
          partID: sessionDetail.revert.partID,
        }
      }, [sessionDetail])
      ```
    - Create handlers:
      ```typescript
      const revertSession = useRevertSession()
      const unrevertSession = useUnrevertSession()
      const handleRevert = (messageID: string) => revertSession.mutate({ id: sessionId, messageID })
      const handleUnrevert = () => unrevertSession.mutate(sessionId)
      ```
    - Pass `revertInfo`, `onRevert={handleRevert}`, and `onUnrevert={handleUnrevert}` props to `<ChatMessages>`.
    - In `historyMessages` mapping, add `messageId: item.info.id`.

    **4. Extend `app/components/chat/ChatMessages.tsx`:**

    Update `ChatMessagesProps` to accept revert props:
    ```typescript
    interface ChatMessagesProps {
      messages: ChatMessageData[]
      streaming?: boolean
      revertInfo?: { messageID: string; partID?: string } | null
      onRevert?: (messageID: string) => void
      onUnrevert?: () => void
    }
    ```

    Add a `RevertCheckpoint` component (defined in the same file):
    ```typescript
    function RevertCheckpoint({ onUnrevert }: { onUnrevert?: () => void }) {
      return (
        <div className="flex items-center gap-2 px-4 py-2 my-2 bg-amber-500/10 border border-amber-500/30 rounded-md">
          <RotateCcw className="w-4 h-4 text-amber-500" />
          <span className="text-xs text-amber-500 font-medium">
            Session reverted to this point
          </span>
          {onUnrevert && (
            <button
              onClick={onUnrevert}
              className="ml-auto text-xs text-amber-500 hover:text-amber-400 underline"
            >
              Restore messages
            </button>
          )}
        </div>
      )
    }
    ```

    Import `RotateCcw` from lucide-react.

    In the message rendering loop, after rendering each message, check if `revertInfo?.messageID === msg.messageId`. If so, render `<RevertCheckpoint onUnrevert={onUnrevert} />`.

    Additionally, add a "Revert to here" context action to each user message. Add a small `RotateCcw` button that appears on hover (same opacity pattern) next to each message. Clicking calls `onRevert?.(msg.messageId)`. Only show on user messages that have a messageId.
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. SessionSidebar renders search input and filters sessions by title
    3. Double-clicking a session title shows inline edit input
    4. Auto-title button (Sparkles icon) is visible on session hover
    5. Revert checkpoint indicator renders in the correct position in the message list
    6. `npm run build:app` succeeds (client + SSR)
  </verify>
  <done>
    SessionSidebar has search, inline rename, auto-title. ChatMessageData extended with messageId. Chat messages show revert checkpoint with unrevert button. Users can revert to any message and restore. Visual indicators distinguish reverted sessions in the sidebar.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` -- zero errors
2. `npm run build:app` -- client + SSR build succeeds
3. All 4 new server functions callable
4. All 4 new hooks exported and correctly invalidate queries
5. SessionSidebar: search filters, rename saves, auto-title triggers summarize
6. Revert checkpoint renders at the correct message position
7. Unrevert button restores messages
</verification>

<success_criteria>
- User can search sessions by typing in sidebar search input
- User can rename a session by double-clicking its title, editing, and pressing Enter
- User can auto-generate a title via the sparkles button
- User can revert to any message via hover button, sees checkpoint indicator
- User can unrevert (restore) via the checkpoint's "Restore messages" button
- Sessions with active revert show amber indicator in sidebar
- All operations use SDK APIs through server functions (no hand-rolled logic)
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-diffs-agents/08-01-SUMMARY.md`
</output>
