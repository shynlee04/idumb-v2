---
phase: 08-sessions-diffs-agents
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/components/chat/ChatMessage.tsx
  - app/components/chat/parts/AgentBadge.tsx
  - app/components/chat/parts/SubtaskCard.tsx
  - app/components/chat/AgentFlowView.tsx
  - app/routes/chat.$sessionId.tsx
autonomous: true

must_haves:
  truths:
    - "User sees which agent authored each message via a colored badge with icon"
    - "User sees agent switch notifications as visual dividers between message sections"
    - "User sees delegation events as expandable subtask cards showing agent, prompt, and description"
    - "User sees child sessions (parallel agent runs) listed with links to view each"
    - "Unknown agents display gracefully with generic icon and raw name"
  artifacts:
    - path: "app/components/chat/parts/AgentBadge.tsx"
      provides: "Agent attribution badge with icon and color"
      exports: ["AgentBadge", "AGENT_DISPLAY"]
      min_lines: 30
    - path: "app/components/chat/parts/SubtaskCard.tsx"
      provides: "Delegation card showing delegated agent, prompt, and description"
      exports: ["SubtaskCard"]
      min_lines: 30
    - path: "app/components/chat/ChatMessage.tsx"
      provides: "Extended PartRenderer with AgentBadge and SubtaskCard for agent/subtask parts"
      contains: "AgentBadge"
    - path: "app/components/chat/AgentFlowView.tsx"
      provides: "Parallel agent flow component rendering child session summaries"
      exports: ["AgentFlowView"]
      min_lines: 40
    - path: "app/routes/chat.$sessionId.tsx"
      provides: "Child session detection and AgentFlowView integration"
      contains: "AgentFlowView"
  key_links:
    - from: "app/components/chat/ChatMessage.tsx"
      to: "app/components/chat/parts/AgentBadge.tsx"
      via: "PartRenderer case 'agent'"
      pattern: "case .agent."
    - from: "app/components/chat/ChatMessage.tsx"
      to: "app/components/chat/parts/SubtaskCard.tsx"
      via: "PartRenderer case 'subtask'"
      pattern: "case .subtask."
    - from: "app/components/chat/AgentFlowView.tsx"
      to: "app/hooks/useSession.ts"
      via: "useSessionChildren hook"
      pattern: "useSessionChildren"
    - from: "app/routes/chat.$sessionId.tsx"
      to: "app/components/chat/AgentFlowView.tsx"
      via: "conditional render when children exist"
      pattern: "AgentFlowView"
---

<objective>
Add multi-agent operation visualization and agent attribution to chat messages.

Purpose: Fulfills CHAT-06 (multi-agent operations with sequential/parallel flow and status indicators), DF-01 (agent badges/avatars with delegation annotations), and DF-06 (parallel agent split view). Uses SDK Part types (`AgentPart`, `SubtaskPart`) and `session.children()` for agent detection — no hand-rolled agent parsing.

Output: AgentBadge component for per-message attribution, SubtaskCard for delegation flow, AgentFlowView for parallel agent runs via child sessions, and updated PartRenderer to render agent/subtask parts instead of returning null.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sessions-diffs-agents/08-RESEARCH.md
@.planning/phases/08-sessions-diffs-agents/08-01-SUMMARY.md

@app/components/chat/ChatMessage.tsx
@app/components/chat/ChatMessages.tsx
@app/components/chat/StepCluster.tsx
@app/hooks/useSession.ts
@app/routes/chat.$sessionId.tsx
@app/shared/engine-types.ts
@app/server/sdk-validators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AgentBadge + SubtaskCard components + extend PartRenderer</name>
  <files>
    app/components/chat/parts/AgentBadge.tsx
    app/components/chat/parts/SubtaskCard.tsx
    app/components/chat/ChatMessage.tsx
  </files>
  <action>
    **1. Create `app/components/chat/parts/AgentBadge.tsx`:**

    Agent attribution badge component with icon, color, and label. Provides a configurable display mapping for known agents with graceful fallback for unknown ones.

    ```typescript
    /**
     * AgentBadge — displays agent name with colored icon.
     *
     * Used in two contexts:
     * 1. As an inline badge within chat messages (agent field on UserMessage)
     * 2. As an agent switch divider (AgentPart type in Part union)
     *
     * Agent identification strategy:
     * - Known agents: mapped to specific icons and colors
     * - Unknown agents: generic icon with raw name displayed
     * - Agents fetched dynamically via agent.list() can be added to AGENT_DISPLAY
     */
    ```

    Export a `AGENT_DISPLAY` config record:
    ```typescript
    import { Crown, Code2, Search, User, Bot, Zap } from 'lucide-react'
    import type { LucideIcon } from 'lucide-react'
    import { cn } from '@/lib/utils'

    interface AgentConfig {
      label: string
      icon: LucideIcon
      color: string        // Tailwind text color class
      bgColor: string      // Tailwind bg color class (for badge background)
    }

    export const AGENT_DISPLAY: Record<string, AgentConfig> = {
      'default': { label: 'AI', icon: Bot, color: 'text-primary', bgColor: 'bg-primary/10' },
      'supreme-coordinator': { label: 'Coordinator', icon: Crown, color: 'text-amber-500', bgColor: 'bg-amber-500/10' },
      'coordinator': { label: 'Coordinator', icon: Crown, color: 'text-amber-500', bgColor: 'bg-amber-500/10' },
      'investigator': { label: 'Investigator', icon: Search, color: 'text-blue-500', bgColor: 'bg-blue-500/10' },
      'executor': { label: 'Executor', icon: Code2, color: 'text-green-500', bgColor: 'bg-green-500/10' },
      'coding-agent': { label: 'Coder', icon: Code2, color: 'text-green-500', bgColor: 'bg-green-500/10' },
    }

    function getAgentConfig(agentName: string): AgentConfig {
      return AGENT_DISPLAY[agentName] ?? {
        label: agentName,
        icon: Zap,
        color: 'text-muted-foreground',
        bgColor: 'bg-muted',
      }
    }
    ```

    Export `AgentBadge` component in two variants:

    **Inline badge** (small, for next to role indicators):
    ```typescript
    interface AgentBadgeProps {
      agentName: string
      variant?: 'inline' | 'divider'
    }

    export function AgentBadge({ agentName, variant = 'inline' }: AgentBadgeProps) {
      const config = getAgentConfig(agentName)
      const Icon = config.icon

      if (variant === 'divider') {
        // Full-width divider with agent name — used for AgentPart
        return (
          <div className="flex items-center gap-2 py-1.5 my-1">
            <div className="h-px flex-1 bg-border" />
            <span className={cn("inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium", config.color, config.bgColor)}>
              <Icon className="w-3 h-3" />
              {config.label}
            </span>
            <div className="h-px flex-1 bg-border" />
          </div>
        )
      }

      // Inline badge — small pill next to role indicator
      return (
        <span className={cn("inline-flex items-center gap-1 text-xs font-medium", config.color)}>
          <Icon className="w-3 h-3" />
          {config.label}
        </span>
      )
    }
    ```

    **2. Create `app/components/chat/parts/SubtaskCard.tsx`:**

    Delegation flow card showing the delegated agent, description, and prompt:

    ```typescript
    /**
     * SubtaskCard — renders a delegation event (SubtaskPart).
     *
     * Shows which agent was delegated to, why (description), and what
     * they were asked to do (prompt). Expandable to show the full prompt.
     */
    import { useState } from 'react'
    import { ArrowRight, ChevronDown, ChevronRight } from 'lucide-react'
    import { cn } from '@/lib/utils'
    import { AgentBadge } from './AgentBadge'

    interface SubtaskCardProps {
      agent: string
      description: string
      prompt: string
    }

    export function SubtaskCard({ agent, description, prompt }: SubtaskCardProps) {
      const [expanded, setExpanded] = useState(false)

      return (
        <div className="my-2 rounded-lg border border-border bg-muted/30 overflow-hidden">
          <button
            onClick={() => setExpanded(v => !v)}
            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-left hover:bg-accent/30 transition-colors"
          >
            <ArrowRight className="w-3.5 h-3.5 text-muted-foreground flex-shrink-0" />
            <span className="text-muted-foreground">Delegated to</span>
            <AgentBadge agentName={agent} />
            <span className="flex-1 truncate text-muted-foreground">— {description}</span>
            {expanded ? (
              <ChevronDown className="w-3.5 h-3.5 text-muted-foreground flex-shrink-0" />
            ) : (
              <ChevronRight className="w-3.5 h-3.5 text-muted-foreground flex-shrink-0" />
            )}
          </button>
          {expanded && (
            <div className="px-3 pb-2 border-t border-border">
              <div className="mt-2">
                <span className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Prompt</span>
                <pre className="mt-1 text-xs text-foreground/80 whitespace-pre-wrap font-mono bg-background/50 p-2 rounded">
                  {prompt}
                </pre>
              </div>
            </div>
          )}
        </div>
      )
    }
    ```

    **3. Extend `app/components/chat/ChatMessage.tsx`:**

    Update the `PartRenderer` function to render `agent` and `subtask` parts instead of returning null:

    - Import `AgentBadge` from `./parts/AgentBadge`
    - Import `SubtaskCard` from `./parts/SubtaskCard`

    Change the PartRenderer switch cases:

    ```typescript
    case "agent":
      // Agent switch notification — render as divider badge
      return <AgentBadge agentName={part.name} variant="divider" />

    case "subtask":
      // Delegation event — render as expandable card
      return (
        <SubtaskCard
          agent={part.agent}
          description={part.description}
          prompt={part.prompt}
        />
      )
    ```

    Also update the `ChatMessage` component to show an inline agent badge next to the role indicator when the message has agent attribution. The ChatMessageData type needs an optional `agent` field:

    Update the `ChatMessageData` interface:
    ```typescript
    export interface ChatMessageData {
      role: "user" | "assistant"
      content?: string
      parts?: Part[]
      messageId?: string    // Added in 08-01 for revert
      agent?: string        // Agent name for attribution (from UserMessage.agent or message context)
    }
    ```

    In the ChatMessage component, render the agent badge next to the role indicator:
    ```tsx
    <div className="flex-shrink-0 flex items-center gap-1.5 mt-1 min-w-[2.5rem]">
      <span className={cn("w-1.5 h-1.5 rounded-full flex-shrink-0", isUser ? "bg-muted-foreground" : "bg-primary")} />
      <span className="text-xs font-medium text-muted-foreground">
        {isUser ? "You" : "AI"}
      </span>
      {message.agent && <AgentBadge agentName={message.agent} />}
    </div>
    ```

    This badge appears as a small inline pill showing which agent is associated with each message.
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. AgentBadge renders in both inline and divider variants
    3. SubtaskCard renders collapsed by default, expandable on click
    4. PartRenderer no longer returns null for "agent" and "subtask" parts
    5. Agent badge appears next to role indicator when message.agent is set
  </verify>
  <done>
    Agent attribution components complete: AgentBadge (inline + divider), SubtaskCard (expandable delegation card). PartRenderer renders agent switch dividers and delegation cards. ChatMessage shows inline agent badge when attribution data exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: AgentFlowView + wire agent attribution into chat route</name>
  <files>
    app/components/chat/AgentFlowView.tsx
    app/routes/chat.$sessionId.tsx
  </files>
  <action>
    **1. Create `app/components/chat/AgentFlowView.tsx`:**

    Component that displays parallel agent runs (child sessions) and provides navigation to view each child session's conversation:

    ```typescript
    /**
     * AgentFlowView — displays child sessions as parallel agent operations.
     *
     * When a session has children (from session.children()), each child represents
     * a parallel agent run. This component renders them as a compact list with
     * agent attribution and status, allowing users to click into any child session.
     *
     * Detection logic:
     * - Sequential: AgentPart appears within a single session's parts → handled by PartRenderer
     * - Parallel: session.children() returns Session[] → handled by this component
     */
    import { Link } from '@tanstack/react-router'
    import { GitBranch, ExternalLink, Clock } from 'lucide-react'
    import { cn } from '@/lib/utils'
    import { AgentBadge, AGENT_DISPLAY } from './parts/AgentBadge'
    import type { Session } from '@/shared/engine-types'

    interface AgentFlowViewProps {
      children: Session[]
      parentSessionId: string
    }

    export function AgentFlowView({ children, parentSessionId }: AgentFlowViewProps) {
      if (children.length === 0) return null

      return (
        <div className="my-3 rounded-lg border border-border bg-muted/20 overflow-hidden">
          {/* Header */}
          <div className="flex items-center gap-2 px-3 py-2 border-b border-border bg-muted/30">
            <GitBranch className="w-3.5 h-3.5 text-muted-foreground" />
            <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wide">
              Parallel Agent Runs ({children.length})
            </span>
          </div>

          {/* Child session list */}
          <div className="divide-y divide-border">
            {children.map(child => {
              const agentName = inferAgentFromSession(child)
              const elapsed = child.time.updated - child.time.created
              const elapsedStr = elapsed > 0 ? formatDuration(elapsed) : null

              return (
                <Link
                  key={child.id}
                  to="/chat/$sessionId"
                  params={{ sessionId: child.id }}
                  className="flex items-center gap-3 px-3 py-2.5 hover:bg-accent/30 transition-colors group"
                >
                  <AgentBadge agentName={agentName} />
                  <div className="flex-1 min-w-0">
                    <div className="text-sm truncate">
                      {child.title || `Agent run ${child.id.slice(0, 8)}`}
                    </div>
                    {child.summary && (
                      <div className="text-xs text-muted-foreground mt-0.5">
                        {child.summary.files} file{child.summary.files !== 1 ? 's' : ''} changed
                        {child.summary.additions > 0 && (
                          <span className="text-green-500 ml-1">+{child.summary.additions}</span>
                        )}
                        {child.summary.deletions > 0 && (
                          <span className="text-red-500 ml-1">-{child.summary.deletions}</span>
                        )}
                      </div>
                    )}
                  </div>
                  {elapsedStr && (
                    <span className="text-xs text-muted-foreground flex items-center gap-1">
                      <Clock className="w-3 h-3" />
                      {elapsedStr}
                    </span>
                  )}
                  <ExternalLink className="w-3.5 h-3.5 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity" />
                </Link>
              )
            })}
          </div>
        </div>
      )
    }

    /**
     * Infer agent name from a child session.
     * Child sessions are created by agent delegation — the title or ID often contains
     * the agent name. Falls back to 'default'.
     */
    function inferAgentFromSession(session: Session): string {
      // Check if title matches a known agent name
      const title = (session.title || '').toLowerCase()
      for (const agentKey of Object.keys(AGENT_DISPLAY)) {
        if (title.includes(agentKey)) return agentKey
      }
      return 'default'
    }

    /** Format epoch millisecond duration to human-readable string. */
    function formatDuration(ms: number): string {
      const seconds = Math.round(ms / 1000)
      if (seconds < 60) return `${seconds}s`
      const minutes = Math.floor(seconds / 60)
      const secs = seconds % 60
      return `${minutes}m ${secs}s`
    }
    ```

    **2. Extend `app/routes/chat.$sessionId.tsx`:**

    Wire agent attribution and AgentFlowView into the chat session:

    a) Import `useSessionChildren` from hooks (already exists in useSession.ts), `AgentFlowView` from components.

    b) In the `ChatSession` component, add child session detection:
    ```typescript
    const { data: childSessions } = useSessionChildren(sessionId)
    ```

    c) Update `historyMessages` mapping to include agent attribution. The SDK's message response is `Array<{ info: Message; parts: Part[] }>`. The `info` object has `role: "user" | "assistant"`. For UserMessage, there may be an `agent` field. Extract it:

    ```typescript
    const historyMessages = useMemo<ChatMessageData[]>(() => {
      if (!serverMessages) return []
      const items = Array.isArray(serverMessages) ? serverMessages : []
      return (items as Array<{ info: Message; parts: Part[] }>).map((item) => ({
        role: item.info.role,
        parts: item.parts,
        messageId: item.info.id,
        // Agent attribution: UserMessage has an optional 'agent' field
        agent: 'agent' in item.info ? (item.info as Record<string, unknown>).agent as string | undefined : undefined,
      }))
    }, [serverMessages])
    ```

    Note: The SDK's UserMessage type may or may not have `agent` typed. Use runtime check `'agent' in item.info` since the field is present at runtime per SDK contract even if not in our re-exported types. If it's not present, `agent` will be undefined and the badge won't render.

    d) Render the AgentFlowView after the ChatMessages and before ChatInput, conditionally when child sessions exist:

    ```tsx
    return (
      <div className="flex-1 flex flex-col min-h-0">
        <ChatMessages
          messages={allMessages}
          streaming={isStreaming}
          revertInfo={revertInfo}
          onRevert={handleRevert}
          onUnrevert={handleUnrevert}
        />
        {childSessions && childSessions.length > 0 && (
          <div className="px-4 pb-2">
            <AgentFlowView children={childSessions} parentSessionId={sessionId} />
          </div>
        )}
        <ChatInput
          onSend={handleSend}
          onAbort={abort}
          streaming={isStreaming}
        />
      </div>
    )
    ```

    The AgentFlowView sits between messages and input, providing a clear visual separation for parallel agent runs. It only renders when the session actually has child sessions.

    e) Re-export the updated `ChatMessageData` interface from ChatMessage.tsx now includes `agent?: string` (added in Task 1). No additional changes needed here since the interface is imported by chat.$sessionId.tsx.
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. `npm run build:app` succeeds (client + SSR)
    3. AgentBadge divider renders between agent sections in messages
    4. SubtaskCard renders as expandable delegation card
    5. AgentFlowView renders child sessions when present
    6. Child session links navigate to the child session chat
    7. Agent attribution badge appears inline when message has agent data
    8. Unknown agents show with generic icon and raw name
  </verify>
  <done>
    Multi-agent visualization complete: sequential agent runs show divider badges, delegations show expandable cards, parallel runs show child session list with navigation. Agent attribution data flows from SDK UserMessage.agent through the message rendering pipeline.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — client + SSR build succeeds
3. AgentPart renders as a divider (not null) in message stream
4. SubtaskPart renders as an expandable delegation card (not null)
5. Agent badge appears next to role indicator when attribution data exists
6. AgentFlowView renders child sessions with agent badges
7. Clicking a child session navigates to its chat view
8. Unknown agents display gracefully (generic icon, raw name)
</verification>

<success_criteria>
- User sees agent switch dividers between sections of different agents
- User sees delegation cards showing target agent, description, and expandable prompt
- User sees inline agent badge next to message role when attribution data exists
- User sees parallel agent runs in a compact list with file change summaries
- User can click a parallel agent run to navigate to its session
- All known agents (coordinator, investigator, executor) show distinct icons/colors
- Unknown agents fall back to generic display without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-diffs-agents/08-03-SUMMARY.md`
</output>
