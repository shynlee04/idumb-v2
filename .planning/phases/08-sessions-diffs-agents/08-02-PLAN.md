---
phase: 08-sessions-diffs-agents
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/server/diffs.ts
  - app/hooks/useSessionDiff.ts
  - app/stores/diff-store.ts
  - app/components/diff/DiffViewer.tsx
  - app/components/diff/DiffEditor.lazy.tsx
  - app/components/diff/FileChangeList.tsx
  - app/components/diff/DiffToolbar.tsx
  - app/routes/chat.tsx
  - app/shared/engine-types.ts
autonomous: true

must_haves:
  truths:
    - "User can view a list of files changed in the current session"
    - "User can click a file to see its diff in Monaco DiffEditor"
    - "User can toggle between inline and side-by-side diff modes"
    - "DiffEditor disposes properly on unmount (memory leak mitigation)"
    - "DiffEditor is SSR-safe (no window reference crash during prerender)"
    - "User can switch between Chat and Changes views in the session layout"
  artifacts:
    - path: "app/server/diffs.ts"
      provides: "Server function wrapping SDK session.diff()"
      exports: ["getSessionDiffFn"]
    - path: "app/hooks/useSessionDiff.ts"
      provides: "React Query hook for diff data"
      exports: ["useSessionDiff", "diffKeys"]
    - path: "app/stores/diff-store.ts"
      provides: "Zustand store for selected file and view mode"
      exports: ["useDiffStore"]
    - path: "app/components/diff/DiffViewer.tsx"
      provides: "Main diff viewer with file list + DiffEditor"
      min_lines: 80
    - path: "app/components/diff/DiffEditor.lazy.tsx"
      provides: "SSR-safe lazy DiffEditor wrapper"
      contains: "typeof window"
    - path: "app/components/diff/FileChangeList.tsx"
      provides: "Sidebar list of changed files with additions/deletions counts"
      min_lines: 30
    - path: "app/components/diff/DiffToolbar.tsx"
      provides: "Mode toggle (inline/side-by-side) and file name display"
      min_lines: 20
    - path: "app/routes/chat.tsx"
      provides: "View toggle between Chat and Changes"
      contains: "Changes"
    - path: "app/shared/engine-types.ts"
      provides: "FileDiff app type for diff viewer"
      contains: "FileDiff"
  key_links:
    - from: "app/components/diff/DiffViewer.tsx"
      to: "app/hooks/useSessionDiff.ts"
      via: "useSessionDiff(sessionId)"
      pattern: "useSessionDiff"
    - from: "app/hooks/useSessionDiff.ts"
      to: "app/server/diffs.ts"
      via: "getSessionDiffFn import"
      pattern: "getSessionDiffFn"
    - from: "app/server/diffs.ts"
      to: "SDK session.diff()"
      via: "client.session.diff()"
      pattern: "session\\.diff"
    - from: "app/routes/chat.tsx"
      to: "app/components/diff/DiffEditor.lazy.tsx"
      via: "LazyDiffViewer conditional render"
      pattern: "LazyDiffViewer"
---

<objective>
Build a Monaco DiffEditor-based code diff viewer for reviewing AI-made file changes within a session.

Purpose: Fulfills IDE-04 (diff viewer with inline/side-by-side modes, file change list, click-to-open-diff). Uses the SDK `session.diff()` API which returns full file content (before/after), mapped directly to Monaco DiffEditor's original/modified model pattern. Aggressively mitigates the known DiffEditor memory leak (GitHub #4659) through explicit model disposal.

Output: Complete diff viewing pipeline: server function, React Query hook, Zustand store, 4 new components (DiffViewer, LazyDiffEditor, FileChangeList, DiffToolbar), and a Chat/Changes view toggle in the chat layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sessions-diffs-agents/08-RESEARCH.md

@app/server/sdk-client.server.ts
@app/server/sdk-validators.ts
@app/server/validators.ts
@app/hooks/useSession.ts
@app/stores/ide-store.ts
@app/components/editor/MonacoEditor.tsx
@app/components/editor/MonacoEditor.lazy.tsx
@app/routes/chat.tsx
@app/shared/engine-types.ts
@app/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diff server function + hook + store + FileDiff type</name>
  <files>
    app/shared/engine-types.ts
    app/server/diffs.ts
    app/hooks/useSessionDiff.ts
    app/stores/diff-store.ts
  </files>
  <action>
    **1. Add FileDiff type to `app/shared/engine-types.ts`:**

    Add below the existing app-specific types section (after the `AgentInfo` interface):

    ```typescript
    /** File diff from SDK session.diff() — full content before/after */
    export interface FileDiff {
      file: string        // Relative file path (e.g., "src/main.ts")
      before: string      // Full file content before changes
      after: string       // Full file content after changes
      additions: number   // Lines added
      deletions: number   // Lines deleted
    }
    ```

    This is an app-defined type (no named SDK export for FileDiff exists). The shape matches the SDK session.diff() response and the SessionSchema's summary.diffs field.

    **2. Create `app/server/diffs.ts`:**

    New file. Server function for fetching session diffs:

    ```typescript
    /**
     * Diff server functions — wraps SDK session.diff() for file change viewing.
     */
    import { createServerFn } from "@tanstack/react-start"
    import { z } from "zod"
    import { getClient, getProjectDir, sdkQuery, unwrapSdkResult } from "./sdk-client.server"

    /** Input schema for session diff — inline since only used here. */
    const SessionDiffSchema = z.object({
      id: z.string().min(1, "Session ID is required"),
      messageID: z.string().optional(),
    })

    /** Get file diffs for a session, optionally scoped to a specific message. */
    export const getSessionDiffFn = createServerFn({ method: "GET" })
      .inputValidator(SessionDiffSchema)
      .handler(async ({ data }) => {
        try {
          const projectDir = getProjectDir()
          const result = await getClient().session.diff({
            query: {
              ...sdkQuery(projectDir),
              ...(data.messageID ? { messageID: data.messageID } : {}),
            },
            path: { id: data.id },
          })
          // JSON roundtrip for serialization compat (same pattern as getSessionMessagesFn)
          return JSON.parse(JSON.stringify(unwrapSdkResult(result)))
        } catch (err) {
          throw new Error(`Failed to get session diff: ${err instanceof Error ? err.message : String(err)}`)
        }
      })
    ```

    Follow the exact same pattern as sessions.ts server functions (try/catch, unwrapSdkResult, descriptive error).

    **3. Create `app/hooks/useSessionDiff.ts`:**

    New file. React Query hook for diff data:

    ```typescript
    /**
     * useSessionDiff — React Query hook for session file diffs.
     *
     * Fetches diff data from SDK session.diff() via server function.
     * Diffs are relatively stable so use 30s staleTime.
     */
    import { useQuery } from "@tanstack/react-query"
    import { getSessionDiffFn } from "../server/diffs"
    import type { FileDiff } from "../shared/engine-types"

    export const diffKeys = {
      all: ["session-diffs"] as const,
      session: (id: string) => [...diffKeys.all, id] as const,
      message: (id: string, messageID: string) => [...diffKeys.all, id, messageID] as const,
    }

    export function useSessionDiff(sessionId: string | undefined) {
      return useQuery<FileDiff[]>({
        queryKey: diffKeys.session(sessionId ?? ""),
        queryFn: () => getSessionDiffFn({ data: { id: sessionId! } }),
        enabled: Boolean(sessionId),
        staleTime: 30_000, // Diffs don't change frequently
      })
    }
    ```

    **4. Create `app/stores/diff-store.ts`:**

    New file. Zustand store for diff viewer state (selected file, view mode):

    ```typescript
    /**
     * Diff viewer store — selected file and display mode.
     * Not persisted (transient view state).
     */
    import { create } from "zustand"

    interface DiffStoreState {
      selectedFile: string | null
      sideBySide: boolean
      setSelectedFile: (file: string | null) => void
      toggleSideBySide: () => void
      setSideBySide: (value: boolean) => void
      reset: () => void
    }

    export const useDiffStore = create<DiffStoreState>((set) => ({
      selectedFile: null,
      sideBySide: true,
      setSelectedFile: (file) => set({ selectedFile: file }),
      toggleSideBySide: () => set((s) => ({ sideBySide: !s.sideBySide })),
      setSideBySide: (value) => set({ sideBySide: value }),
      reset: () => set({ selectedFile: null, sideBySide: true }),
    }))
    ```

    No persistence needed — diff view state is transient.
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. `getSessionDiffFn` is exported from diffs.ts
    3. `useSessionDiff` is exported from useSessionDiff.ts
    4. `useDiffStore` is exported from diff-store.ts
    5. `FileDiff` type is exported from engine-types.ts
  </verify>
  <done>
    Diff data pipeline complete: server function wraps SDK session.diff(), React Query hook manages caching with 30s staletime, Zustand store tracks selected file and view mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: DiffViewer components + SSR-safe DiffEditor + chat layout view toggle</name>
  <files>
    app/components/diff/DiffViewer.tsx
    app/components/diff/DiffEditor.lazy.tsx
    app/components/diff/FileChangeList.tsx
    app/components/diff/DiffToolbar.tsx
    app/routes/chat.tsx
  </files>
  <action>
    **1. Create `app/components/diff/DiffEditor.lazy.tsx`:**

    SSR-safe lazy wrapper for DiffViewer, following the exact pattern of `MonacoEditor.lazy.tsx`:

    ```typescript
    /**
     * LazyDiffViewer — SSR-safe lazy wrapper for Monaco DiffEditor.
     *
     * Same pattern as MonacoEditor.lazy.tsx:
     * 1. Returns null on server (typeof window === 'undefined')
     * 2. Uses React.lazy for code-splitting
     * 3. Shows pulse animation while loading
     */
    import { lazy, Suspense } from 'react'

    const DiffViewerInner = lazy(() =>
      import('./DiffViewer').then(m => ({ default: m.DiffViewer }))
    )

    interface LazyDiffViewerProps {
      sessionId: string | undefined
    }

    export function LazyDiffViewer({ sessionId }: LazyDiffViewerProps) {
      if (typeof window === 'undefined') return null
      if (!sessionId) {
        return (
          <div className="flex-1 flex items-center justify-center text-muted-foreground">
            <p className="text-sm">Select a session to view changes</p>
          </div>
        )
      }
      return (
        <Suspense fallback={<div className="h-full bg-zinc-900 animate-pulse" />}>
          <DiffViewerInner sessionId={sessionId} />
        </Suspense>
      )
    }
    ```

    **2. Create `app/components/diff/FileChangeList.tsx`:**

    Sidebar list of changed files:

    ```typescript
    /**
     * FileChangeList — sidebar showing changed files with +/- counts.
     * Click a file to select it for diff viewing.
     */
    import { FileCode, FilePlus, FileMinus, FileX } from 'lucide-react'
    import { cn } from '@/lib/utils'
    import type { FileDiff } from '@/shared/engine-types'

    interface FileChangeListProps {
      diffs: FileDiff[]
      selectedFile: string | null
      onSelectFile: (file: string) => void
    }

    export function FileChangeList({ diffs, selectedFile, onSelectFile }: FileChangeListProps) {
      return (
        <div className="w-56 border-r border-border overflow-y-auto flex-shrink-0">
          <div className="px-3 py-2 border-b border-border">
            <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wide">
              Changed Files ({diffs.length})
            </span>
          </div>
          <div className="py-1">
            {diffs.map(diff => {
              const fileName = diff.file.split('/').pop() ?? diff.file
              const dirPath = diff.file.includes('/') ? diff.file.slice(0, diff.file.lastIndexOf('/')) : ''
              const isNew = !diff.before && diff.after
              const isDeleted = diff.before && !diff.after

              return (
                <button
                  key={diff.file}
                  onClick={() => onSelectFile(diff.file)}
                  className={cn(
                    "w-full text-left px-3 py-1.5 text-sm flex items-center gap-2 transition-colors",
                    selectedFile === diff.file
                      ? "bg-accent text-accent-foreground"
                      : "hover:bg-accent/50 text-foreground"
                  )}
                  title={diff.file}
                >
                  {isNew ? (
                    <FilePlus className="w-3.5 h-3.5 text-green-500 flex-shrink-0" />
                  ) : isDeleted ? (
                    <FileX className="w-3.5 h-3.5 text-red-500 flex-shrink-0" />
                  ) : (
                    <FileCode className="w-3.5 h-3.5 text-amber-500 flex-shrink-0" />
                  )}
                  <div className="flex-1 min-w-0">
                    <div className="truncate font-medium">{fileName}</div>
                    {dirPath && (
                      <div className="truncate text-xs text-muted-foreground">{dirPath}</div>
                    )}
                  </div>
                  <div className="flex items-center gap-1 flex-shrink-0 text-xs">
                    {diff.additions > 0 && (
                      <span className="text-green-500">+{diff.additions}</span>
                    )}
                    {diff.deletions > 0 && (
                      <span className="text-red-500">-{diff.deletions}</span>
                    )}
                  </div>
                </button>
              )
            })}
          </div>
        </div>
      )
    }
    ```

    **3. Create `app/components/diff/DiffToolbar.tsx`:**

    Mode toggle toolbar above the DiffEditor:

    ```typescript
    /**
     * DiffToolbar — file name display + inline/side-by-side mode toggle.
     */
    import { Columns2, Rows2 } from 'lucide-react'
    import { cn } from '@/lib/utils'

    interface DiffToolbarProps {
      fileName: string | null
      sideBySide: boolean
      onToggleMode: () => void
      additions: number
      deletions: number
    }

    export function DiffToolbar({ fileName, sideBySide, onToggleMode, additions, deletions }: DiffToolbarProps) {
      return (
        <div className="flex items-center gap-2 px-3 py-1.5 border-b border-border bg-muted/30">
          <span className="text-sm font-medium truncate flex-1">
            {fileName ?? 'Select a file'}
          </span>
          {fileName && (
            <>
              <span className="text-xs text-green-500">+{additions}</span>
              <span className="text-xs text-red-500">-{deletions}</span>
            </>
          )}
          <button
            onClick={onToggleMode}
            className={cn(
              "ml-2 p-1 rounded text-muted-foreground hover:text-foreground hover:bg-accent transition-colors",
              "text-xs flex items-center gap-1"
            )}
            title={sideBySide ? "Switch to inline view" : "Switch to side-by-side view"}
          >
            {sideBySide ? (
              <><Rows2 className="w-3.5 h-3.5" /> Inline</>
            ) : (
              <><Columns2 className="w-3.5 h-3.5" /> Side by Side</>
            )}
          </button>
        </div>
      )
    }
    ```

    **4. Create `app/components/diff/DiffViewer.tsx`:**

    Main diff viewer container composing all sub-components. Uses Monaco DiffEditor directly:

    ```typescript
    /**
     * DiffViewer — session diff viewer with file list + Monaco DiffEditor.
     *
     * CRITICAL: Implements aggressive DiffEditor disposal to mitigate
     * memory leak (GitHub monaco-editor#4659). Model-swapping is used
     * instead of remounting when switching files.
     */
    import { useRef, useEffect, useCallback } from 'react'
    import { DiffEditor } from '@monaco-editor/react'
    import type { editor } from 'monaco-editor'
    import { useSessionDiff } from '@/hooks/useSessionDiff'
    import { useDiffStore } from '@/stores/diff-store'
    import { FileChangeList } from './FileChangeList'
    import { DiffToolbar } from './DiffToolbar'
    ```

    Reuse the `EXT_TO_LANG` map and `detectLanguage` function (copy from MonacoEditor.tsx — do NOT import from it since that creates a coupling). Keep the map compact (ts, tsx, js, jsx, json, css, scss, html, md, py, rs, go, yaml, yml, sh, bash, zsh, toml, sql, xml, svg).

    Component structure:
    - `sessionId` prop
    - `useSessionDiff(sessionId)` for data
    - `useDiffStore()` for selectedFile + sideBySide state
    - `diffEditorRef` for editor instance reference
    - Auto-select first file on data load (effect)
    - Find `selectedDiff` from diffs array by selectedFile

    Render layout: flex row with `FileChangeList` (left) + column of `DiffToolbar` + `DiffEditor` (right).

    DiffEditor configuration:
    ```tsx
    <DiffEditor
      original={selectedDiff.before}
      modified={selectedDiff.after}
      language={detectLanguage(selectedDiff.file)}
      theme="vs-dark"
      onMount={(editor) => { diffEditorRef.current = editor }}
      options={{
        renderSideBySide: sideBySide,
        readOnly: true,
        automaticLayout: true,
        enableSplitViewResizing: true,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        lineNumbers: 'on',
        renderOverviewRuler: true,
      }}
    />
    ```

    **CRITICAL — Memory leak mitigation:** Add cleanup effect:
    ```typescript
    useEffect(() => {
      return () => {
        if (diffEditorRef.current) {
          try {
            const orig = diffEditorRef.current.getOriginalEditor().getModel()
            const mod = diffEditorRef.current.getModifiedEditor().getModel()
            diffEditorRef.current.dispose()
            orig?.dispose()
            mod?.dispose()
          } catch {
            // Silently handle disposal errors
          }
          diffEditorRef.current = null
        }
      }
    }, [])
    ```

    Also reset diff store on unmount:
    ```typescript
    useEffect(() => {
      return () => { useDiffStore.getState().reset() }
    }, [])
    ```

    Empty state: if no diffs, show "No changes in this session" message.

    Export the `DiffViewer` as a named export (not default) so the lazy import in DiffEditor.lazy.tsx works with the `.then(m => ({ default: m.DiffViewer }))` pattern.

    **5. Extend `app/routes/chat.tsx`:**

    Add a "Chat / Changes" view toggle to the chat layout header. This allows users to switch between message view and diff view without leaving the session context.

    Changes:
    - Add `useState<'chat' | 'changes'>('chat')` for view mode
    - Get `sessionId` from params: `const params = useParams({ strict: false }) as { sessionId?: string }`
    - Import `LazyDiffViewer` from `@/components/diff/DiffEditor.lazy`
    - In the header, add a toggle between "Chat" and "Changes" tabs:
      ```tsx
      <div className="flex items-center gap-1 bg-muted rounded-md p-0.5">
        <button
          onClick={() => setView('chat')}
          className={cn("px-2 py-0.5 text-xs rounded", view === 'chat' ? "bg-background shadow-sm" : "text-muted-foreground")}
        >
          Chat
        </button>
        <button
          onClick={() => setView('changes')}
          disabled={!params.sessionId}
          className={cn("px-2 py-0.5 text-xs rounded", view === 'changes' ? "bg-background shadow-sm" : "text-muted-foreground", !params.sessionId && "opacity-50 cursor-not-allowed")}
        >
          Changes
        </button>
      </div>
      ```
    - Replace the bare `<Outlet />` with conditional render:
      ```tsx
      {view === 'chat' ? <Outlet /> : <LazyDiffViewer sessionId={params.sessionId} />}
      ```
    - Reset view to 'chat' when sessionId changes (useEffect on params.sessionId)
    - Import `cn` from `@/lib/utils`
  </action>
  <verify>
    1. `npm run typecheck:app` passes with zero errors
    2. `npm run build:app` succeeds (client + SSR — no window reference crash)
    3. Chat layout shows "Chat / Changes" toggle in header
    4. Clicking "Changes" renders the DiffViewer with file list
    5. Selecting a file shows its diff in Monaco DiffEditor
    6. Mode toggle switches between inline and side-by-side
    7. No console errors about SSR or window references
  </verify>
  <done>
    Diff viewer fully functional: file change list with +/- counts, Monaco DiffEditor with inline/side-by-side toggle, SSR-safe lazy loading, aggressive model disposal on unmount. Accessible via Chat/Changes toggle in chat header.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck:app` — zero errors
2. `npm run build:app` — client + SSR build succeeds
3. DiffEditor renders without SSR crash
4. File change list shows correct additions/deletions
5. Click file → diff appears with correct language highlighting
6. Mode toggle works (inline ↔ side-by-side)
7. Navigate away and back — no memory leak warnings
8. Chat/Changes toggle works, reverts to Chat on session switch
</verification>

<success_criteria>
- User sees file change list with +/- counts for current session
- User clicks a file to view its diff in Monaco DiffEditor
- User toggles between inline and side-by-side diff modes
- DiffEditor is SSR-safe (no crash during TanStack Start prerender)
- DiffEditor models are explicitly disposed on unmount
- Chat/Changes view toggle is available when viewing a session
- "Changes" tab is disabled when no session is selected
</success_criteria>

<output>
After completion, create `.planning/phases/08-sessions-diffs-agents/08-02-SUMMARY.md`
</output>
