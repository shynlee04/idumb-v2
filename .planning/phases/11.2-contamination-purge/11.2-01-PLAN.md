---
phase: 11.2-contamination-purge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  # Task 1: Archive/delete file operations
  - _archived-2026-02-12/  # 15 root .md files moved here
  - .planning/_archived-2026-02-12/codebase/  # 7 planning files moved here
  - src/lib/brain-indexer.ts  # DELETED
  # Task 2: Source code contamination fixes
  - src/lib/persistence.ts
  - src/lib/state-reader.ts
  - src/lib/sqlite-adapter.ts
  - src/cli/deploy.ts
  - src/schemas/task.ts
  - src/schemas/task-graph.ts
  - src/schemas/delegation.ts
  - src/schemas/work-plan.ts
  - src/schemas/plan-state.ts
  - src/schemas/planning-registry.ts
  - src/schemas/coherent-knowledge.ts
  - src/schemas/anchor.ts
  - tests/task-graph.test.ts
  - tests/delegation.test.ts
autonomous: true

must_haves:
  truths:
    - "No root-level CLAUDE-*.md files exist except CLAUDE.md"
    - "No .planning/codebase/ directory exists (all files archived)"
    - "brain-indexer.ts does not exist in src/lib/"
    - "Schema display strings reference lifecycle verb tools (tasks_start, tasks_done, tasks_add), not govern_task/govern_plan"
    - "allowedTools arrays in delegation.ts and work-plan.ts contain lifecycle verb names, not govern_task"
    - "persistence.ts header comments reference current consumers (dashboard server functions, state-reader.ts), not tool-gate.ts or compaction.ts"
    - "All 10 test suites pass (npm test) with 591+ assertions"
  artifacts:
    - path: "_archived-2026-02-12/"
      provides: "Archive of 15 stale root .md files"
    - path: ".planning/_archived-2026-02-12/codebase/"
      provides: "Archive of 7 stale planning/codebase files"
    - path: "src/schemas/task.ts"
      provides: "Display strings with lifecycle verb references"
      contains: "tasks_start|tasks_done|tasks_add"
    - path: "src/schemas/delegation.ts"
      provides: "Default allowedTools with lifecycle verbs"
      contains: "tasks_start"
    - path: "src/schemas/work-plan.ts"
      provides: "Checkpoint allowedTools with lifecycle verbs"
      contains: "tasks_start"
  key_links:
    - from: "src/schemas/task-graph.ts"
      to: "tests/task-graph.test.ts"
      via: "formatTaskGraph display string assertion"
      pattern: "tasks_add"
    - from: "src/schemas/delegation.ts"
      to: "tests/delegation.test.ts"
      via: "allowedTools default value"
      pattern: "tasks_start"
---

<objective>
Remove all plugin-era context pollution from the codebase. Archive 15 stale root documentation files and 7 stale planning/codebase files. Delete 382 LOC of dead brain-indexer.ts code. Fix 26+ stale references to deleted tools (govern_task, govern_plan, govern_shell) in 6 schema files, 2 code-level allowedTools arrays, and 4 library comment blocks. Update test assertions that verify display string content.

Purpose: Prevent AI agents from being misled by display strings referencing deleted tools (govern_task, govern_plan). Remove 14,116+ lines of stale documentation that pollutes agent context windows. Eliminate dead code inflating LOC counts. This is the final cleanup gate before Phase 7 (Chat + Terminal) development begins.

Output: Clean codebase with zero stale tool references in active source files, archived documentation in date-stamped directories, and all tests passing.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.2-contamination-purge/11.2-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Archive stale docs and delete dead code</name>
  <files>
    _archived-2026-02-12/
    .planning/_archived-2026-02-12/codebase/
    src/lib/brain-indexer.ts
  </files>
  <action>
    **Step 1: Create archive directories**
    ```
    mkdir -p _archived-2026-02-12
    mkdir -p .planning/_archived-2026-02-12/codebase
    ```

    **Step 2: Archive 15 stale root .md files**
    Move each of these files to `_archived-2026-02-12/`:
    - CLAUDE-ARCHITECTURE.md
    - CLAUDE-GAPS.md
    - CLAUDE-INDEX.md
    - CLAUDE-NAVIGATION.md
    - GAP-ANALYSIS.md
    - TRIAL-1-RESULTS.md
    - fix-delegation-system.md
    - conversation.md
    - n-3-2-1e.md
    - analysis-agent-system.md
    - TEST-CASES.md
    - TRIAL-TRACKER.md
    - validation_report-2026-02-07.md
    - MASTER-PLAN.md
    - ARCHITECTURE.md

    Do NOT move: CLAUDE.md, AGENTS.md, CHANGELOG.md, README.md (these are active).

    **Step 3: Archive 7 stale .planning/codebase/ files**
    Move ALL files from `.planning/codebase/` to `.planning/_archived-2026-02-12/codebase/`:
    - ARCHITECTURE.md
    - CONCERNS.md
    - CONVENTIONS.md
    - INTEGRATIONS.md
    - STACK.md
    - STRUCTURE.md
    - TESTING.md

    Then remove the empty `.planning/codebase/` directory.

    **Step 4: Delete dead code**
    Delete `src/lib/brain-indexer.ts` (382 LOC). This file is only imported by `src/_archived-plugin/tools/init.ts` which is excluded from the build. Zero active importers confirmed by grep.

    **What to avoid:**
    - Do NOT delete .worktree copies of any files (worktrees are independent, out of scope per research)
    - Do NOT delete `src/lib/index.ts` archive breadcrumb comments (useful navigation aids)
    - Do NOT touch anything in `src/_archived-plugin/` or `src/lib/_archived-2026-02-08/`
  </action>
  <verify>
    1. `ls _archived-2026-02-12/*.md | wc -l` returns 15
    2. `ls .planning/_archived-2026-02-12/codebase/*.md | wc -l` returns 7
    3. `ls .planning/codebase/ 2>/dev/null` returns error (directory removed)
    4. `ls src/lib/brain-indexer.ts 2>/dev/null` returns error (file deleted)
    5. `ls CLAUDE.md AGENTS.md CHANGELOG.md README.md` all exist (active files preserved)
    6. No CLAUDE-*.md files at root: `ls CLAUDE-*.md 2>/dev/null` returns nothing
    7. `npm run typecheck` passes (no broken imports from brain-indexer.ts deletion)
  </verify>
  <done>
    15 stale root .md files archived to _archived-2026-02-12/. 7 .planning/codebase/ files archived to .planning/_archived-2026-02-12/codebase/. brain-indexer.ts deleted. Zero typecheck errors. Active documentation files (CLAUDE.md, AGENTS.md, CHANGELOG.md, README.md) preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix stale tool references in active source files</name>
  <files>
    src/lib/persistence.ts
    src/lib/state-reader.ts
    src/lib/sqlite-adapter.ts
    src/cli/deploy.ts
    src/schemas/task.ts
    src/schemas/task-graph.ts
    src/schemas/delegation.ts
    src/schemas/work-plan.ts
    src/schemas/plan-state.ts
    src/schemas/planning-registry.ts
    src/schemas/coherent-knowledge.ts
    src/schemas/anchor.ts
    tests/task-graph.test.ts
    tests/delegation.test.ts
  </files>
  <action>
    This task fixes stale references to deleted plugin-era tools and archived files. The changes fall into 3 categories: (A) header comment corrections, (B) display string rewrites, (C) code-level allowedTools fixes. After each schema file edit, run its corresponding test to catch regressions immediately.

    **IMPORTANT: Do NOT touch `src/templates.ts`** — its 17 "tool-gate hook" references are DEFERRED to Phase 9 (lifecycle verb deployment).

    **Category A: Header comment corrections (low risk, comments only)**

    **persistence.ts** — Fix 5 stale lines:
    - Line ~4: `Wraps the in-memory Maps from tool-gate.ts and compaction.ts.` -> `Wraps the in-memory Maps for session and anchor state.`
    - Line ~15: `Consumers: tool-gate.ts, compaction.ts, index.ts` -> `Consumers: dashboard server functions, CLI deploy, state-reader.ts`
    - Line ~171: `Used by: tasks_check, system.ts hook, compaction.ts hook.` -> `Used by: tasks_check, dashboard server functions`
    - Line ~447: `// --- Session State (tool-gate) ---` -> `// --- Session State ---`
    - Line ~692: `// --- Anchor State (compaction) ---` -> `// --- Anchor State ---`

    **state-reader.ts** — Fix 1 stale comment:
    - Line ~9: `(The govern_task tool handles all task mutations.)` -> `(The lifecycle verb tools handle all task mutations: tasks_start, tasks_done, tasks_add, tasks_check, tasks_fail.)`

    **sqlite-adapter.ts** — Fix 1 stale comment:
    - Line ~5: `Synchronous reads (critical for tool-gate hot path).` -> `Synchronous reads for fast state lookups.`

    **deploy.ts** — Fix 1 stale comment:
    - Line ~220: `// immediately without needing to call govern_task first.` -> `// immediately without needing to call tasks_start first.`

    **Schema header comments** — Fix stale consumer/purpose listings:
    - `task.ts` line ~161: Remove or update `govern_task` comment
    - `task-graph.ts` lines ~7-8: Update consumer list (remove `tool-gate.ts hook`, `compaction.ts`, `govern_task tool` references; replace with `lifecycle verb tools, dashboard server functions`)
    - `work-plan.ts` lines ~15-17: Update consumer list (remove `govern_plan tool, govern_task tool, govern_delegate tool`; replace with `lifecycle verb tools (tasks_start, tasks_done, tasks_add)`)
    - `plan-state.ts` lines ~8-9: Update consumer list (remove `compaction.ts hook, govern_plan tool`; replace with `lifecycle verb tools, dashboard server functions`)
    - `planning-registry.ts` line ~14: Update consumer list (remove `govern_plan` reference)
    - `coherent-knowledge.ts` line ~5: Update (remove `tool-gate after hook` reference)
    - `anchor.ts` line ~9: Update consumer list (remove `compaction hook`; replace with `dashboard server functions`)
    - `task.ts` lines with `tool-gate` in comments: Update to reference current enforcement mechanism

    **Category B: Display string rewrites (medium risk, agent-facing)**

    Use these replacement mappings for ALL display/format strings:
    - `govern_task action=start task_id=...` -> `tasks_start` (no arguments — lifecycle verbs infer context)
    - `govern_task action=complete target_id=... evidence='...'` -> `tasks_done` (no arguments)
    - `govern_task action=add_subtask ...` -> `tasks_add` (called with task description)
    - `govern_task action=defer ...` -> `tasks_fail` (no arguments)
    - `govern_task action=create ...` -> `tasks_add` (called with task description)
    - `govern_plan action=create ...` -> `tasks_add` (called with plan description)
    - `govern_plan action=plan_tasks ...` -> `tasks_add` (called per task, parallel)

    Apply these in:
    - **`src/schemas/task.ts`** (~9 display string occurrences): Rewrite format function output strings
    - **`src/schemas/task-graph.ts`** (~6 display string occurrences): Rewrite format function output strings
    - **`src/schemas/delegation.ts`** line ~360: Rewrite instruction string
    - **`src/schemas/work-plan.ts`** line ~224: Update comment

    After each file, run its test:
    ```
    npx tsx tests/task.test.ts
    npx tsx tests/task-graph.test.ts
    npx tsx tests/delegation.test.ts
    npx tsx tests/work-plan.test.ts
    ```

    **Category C: Code-level allowedTools fixes (higher risk, runtime code)**

    **`src/schemas/delegation.ts` line ~134:**
    Change default allowedTools from:
    `allowedTools: opts.allowedTools ?? ["govern_task", "idumb_anchor"]`
    To:
    `allowedTools: opts.allowedTools ?? ["tasks_start", "tasks_done", "tasks_check", "tasks_fail", "idumb_anchor"]`

    **`src/schemas/work-plan.ts` line ~252:**
    Change checkpoint allowedTools from:
    `allowedTools: ["write", "edit", "bash", "govern_task", "anchor"]`
    To:
    `allowedTools: ["write", "edit", "bash", "tasks_start", "tasks_done", "tasks_check", "tasks_fail", "anchor"]`

    **`src/schemas/work-plan.ts` lines ~280-287:**
    Remove `govern_shell` from the `shouldCreateCheckpoint` function. The condition `tool === "govern_shell"` should be removed since that tool no longer exists. Keep the `bash` destructive command check as-is.

    **Category D: Test updates**

    **`tests/task-graph.test.ts` line ~391:**
    Update assertion from:
    `assert(emptyFormat.includes("govern_plan"), "formatTaskGraph: empty graph has create hint")`
    To:
    `assert(emptyFormat.includes("tasks_add"), "formatTaskGraph: empty graph has create hint")`

    **`tests/delegation.test.ts` line ~324:**
    Update comment from:
    `wp1.status = "active" // govern_plan sets this when plan is activated`
    To:
    `wp1.status = "active" // tasks_start sets this when plan is activated`

    **Final verification:** Run full test suite `npm test` to confirm all 591+ assertions pass.
  </action>
  <verify>
    1. `grep -r "govern_task\|govern_plan\|govern_shell" src/schemas/ --include="*.ts"` returns zero matches
    2. `grep "govern_task\|govern_plan" src/lib/persistence.ts src/lib/state-reader.ts src/lib/sqlite-adapter.ts src/cli/deploy.ts` returns zero matches
    3. `grep "tool-gate\|compaction\.ts" src/lib/persistence.ts` returns zero matches
    4. `grep "govern_task\|govern_plan" tests/task-graph.test.ts tests/delegation.test.ts` returns zero matches (excluding _archived)
    5. `npm run typecheck` passes with zero errors
    6. `npm test` passes — all 10 suites, 591+ assertions
    7. `grep "tasks_start\|tasks_done\|tasks_add" src/schemas/delegation.ts` returns matches (lifecycle verbs present)
    8. `grep "tasks_start\|tasks_done" src/schemas/work-plan.ts` returns matches (lifecycle verbs present)
  </verify>
  <done>
    All 26+ stale govern_task/govern_plan/govern_shell references removed from 6 schema files. 2 code-level allowedTools arrays updated to lifecycle verb names. 8 stale header comments corrected across persistence.ts, state-reader.ts, sqlite-adapter.ts, deploy.ts, and 6 schema files. 1 test assertion and 1 test comment updated. Full test suite (10 suites, 591+ assertions) passes. Zero grep matches for deleted tool names in active source code.
  </done>
</task>

</tasks>

<verification>
1. **Documentation pollution eliminated:**
   - `ls *.md` shows only CLAUDE.md, AGENTS.md, CHANGELOG.md, README.md at root
   - `ls .planning/codebase/` fails (directory gone)
   - `ls _archived-2026-02-12/*.md | wc -l` = 15
   - `ls .planning/_archived-2026-02-12/codebase/*.md | wc -l` = 7

2. **Dead code removed:**
   - `ls src/lib/brain-indexer.ts` fails (file deleted)

3. **No stale tool references in active source:**
   - `grep -r "govern_task\|govern_plan\|govern_shell" src/ --include="*.ts" | grep -v _archived | grep -v templates.ts` = zero matches
   - `grep "tool-gate\|compaction\.ts" src/lib/persistence.ts` = zero matches

4. **Build and test integrity:**
   - `npm run typecheck` = zero errors
   - `npm test` = 10 suites, 591+ assertions passing

5. **templates.ts NOT touched** (deferred to Phase 9):
   - `grep "tool-gate" src/templates.ts | wc -l` should still show ~17-20 matches (unchanged)
</verification>

<success_criteria>
- Zero root-level CLAUDE-*.md files (except CLAUDE.md)
- Zero files in .planning/codebase/ (all archived)
- brain-indexer.ts does not exist
- Zero matches for `govern_task|govern_plan|govern_shell` in active src/ files (excluding _archived/ and templates.ts)
- persistence.ts comments reference dashboard server functions (not tool-gate/compaction)
- delegation.ts and work-plan.ts allowedTools arrays contain lifecycle verb names
- npm run typecheck passes
- npm test passes (10 suites, 591+ assertions)
</success_criteria>

<output>
After completion, create `.planning/phases/11.2-contamination-purge/11.2-01-SUMMARY.md`
</output>
