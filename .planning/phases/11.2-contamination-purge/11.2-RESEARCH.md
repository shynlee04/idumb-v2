# Phase 11.2: Contamination & Dead Code Purge - Research

**Researched:** 2026-02-12
**Domain:** Codebase hygiene -- stale documentation removal, dead code deletion, comment correction
**Confidence:** HIGH

## Summary

Phase 11.2 is a housekeeping phase with no functional code changes. The contamination is real, extensive, and well-scoped. There are 15 stale root-level `.md` files totaling 12,161 lines, 7 stale `.planning/codebase/` files totaling 1,955 lines, 382 lines of dead `brain-indexer.ts` code imported by nobody in active code, and pervasive stale references to archived plugin-era tools (`govern_task`, `govern_plan`, `govern_shell`) embedded in schema display strings and header comments across 6+ active source files.

The phase is straightforward: archive stale docs, delete dead code, fix comments. No library installation, no schema changes, no test modifications. The risk is low -- these are file operations and comment edits, not logic changes. However, the contamination in schema display strings (`task.ts`, `task-graph.ts`, `delegation.ts`, `work-plan.ts`) goes beyond what the success criteria explicitly list. These strings tell agents to use `govern_task action=complete` -- a tool that no longer exists. This is the most important contamination to fix because it actively misleads AI agents at runtime.

**Primary recommendation:** Execute as a single plan with 3 task groups: (1) archive/delete stale docs, (2) delete dead code files, (3) fix stale references in active source files. Task 3 is the most impactful -- fixing agent-facing strings that reference deleted tools.

## Contamination Inventory

### Group 1: Stale Root-Level .md Files (12,161 LOC total)

Files to archive to `_archived-2026-02-12/` at the v2 root:

| File | Lines | Content | Action |
|------|-------|---------|--------|
| `CLAUDE-ARCHITECTURE.md` | 1,023 | v2.2.0 architecture docs (2026-02-07, 294 assertions baseline) | Archive |
| `CLAUDE-GAPS.md` | 1,132 | v2.2.0 gaps analysis (2026-02-07) | Archive |
| `CLAUDE-INDEX.md` | 493 | v2.2.0 documentation index (2026-02-07) | Archive |
| `CLAUDE-NAVIGATION.md` | 634 | v2.2.0 code navigation guide (2026-02-07) | Archive |
| `GAP-ANALYSIS.md` | 321 | Early gap analysis | Archive |
| `TRIAL-1-RESULTS.md` | 157 | Trial results | Archive |
| `fix-delegation-system.md` | 358 | Delegation fix notes | Archive |
| `conversation.md` | 1,462 | Conversation log | Archive |
| `n-3-2-1e.md` | 4,476 | Implementation notes | Archive |
| `analysis-agent-system.md` | 449 | Agent system analysis | Archive |
| `TEST-CASES.md` | 483 | Test case documentation | Archive |
| `TRIAL-TRACKER.md` | 203 | Trial tracking | Archive |
| `validation_report-2026-02-07.md` | 153 | Old validation report | Archive |
| `MASTER-PLAN.md` | 479 | Old master plan (superseded by `.planning/ROADMAP.md`) | Archive |
| `ARCHITECTURE.md` | 338 | Old architecture doc (superseded by AGENTS.md) | Archive |

**Files to KEEP at root:** `CLAUDE.md`, `AGENTS.md`, `CHANGELOG.md`, `README.md`

### Group 2: Stale .planning/codebase/ Files (1,955 LOC total)

All 7 files to archive to `.planning/_archived-2026-02-12/codebase/`:

| File | Lines |
|------|-------|
| `ARCHITECTURE.md` | 226 |
| `CONCERNS.md` | 233 |
| `CONVENTIONS.md` | 332 |
| `INTEGRATIONS.md` | 198 |
| `STACK.md` | 165 |
| `STRUCTURE.md` | 328 |
| `TESTING.md` | 473 |

These are dated 2026-02-10 and have been superseded by `AGENTS.md` and `CLAUDE.md` as ground truth.

### Group 3: Dead Code Files

| File | Lines | Evidence of Death | Action |
|------|-------|-------------------|--------|
| `src/lib/brain-indexer.ts` | 382 | Only imported by `src/_archived-plugin/tools/init.ts` (archived). Zero imports from active `src/` or `app/` code. | **Delete** |
| `src/lib/_archived-2026-02-08/chain-validator.ts` | 300 | Only imported by `entity-resolver.ts` in same archived directory. | Already archived, consider delete |
| `src/lib/_archived-2026-02-08/entity-resolver.ts` | 545 | Only self-referential within archived directory. `src/lib/index.ts` has a comment noting the archive. | Already archived, consider delete |

**Total dead code to delete:** 382 LOC minimum (brain-indexer.ts). 845 LOC optional (archived lib files already excluded from build).

### Group 4: Stale References in Active Source Files (CRITICAL)

This is the contamination that actively misleads AI agents at runtime. These are NOT just comments -- many are in display strings returned to agents.

#### 4a. `persistence.ts` Header Comments (5 stale lines)

| Line | Current Text | Should Be |
|------|-------------|-----------|
| 4 | `Wraps the in-memory Maps from tool-gate.ts and compaction.ts.` | `Wraps the in-memory Maps for session and anchor state.` |
| 15 | `Consumers: tool-gate.ts, compaction.ts, index.ts` | `Consumers: dashboard server functions, CLI deploy, state-reader.ts` |
| 171 | `Used by: tasks_check, system.ts hook, compaction.ts hook.` | `Used by: tasks_check, dashboard server functions` |
| 447 | `// --- Session State (tool-gate) ---` | `// --- Session State ---` |
| 692 | `// --- Anchor State (compaction) ---` | `// --- Anchor State ---` |

#### 4b. Schema Display Strings Referencing Deleted Tools (AGENT-FACING)

**`src/schemas/task.ts`** -- 9 references to `govern_task`/`govern_plan` in user-facing format strings:
- Line 161: Comment about `govern_task` (comment-only)
- Line 275: Display string: `govern_task action=complete target_id=...`
- Line 286: Display string: `govern_task action=complete target_id=...`
- Line 351: Display string: `govern_task action=start task_id=...`
- Line 384-386: Display strings: `govern_task action=add_subtask/complete/defer`
- Line 421: Display string: `govern_plan action=create`
- Line 459: Display string: `govern_plan action=create`
- Line 483-485: Display strings: `govern_task action=start` and `govern_task action=create`

**`src/schemas/task-graph.ts`** -- 6 references in user-facing format strings:
- Line 7-8: Header comment listing deleted consumers
- Line 186: Display string: `govern_task action=complete`
- Line 222: Display string: `govern_task action=start`
- Line 350: Display string: `govern_plan action=create`
- Line 458: Display string: `govern_plan action=create`
- Line 478-480: Display strings: `govern_task action=start` and `govern_plan action=plan_tasks`

**`src/schemas/delegation.ts`** -- 2 references:
- Line 134: Default `allowedTools` array includes `"govern_task"` (code-level, not just string)
- Line 360: Display string: `govern_task action=complete`

**`src/schemas/work-plan.ts`** -- 5 references:
- Lines 15-17: Header comment listing deleted consumers
- Line 224: Comment about tool-gate block
- Line 252: `allowedTools` array includes `"govern_task"` (code-level)
- Line 280-287: Comment and code referencing `govern_shell`

**`src/schemas/plan-state.ts`** -- 2 references:
- Lines 8-9: Header comment listing `compaction.ts hook` and `govern_plan tool`

**`src/schemas/planning-registry.ts`** -- 1 reference:
- Line 14: Header comment listing `govern_plan` as consumer

**`src/schemas/coherent-knowledge.ts`** -- 1 reference:
- Line 5: Comment about `tool-gate after hook`

**`src/schemas/anchor.ts`** -- 1 reference:
- Line 9: Header comment listing `compaction hook` as consumer

#### 4c. Other Active Code Stale References

**`src/lib/index.ts`** -- 2 archive-reference comments (lines 3-4, 10-11). These are informational breadcrumbs and acceptable to keep, but the wording could be updated.

**`src/lib/state-reader.ts`** -- 1 reference:
- Line 9: Comment: `(The govern_task tool handles all task mutations.)` -- should reference lifecycle verb tools

**`src/lib/sqlite-adapter.ts`** -- 1 reference:
- Line 5: Comment: `Synchronous reads (critical for tool-gate hot path).` -- tool-gate no longer exists

**`src/cli/deploy.ts`** -- 1 reference:
- Line 220: Comment about `govern_task` in bootstrap task creation

#### 4d. Templates (Already Clean)

`src/templates.ts` references "tool-gate hook" 17 times as the enforcement mechanism name. These are in agent templates deployed to `.opencode/agents/`. While tool-gate is archived as a file, the concept of "tool-gate enforcement" is still valid as behavior described in agent profiles. **However**, if the governance hooks are truly archived and not functional, these template references are misleading agents into thinking enforcement exists when it does not. This is a scope decision for the planner.

## Architecture Patterns

### Pattern 1: Archive-and-Delete Discipline

**What:** Stale files are moved to `_archived-YYYY-MM-DD/` directories, not deleted outright. This preserves git history accessibility while removing context pollution.
**When to use:** For documentation files, planning artifacts, and reference material.
**Exception:** Dead code files (`brain-indexer.ts`) can be deleted outright since they remain accessible via git history.

Archive destinations:
```
v2/
  _archived-2026-02-12/          # Root stale .md files (15 files)
.planning/
  _archived-2026-02-12/
    codebase/                    # 7 .planning/codebase/ files
```

### Pattern 2: Comment-Only vs Code-Level Contamination

**What:** Distinguish between stale comments (low risk, fix for correctness) and stale code/display-strings (high risk, actively misleading).
**Priority order:**
1. **Code-level:** `allowedTools` arrays containing `"govern_task"` (delegation.ts:134, work-plan.ts:252) -- these affect runtime behavior
2. **Display strings:** Format functions returning `govern_task action=...` instructions -- these mislead AI agents
3. **Header comments:** Consumer/purpose descriptions -- affect developer understanding only

### Anti-Patterns to Avoid

- **Shotgun find-and-replace:** Do NOT blindly replace `govern_task` with `tasks_start` everywhere. The display strings need semantic rewrites (e.g., `govern_task action=complete target_id=X evidence='...'` becomes `tasks_done` with no arguments).
- **Deleting archive breadcrumbs:** Comments in `src/lib/index.ts` that say "moved to _archived-plugin/" are useful navigation aids. Keep them.
- **Touching test files:** The schema test files (`task.test.ts`, `task-graph.test.ts`, `delegation.test.ts`, `work-plan.test.ts`) may test display format functions that output `govern_task` strings. If display strings change, tests must be updated in the same task.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Finding all stale references | Manual grep | Systematic grep by pattern | Too many scattered references to find manually |
| Verifying no broken imports | Manual file reading | `npm run typecheck` + `npm test` | Automated verification catches what eyes miss |
| Archive directory naming | Custom naming | `_archived-2026-02-12/` convention | Matches existing project convention |

## Common Pitfalls

### Pitfall 1: Changing Display Strings Without Updating Tests
**What goes wrong:** Schema format functions (`formatStatus`, `formatGateDecision`, etc.) are tested. Changing their output breaks tests.
**Why it happens:** Tests assert exact string content.
**How to avoid:** Run `npm test` after every display string change. Update test expectations in the same commit.
**Warning signs:** Test failures in `task.test.ts`, `task-graph.test.ts`, `work-plan.test.ts`, `delegation.test.ts`.

### Pitfall 2: Breaking Imports by Deleting brain-indexer.ts
**What goes wrong:** If any active code still imports `brain-indexer.ts`, deletion causes build failure.
**Why it happens:** Grep might miss dynamic imports or re-exports.
**How to avoid:** Already verified -- only import is from `_archived-plugin/tools/init.ts` (excluded from build). Run `npm run typecheck` after deletion.
**Warning signs:** `npm run typecheck` fails with "Cannot find module" error.

### Pitfall 3: Confusing "tool-gate" the Concept vs the File
**What goes wrong:** Agent templates describe "tool-gate hook" as enforcement mechanism. If we remove all "tool-gate" references, templates lose their description of how governance enforcement works.
**Why it happens:** The concept predates the file archival. The enforcement behavior is described even though the implementing file is archived.
**How to avoid:** In templates, replace "tool-gate hook" with accurate language about whatever mechanism currently enforces governance (or note that enforcement is pending reimplementation).
**Warning signs:** Agent templates that don't describe how writes are gated.

### Pitfall 4: Schema Code Changes Masquerading as Comment Fixes
**What goes wrong:** `delegation.ts:134` and `work-plan.ts:252` contain `allowedTools` arrays with `"govern_task"` as a value. These are not comments -- they are runtime code. Changing them is a functional change that could affect behavior.
**Why it happens:** Easy to treat all `govern_task` occurrences as "just stale references."
**How to avoid:** Treat `allowedTools` array changes as code changes requiring test verification. The correct replacement for `"govern_task"` in allowed tools is likely `"tasks_start"` or `"tasks_done"` or the lifecycle verb equivalents.
**Warning signs:** Delegation test failures, work-plan test failures.

### Pitfall 5: Not Updating .worktree Copies
**What goes wrong:** `.worktrees/prototype-multi-agent-engine/` has copies of stale root files (CLAUDE-ARCHITECTURE.md, CLAUDE-GAPS.md, etc.).
**Why it happens:** Worktrees share the git repo but have their own working trees.
**How to avoid:** Worktree cleanup is OUT OF SCOPE for this phase. Worktrees track their own branches. The files in `.worktrees/` will resolve when those branches merge or are abandoned.
**Warning signs:** None -- worktrees are independent.

## Scope Decisions for Planner

### In Scope (from Success Criteria)
1. Archive root-level CLAUDE-*.md files (4 files)
2. Archive `.planning/codebase/` files (7 files)
3. Delete `brain-indexer.ts` (382 LOC)
4. Fix `persistence.ts` header comments (5 lines)
5. Archive stale root .md files (7 explicitly named + 4 additional found)

### Discovered Contamination (Beyond Success Criteria)
These items were found during research and are NOT explicitly listed in the ROADMAP success criteria, but represent real contamination:

6. **Schema display strings referencing `govern_task`/`govern_plan`** -- 20+ instances across 6 schema files. These are agent-facing strings that tell AI to use tools that no longer exist. **HIGH IMPACT.**
7. **`allowedTools` arrays containing `"govern_task"`** -- 2 instances in delegation.ts and work-plan.ts. These are runtime code. **MEDIUM IMPACT.**
8. **`work-plan.ts` referencing `govern_shell`** -- 2 instances including a code-level tool name comparison. **MEDIUM IMPACT.**
9. **Header comments in 6 schema files** referencing deleted consumers. **LOW IMPACT** (comments only).
10. **`state-reader.ts`, `sqlite-adapter.ts`, `deploy.ts`** stale comments. **LOW IMPACT.**
11. **`src/lib/index.ts`** archive breadcrumb comments. **NO ACTION** (useful navigation aids).
12. **`templates.ts`** "tool-gate hook" references (17 instances). **DEFERRED** -- templates describe governance behavior; changing them is Phase 9 scope (lifecycle verb deployment).

**Recommendation:** Items 6-8 should be included in this phase's plan as they represent active context pollution. Items 9-10 are low-risk comment fixes that can be batched with item 4. Item 12 is deferred to Phase 9.

## Test Impact Assessment

**Files that will need test updates if display strings change:**

| Schema File | Test File | What's Tested |
|-------------|-----------|---------------|
| `task.ts` | `task.test.ts` | Format functions output exact strings |
| `task-graph.ts` | `task-graph.test.ts` | Format functions output exact strings |
| `delegation.ts` | `delegation.test.ts` | Delegation record creation, formatInstructions |
| `work-plan.ts` | `work-plan.test.ts` | shouldCreateCheckpoint, allowedTools defaults |

**Approach:** If display string cleanup is in scope, run each test file individually after changes to isolate failures:
```bash
npx tsx tests/task.test.ts
npx tsx tests/task-graph.test.ts
npx tsx tests/delegation.test.ts
npx tsx tests/work-plan.test.ts
```

## Open Questions

1. **Should schema display strings be updated in this phase or deferred?**
   - What we know: The ROADMAP success criteria don't explicitly mention schema display strings. But they reference "DOC-1..DOC-3, CODE-1..CODE-2 from contamination audit."
   - What's unclear: Whether CODE-1/CODE-2 include schema display strings, or only brain-indexer.ts deletion.
   - Recommendation: Include display string fixes. They are the highest-impact contamination -- agents reading these strings will try to call deleted tools. Without the original audit document, interpret CODE generously.

2. **Should `templates.ts` tool-gate references be updated?**
   - What we know: 17 references to "tool-gate hook" in agent templates. The tool-gate hook is archived.
   - What's unclear: Whether templates should describe the governance enforcement as it *will* work (after SDK-direct reimplementation in Phase 9) or as it currently works (not enforced).
   - Recommendation: **Defer to Phase 9.** Templates will be rewritten when lifecycle verbs are deployed. Changing them now creates churn.

3. **What replaces `govern_task` in display strings?**
   - What we know: Lifecycle verbs exist: `tasks_start`, `tasks_done`, `tasks_check`, `tasks_add`, `tasks_fail`. They take 0-1 arguments.
   - What's unclear: Whether `task.ts` and `task-graph.ts` format functions are actively used by any current consumer, or are dead display code.
   - Recommendation: Replace with lifecycle verb equivalents. `govern_task action=start` -> `tasks_start`, `govern_task action=complete` -> `tasks_done`, `govern_plan action=create` -> `tasks_add`. If format functions are dead code, note that but still fix them for correctness.

## Sources

### Primary (HIGH confidence)
- Direct filesystem inspection via Glob, Grep, Read tools -- all findings verified against actual files
- `src/lib/brain-indexer.ts` import analysis -- confirmed zero active importers
- `src/lib/persistence.ts` header inspection -- confirmed stale consumer references
- `.planning/ROADMAP.md` -- Phase 11.2 success criteria (lines 130-144)
- `.planning/STATE.md` -- Current project position confirming Phase 11.2 is next
- `.planning/phases/11.1-build-config-blockers/11.1-01-SUMMARY.md` -- Phase 11.1 completion context

## Metadata

**Confidence breakdown:**
- Stale file inventory: HIGH -- every file verified to exist via Glob
- Dead code analysis: HIGH -- grep confirmed zero active imports of brain-indexer.ts
- Schema contamination: HIGH -- line-level grep results verified
- Test impact: MEDIUM -- test files exist and test format functions, but exact assertion content not verified
- Template scope decision: MEDIUM -- depends on whether governance hooks are functional (believed archived)

**Research date:** 2026-02-12
**Valid until:** 2026-03-12 (stable -- this is codebase state documentation, not technology research)
