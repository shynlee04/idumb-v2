---
phase: 01-engine-task-bus
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/dashboard/backend/server.ts
  - src/dashboard/frontend/src/pages/TasksPage.tsx
  - src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx
  - src/dashboard/frontend/src/components/tasks/TaskCard.tsx
  - src/dashboard/frontend/src/components/tasks/TaskDetailPanel.tsx
  - src/dashboard/frontend/src/hooks/useTasks.ts
autonomous: true

must_haves:
  truths:
    - "User can see all tasks in a sidebar list"
    - "User can click a task to see its details"
    - "Tasks display as rich cards with status badges and hierarchy"
    - "Task data comes from governance state (not hardcoded)"
    - "Tasks page shows dual-surface: sidebar list + detail panel"
  artifacts:
    - path: "src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx"
      provides: "Scrollable task list with Epic/Task/Subtask grouping"
      min_lines: 60
    - path: "src/dashboard/frontend/src/components/tasks/TaskCard.tsx"
      provides: "Rich task card with status, progress, metadata"
      min_lines: 50
    - path: "src/dashboard/frontend/src/components/tasks/TaskDetailPanel.tsx"
      provides: "Full task detail view with subtasks, checkpoints"
      min_lines: 80
    - path: "src/dashboard/frontend/src/hooks/useTasks.ts"
      provides: "Task data fetching and mutation hooks"
      min_lines: 40
  key_links:
    - from: "src/dashboard/frontend/src/hooks/useTasks.ts"
      to: "backend /api/tasks"
      via: "useQuery fetching governance task state"
      pattern: "useQuery.*tasks"
    - from: "src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx"
      to: "src/dashboard/frontend/src/components/tasks/TaskCard.tsx"
      via: "maps tasks to TaskCard components"
      pattern: "TaskCard"
    - from: "src/dashboard/frontend/src/pages/TasksPage.tsx"
      to: "src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx"
      via: "dual surface layout"
      pattern: "TaskSidebar|TaskDetailPanel"
---

<objective>
Build the task management surface with rich task cards and dual-surface layout.

Purpose: Tasks are the governance backbone — users need to see active work plans, task hierarchy (Epic→Task→Subtask), progress, and checkpoints. Per user decision: dual-surface (sidebar list + full detail page), rich cards with visual hierarchy.

Output: Task CRUD routes on backend, task sidebar, task cards, task detail panel, data-fetching hooks.
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-engine-task-bus/01-RESEARCH.md
@.planning/phases/01-engine-task-bus/01-01-SUMMARY.md
@.planning/phases/01-engine-task-bus/01-02-SUMMARY.md
@src/schemas/task.ts
@src/schemas/task-graph.ts
@src/schemas/work-plan.ts
@src/lib/persistence.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Task API Routes to Backend</name>
  <files>src/dashboard/backend/server.ts</files>
  <action>
Add task management API routes to the existing Express server. These read from iDumb governance state files in `.idumb/`.

**Routes to add (append after session routes):**
- `GET /api/tasks` — reads `.idumb/tasks.json`, returns parsed task hierarchy. Use existing `readGovernanceState()` or read file directly. Returns `{ workPlan: WorkPlan | null, tasks: TaskNode[], activeTask: TaskNode | null }`
- `GET /api/tasks/:id` — returns specific task by ID from the task graph
- `GET /api/governance` — returns full governance status: `{ activeTask, workPlan, progress, governanceMode, writesBlocked }`. Read from `.idumb/state.json` + `.idumb/tasks.json`
- `GET /api/tasks/history` — returns completed tasks from task graph (for history view)

All routes are READ-ONLY for Phase 1. Task mutations happen through OpenCode agent tools (tasks_start, tasks_done, etc.), not through the dashboard API directly.

Error handling: if `.idumb/` doesn't exist, return empty state `{ workPlan: null, tasks: [], activeTask: null }` (not an error — governance may not be initialized).

Import types from `../../schemas/task-graph.js` and `../../schemas/work-plan.js` for type safety.
  </action>
  <verify>
`npx tsc --noEmit` — zero errors. `curl http://localhost:3001/api/tasks` returns valid JSON. `curl http://localhost:3001/api/governance` returns governance status.
  </verify>
  <done>
Task API routes serve governance state. Returns empty state gracefully when .idumb/ not initialized. All routes are read-only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Task UI Components + Wire to TasksPage</name>
  <files>src/dashboard/frontend/src/hooks/useTasks.ts, src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx, src/dashboard/frontend/src/components/tasks/TaskCard.tsx, src/dashboard/frontend/src/components/tasks/TaskDetailPanel.tsx, src/dashboard/frontend/src/pages/TasksPage.tsx</files>
  <action>
**Create `src/dashboard/frontend/src/hooks/useTasks.ts`:**
- `useTasks()` — fetches `/api/tasks`, returns `{ workPlan, tasks, activeTask, isLoading }`
- `useTask(id: string)` — fetches specific task details
- `useGovernance()` — fetches `/api/governance`, returns governance status
- Poll interval: 5s for tasks (they change via agent actions)

**Create `src/dashboard/frontend/src/components/tasks/TaskCard.tsx`:**
Rich task card component. Props: `task: TaskNode`, `isActive: boolean`, `onClick: () => void`

Card contents:
- Status badge: `pending` (gray), `in_progress` (blue pulse), `completed` (green check), `failed` (red x), `blocked` (yellow lock) — use lucide icons
- Task name (bold, truncated if long)
- Type indicator: subtle label showing `auto` vs `checkpoint:human-verify` etc
- Subtask progress bar if task has subtasks: `3/5 subtasks`
- Time info: "Started 5m ago" or "Completed 2h ago"
- Active task gets a left border accent (blue-500)
- Hover: subtle background change

**Create `src/dashboard/frontend/src/components/tasks/TaskSidebar.tsx`:**
Scrollable sidebar showing task hierarchy:
- Group by work plan (if exists) with plan name as header
- Within plan: show tasks in dependency order
- Each task renders as `TaskCard`
- Indentation: Epics at root, Tasks indented, Subtasks double-indented
- Active task highlighted with accent border
- Empty state: "No active tasks — start one in chat"
- Filter tabs at top: "Active" | "Completed" | "All"

**Create `src/dashboard/frontend/src/components/tasks/TaskDetailPanel.tsx`:**
Full detail view when a task is selected:
- Task name as h2
- Status badge (large)
- Description / objective
- Checkpoint information (if checkpoint type)
- Subtask list with individual status
- Dependencies: which tasks this depends on
- Evidence (if completed) or reason (if failed)
- Timeline: created → started → completed timestamps
- Empty state when no task selected: "Select a task from the sidebar"

**Update `src/dashboard/frontend/src/pages/TasksPage.tsx`:**
Dual-surface layout per user decision:
- Left panel (w-80): `TaskSidebar` with task list
- Main panel: `TaskDetailPanel` showing selected task
- Use `useParams()` for `:taskId` from URL
- Clicking a task in sidebar navigates to `/tasks/:taskId`
- Responsive: on mobile, sidebar is full-width, detail is separate page
  </action>
  <verify>
`cd src/dashboard/frontend && npm run build` succeeds. Navigate to `/tasks` — sees task sidebar with cards (or empty state if no tasks). Click a task — sees detail panel.
  </verify>
  <done>
Tasks page shows dual-surface layout with sidebar list and detail panel. Task cards display status, hierarchy, and progress. Data comes from governance state files via API. Empty states handled gracefully.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors (both backend and frontend)
2. `npm test` — 814 assertions still pass
3. `cd src/dashboard/frontend && npm run build` — succeeds
4. `/api/tasks` returns governance task data (or empty state)
5. `/tasks` page shows task sidebar with proper hierarchy
6. Clicking a task shows detail panel
7. Active task highlighted with blue accent
8. Filter tabs switch between active/completed/all
</verification>

<success_criteria>
- Task data flows from .idumb/ files through backend API to frontend
- Dual-surface layout: sidebar + detail panel per user decision
- Rich task cards with status badges, hierarchy, progress
- Graceful empty states when no governance initialized
- Read-only for Phase 1 (mutations via OpenCode agent tools)
</success_criteria>

<output>
After completion, create `.planning/phases/01-engine-task-bus/01-04-SUMMARY.md`
</output>
