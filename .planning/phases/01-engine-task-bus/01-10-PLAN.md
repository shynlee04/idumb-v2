---
phase: 01-engine-task-bus
plan: 10
type: execute
wave: 2
depends_on: ["01-09"]
files_modified:
  - src/dashboard/frontend/src/pages/SettingsPage.tsx
  - src/dashboard/frontend/src/App.tsx
  - src/dashboard/frontend/src/components/layout/Sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /settings from the sidebar"
    - "Settings page has 4 tabs: Appearance, AI, Connection, Governance"
    - "Appearance tab shows theme toggle (already exists) and accent color"
    - "AI tab shows configured providers with model count and default model/agent selection"
    - "Connection tab shows engine status (URL, PID, project dir) and health"
    - "Governance tab shows current governance mode"
    - "Sidebar connection indicator shows provider count and engine health"
  artifacts:
    - path: "src/dashboard/frontend/src/pages/SettingsPage.tsx"
      provides: "Tabbed settings page with 4 sections"
      exports: ["SettingsPage"]
    - path: "src/dashboard/frontend/src/App.tsx"
      provides: "/settings route in AppShell"
      contains: "settings"
    - path: "src/dashboard/frontend/src/components/layout/Sidebar.tsx"
      provides: "Enhanced EngineIndicator with provider count"
      contains: "useProviders"
  key_links:
    - from: "pages/SettingsPage.tsx AI tab"
      to: "hooks/useConfig.ts â†’ useProviders()"
      via: "React Query hook"
      pattern: "useProviders"
    - from: "pages/SettingsPage.tsx Connection tab"
      to: "hooks/useEngine.ts â†’ useEngineStatus()"
      via: "React Query hook"
      pattern: "useEngineStatus"
    - from: "App.tsx /settings route"
      to: "pages/SettingsPage.tsx"
      via: "React Router Route"
      pattern: "Route.*settings.*SettingsPage"
    - from: "components/layout/Sidebar.tsx EngineIndicator"
      to: "hooks/useConfig.ts â†’ useProviders()"
      via: "provider count display"
      pattern: "useProviders"
---

<objective>
Close configuration gap (G4, G5 from 01-RESEARCH-config-gap): Create a Settings page with 4 tabs (Appearance, AI, Connection, Governance) and enhance the sidebar connection indicator to show provider health.

Purpose: Users need a central place to view and configure the app. The sidebar indicator needs to convey more than "connected/disconnected" â€” it should show provider count and health semantics.
Output: 1 new page (SettingsPage.tsx), 1 modified route file (App.tsx), 1 enhanced component (Sidebar.tsx).
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-engine-task-bus/01-RESEARCH-config-gap-2026-02-10.md
@.planning/phases/01-engine-task-bus/01-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings page with 4 tabs + route wiring</name>
  <files>
    src/dashboard/frontend/src/pages/SettingsPage.tsx
    src/dashboard/frontend/src/App.tsx
  </files>
  <action>
  Create the Settings page and add its route.

  **1. `src/dashboard/frontend/src/pages/SettingsPage.tsx`** â€” Create tabbed settings page.

  Use plain Tailwind tab pattern (no shadcn Tabs component â€” not installed). Pattern: button row with active state, conditional content rendering.

  ```tsx
  import { useState } from "react"
  import { Settings, Palette, Cpu, Wifi, Shield } from "lucide-react"
  import { useEngineStatus } from "@/hooks/useEngine"
  import { useProviders, useAgents } from "@/hooks/useConfig"
  import { cn } from "@/lib/utils"

  type Tab = "appearance" | "ai" | "connection" | "governance"

  const tabs: { id: Tab; label: string; icon: React.ElementType }[] = [
    { id: "appearance", label: "Appearance", icon: Palette },
    { id: "ai", label: "AI", icon: Cpu },
    { id: "connection", label: "Connection", icon: Wifi },
    { id: "governance", label: "Governance", icon: Shield },
  ]

  export function SettingsPage() {
    const [activeTab, setActiveTab] = useState<Tab>("ai")

    return (
      <div className="mx-auto max-w-3xl px-6 py-8">
        <div className="mb-6 flex items-center gap-3">
          <Settings className="h-5 w-5 text-zinc-400" />
          <h1 className="text-lg font-semibold">Settings</h1>
        </div>

        {/* Tab bar */}
        <div className="mb-6 flex gap-1 border-b border-border">
          {tabs.map(({ id, label, icon: Icon }) => (
            <button
              key={id}
              type="button"
              className={cn(
                "flex items-center gap-1.5 px-3 py-2 text-sm transition-colors",
                activeTab === id
                  ? "border-b-2 border-blue-500 text-zinc-100"
                  : "text-zinc-400 hover:text-zinc-200"
              )}
              onClick={() => setActiveTab(id)}
            >
              <Icon className="h-3.5 w-3.5" />
              {label}
            </button>
          ))}
        </div>

        {/* Tab content */}
        {activeTab === "appearance" && <AppearanceTab />}
        {activeTab === "ai" && <AITab />}
        {activeTab === "connection" && <ConnectionTab />}
        {activeTab === "governance" && <GovernanceTab />}
      </div>
    )
  }
  ```

  **AppearanceTab** â€” Theme toggle. Read current theme from `document.documentElement.classList` or localStorage. Three buttons: Light, Dark, System.

  ```tsx
  function AppearanceTab() {
    const [theme, setTheme] = useState(() =>
      localStorage.getItem("idumb-theme") ?? "dark"
    )

    const applyTheme = (t: string) => {
      setTheme(t)
      localStorage.setItem("idumb-theme", t)
      // The app currently only supports dark mode (zinc-950 backgrounds).
      // Full theme switching is a future enhancement.
    }

    return (
      <div className="space-y-6">
        <div>
          <h3 className="text-sm font-medium">Theme</h3>
          <p className="mt-1 text-xs text-zinc-500">Choose the application color scheme</p>
          <div className="mt-3 flex gap-2">
            {["light", "dark", "system"].map((t) => (
              <button
                key={t}
                type="button"
                className={cn(
                  "rounded-md border px-4 py-2 text-xs capitalize transition-colors",
                  theme === t
                    ? "border-blue-500 bg-blue-500/10 text-blue-300"
                    : "border-border text-zinc-400 hover:bg-zinc-800/60"
                )}
                onClick={() => applyTheme(t)}
              >
                {t}
              </button>
            ))}
          </div>
        </div>
      </div>
    )
  }
  ```

  **AITab** â€” Show configured providers with model count. Uses `useProviders()` and `useAgents()` from hooks/useConfig.ts (created in plan 01-09).

  ```tsx
  function AITab() {
    const { data: providers = [], isLoading: providersLoading } = useProviders()
    const { data: agents = [], isLoading: agentsLoading } = useAgents()

    return (
      <div className="space-y-6">
        {/* Providers section */}
        <div>
          <h3 className="text-sm font-medium">Configured Providers</h3>
          <p className="mt-1 text-xs text-zinc-500">AI providers available via your OpenCode instance</p>
          <div className="mt-3 space-y-2">
            {providersLoading ? (
              <p className="text-xs text-zinc-500">Loading providers...</p>
            ) : providers.length === 0 ? (
              <p className="text-xs text-zinc-500">No providers configured. Check your OpenCode config.</p>
            ) : (
              providers.map((p) => (
                <div key={p.id} className="flex items-center justify-between rounded-md border border-border px-3 py-2">
                  <div>
                    <p className="text-sm text-zinc-200">{p.name || p.id}</p>
                    <p className="text-xs text-zinc-500">{p.id}</p>
                  </div>
                  <span className="rounded bg-zinc-800 px-2 py-0.5 text-xs text-zinc-400">
                    {(p.models ?? []).length} model{(p.models ?? []).length !== 1 ? "s" : ""}
                  </span>
                </div>
              ))
            )}
          </div>
        </div>

        {/* Agents section */}
        <div>
          <h3 className="text-sm font-medium">Available Agents</h3>
          <p className="mt-1 text-xs text-zinc-500">Agents registered with your OpenCode instance</p>
          <div className="mt-3 space-y-2">
            {agentsLoading ? (
              <p className="text-xs text-zinc-500">Loading agents...</p>
            ) : agents.length === 0 ? (
              <p className="text-xs text-zinc-500">No custom agents. Install iDumb to deploy agents.</p>
            ) : (
              agents.map((a) => (
                <div key={a.id} className="rounded-md border border-border px-3 py-2">
                  <p className="text-sm text-zinc-200">{a.name || a.id}</p>
                  {a.description ? (
                    <p className="mt-0.5 text-xs text-zinc-500">{a.description}</p>
                  ) : null}
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    )
  }
  ```

  **ConnectionTab** â€” Show engine status using `useEngineStatus()`.

  ```tsx
  function ConnectionTab() {
    const { data: status, isLoading } = useEngineStatus()

    return (
      <div className="space-y-6">
        <div>
          <h3 className="text-sm font-medium">OpenCode Engine</h3>
          <p className="mt-1 text-xs text-zinc-500">Connection to the OpenCode server</p>

          {isLoading ? (
            <p className="mt-3 text-xs text-zinc-500">Checking connection...</p>
          ) : (
            <div className="mt-3 space-y-3">
              <div className="flex items-center gap-2">
                <span className={cn(
                  "h-2.5 w-2.5 rounded-full",
                  status?.running ? "bg-green-500" : "bg-red-500"
                )} />
                <span className="text-sm text-zinc-200">
                  {status?.running ? "Connected" : "Disconnected"}
                </span>
              </div>

              {status?.running && (
                <div className="space-y-2 rounded-md border border-border px-3 py-2 text-xs">
                  {status.url ? (
                    <div className="flex justify-between">
                      <span className="text-zinc-500">URL</span>
                      <span className="text-zinc-300 font-mono">{status.url}</span>
                    </div>
                  ) : null}
                  {status.port ? (
                    <div className="flex justify-between">
                      <span className="text-zinc-500">Port</span>
                      <span className="text-zinc-300 font-mono">{status.port}</span>
                    </div>
                  ) : null}
                  {status.projectDir ? (
                    <div className="flex justify-between">
                      <span className="text-zinc-500">Project</span>
                      <span className="text-zinc-300 font-mono truncate max-w-[300px]">{status.projectDir}</span>
                    </div>
                  ) : null}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    )
  }
  ```

  **GovernanceTab** â€” Show current governance mode (readonly for now â€” mode changes require plugin config).

  ```tsx
  function GovernanceTab() {
    const mode = "standard" // TODO: Read from governance API when available

    return (
      <div className="space-y-6">
        <div>
          <h3 className="text-sm font-medium">Governance Mode</h3>
          <p className="mt-1 text-xs text-zinc-500">Controls how strictly the agent governance enforces write-gates</p>
          <div className="mt-3 grid grid-cols-2 gap-2">
            {[
              { id: "strict", label: "Strict", desc: "Task required before every write" },
              { id: "standard", label: "Standard", desc: "Balanced â€” task required, warnings for minor violations" },
              { id: "relaxed", label: "Relaxed", desc: "Light governance â€” tracking only" },
              { id: "retard", label: "Retard", desc: "Expert-only â€” maximum autonomy" },
            ].map((m) => (
              <div
                key={m.id}
                className={cn(
                  "rounded-md border px-3 py-2",
                  mode === m.id
                    ? "border-blue-500 bg-blue-500/10"
                    : "border-border"
                )}
              >
                <p className={cn("text-sm", mode === m.id ? "text-blue-300" : "text-zinc-300")}>
                  {m.label}
                </p>
                <p className="mt-0.5 text-[10px] text-zinc-500">{m.desc}</p>
              </div>
            ))}
          </div>
          <p className="mt-2 text-[10px] text-zinc-500">
            Governance mode is configured per-project via <code className="text-zinc-400">.idumb/config.json</code>
          </p>
        </div>
      </div>
    )
  }
  ```

  **2. `src/dashboard/frontend/src/App.tsx`** â€” Add the /settings route.

  Add import at top:
  ```typescript
  import { SettingsPage } from "@/pages/SettingsPage"
  ```

  Add route inside the AppShell Route group (after the tasks route, before the closing `</Route>`):
  ```tsx
  <Route path="settings" element={<SettingsPage />} />
  ```

  Note: Sidebar.tsx already has a `<NavLink to="/settings">` â€” it just pointed to a nonexistent route. Adding this route makes it functional.
  </action>
  <verify>
  1. `cd src/dashboard/frontend && npx tsc --noEmit` â€” zero TypeScript errors
  2. `cd src/dashboard/frontend && npm run build` â€” clean Vite build
  3. `grep "SettingsPage" src/dashboard/frontend/src/App.tsx` â€” route wired
  4. `grep 'path="settings"' src/dashboard/frontend/src/App.tsx` â€” route path exists
  5. `grep "useProviders" src/dashboard/frontend/src/pages/SettingsPage.tsx` â€” hook used
  6. `grep "useEngineStatus" src/dashboard/frontend/src/pages/SettingsPage.tsx` â€” hook used
  </verify>
  <done>
  Settings page exists at /settings with 4 tabs: Appearance (theme toggle), AI (provider list with model counts + agent list), Connection (engine status, URL, port, project dir), Governance (mode display). Sidebar Settings link now navigates to a real page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced connection status indicator in sidebar</name>
  <files>
    src/dashboard/frontend/src/components/layout/Sidebar.tsx
  </files>
  <action>
  Enhance the existing `EngineIndicator` function in Sidebar.tsx (currently lines 84-96) to show more meaningful health information.

  **Current EngineIndicator (replace entirely):**
  ```tsx
  function EngineIndicator() {
    const { data: status } = useEngineStatus()
    return (
      <div className="flex items-center gap-2 text-xs">
        <span className={cn("h-2 w-2 rounded-full", status?.running ? "bg-green-500" : "bg-red-500")} />
        <span className="text-zinc-400">{status?.running ? "Connected" : "Disconnected"}</span>
      </div>
    )
  }
  ```

  **New EngineIndicator:**
  ```tsx
  function EngineIndicator() {
    const { data: status } = useEngineStatus()
    const { data: providers = [] } = useProviders()

    const providerCount = providers.length
    const modelCount = providers.reduce((sum, p) => sum + (p.models?.length ?? 0), 0)

    return (
      <div className="space-y-1.5">
        <div className="flex items-center gap-2 text-xs">
          <span className={cn(
            "h-2 w-2 rounded-full",
            status?.running
              ? providerCount > 0 ? "bg-green-500" : "bg-yellow-500"
              : "bg-red-500"
          )} />
          <span className="text-zinc-400">
            {!status?.running
              ? "Disconnected"
              : providerCount > 0
                ? "Connected"
                : "No providers"}
          </span>
        </div>
        {status?.running && providerCount > 0 && (
          <p className="pl-4 text-[10px] text-zinc-500">
            {providerCount} provider{providerCount !== 1 ? "s" : ""} Â· {modelCount} model{modelCount !== 1 ? "s" : ""}
          </p>
        )}
      </div>
    )
  }
  ```

  **Import changes:** Add `useProviders` to the imports. Currently Sidebar.tsx imports from `@/hooks/useEngine`. Add:
  ```typescript
  import { useProviders } from "@/hooks/useConfig"
  ```

  **Health semantics:**
  - ðŸŸ¢ Green: Connected AND at least 1 provider configured
  - ðŸŸ¡ Yellow: Connected BUT no providers configured (user needs to set up API keys)
  - ðŸ”´ Red: Disconnected

  The sub-text shows provider/model counts when connected and providers exist. This gives users at-a-glance understanding of their setup health.
  </action>
  <verify>
  1. `cd src/dashboard/frontend && npx tsc --noEmit` â€” zero TypeScript errors
  2. `grep "useProviders" src/dashboard/frontend/src/components/layout/Sidebar.tsx` â€” import exists
  3. `grep "providerCount" src/dashboard/frontend/src/components/layout/Sidebar.tsx` â€” health logic exists
  4. `grep "bg-yellow-500" src/dashboard/frontend/src/components/layout/Sidebar.tsx` â€” yellow state for no-providers
  </verify>
  <done>
  Sidebar EngineIndicator shows 3-state health: green (connected + providers), yellow (connected, no providers), red (disconnected). Sub-text shows provider and model counts. Users get at-a-glance understanding of their setup health.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of config UI</name>
  <files>src/dashboard/frontend/src/pages/SettingsPage.tsx</files>
  <action>
  Human visual verification of config UI. No code changes â€” verify what was built in Tasks 1-2.

  What was built:
  1. **Plan 01-09**: Backend config routes (/api/providers, /api/agents, /api/config, /api/app) + model/agent selector components + ChatPage wiring with localStorage persistence
  2. **Plan 01-10**: Settings page at /settings with 4 tabs (Appearance, AI, Connection, Governance) + enhanced sidebar connection indicator with provider health

  Steps to verify:
  1. Start the dashboard: `cd src/dashboard && npm run dev`
  2. Navigate to `/settings` â€” verify 4 tabs render, Settings link in sidebar works
  3. Check AI tab â€” should list providers and agents from OpenCode
  4. Check Connection tab â€” should show engine URL, port, project dir
  5. Open a chat session â€” verify model selector and agent selector appear in session header bar
  6. Select a model, refresh page â€” verify selection persists
  7. Check sidebar footer â€” should show provider/model count below connection dot

  Resume signal: Type "approved" or describe issues
  </action>
  <verify>User confirms visual/functional correctness of all config UI components</verify>
  <done>User typed "approved" â€” config UI verified working</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. **TypeScript clean**: `npm run typecheck` + `cd src/dashboard/frontend && npx tsc --noEmit` â€” zero errors
2. **Frontend build**: `cd src/dashboard/frontend && npm run build` â€” clean build
3. **Test baseline**: `npm test` â€” all existing tests pass (no test regressions)
4. **Settings route works**: `/settings` NavLink in sidebar reaches SettingsPage
5. **AI tab shows data**: Providers list with model counts, agents list
6. **Model selector works**: Dropdown groups models by provider, selection persists in localStorage
7. **Agent selector works**: Dropdown lists agents with descriptions
8. **Sidebar health**: 3-state indicator (green/yellow/red) with provider/model counts
</verification>

<success_criteria>
1. Settings page renders at /settings with 4 working tabs
2. AI tab lists configured providers with model counts
3. AI tab lists available agents with descriptions
4. Connection tab shows engine status details
5. Governance tab shows governance mode options
6. Sidebar indicator shows 3-state health (green/yellow/red)
7. Sidebar shows provider and model counts when connected
8. User verifies UI looks correct and functions properly
</success_criteria>

<output>
After completion, create `.planning/phases/01-engine-task-bus/01-10-SUMMARY.md`
</output>
