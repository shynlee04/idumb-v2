# Plan 01-07: Gap Closure — 16 Audit Flaws

**Phase:** 01 (Engine + Task Bus)
**Type:** Gap closure
**Source:** Pre-UAT audit (2026-02-10)
**Total flaws:** 16 (5 critical, 9 important, 2 discrepancy)

---

## Execution Strategy

3 waves, dependency-ordered. Each wave is internally parallelizable.

---

## Wave 1 — Critical Backend Fixes (blocking UAT)

### Task 1.1: Fix `.planning` directory path in server.ts

**File:** `src/dashboard/backend/server.ts`
**Lines:** 96, 1107

**What:** `getPlanningArtifacts()` uses `join(projectDir, "planning")` — wrong. Must be `join(projectDir, ".planning")`. File watcher at line 1107 watches the same wrong directory.

**Fix:**
- Line 96: `const planningDir = join(projectDir, "planning")` → `const planningDir = join(projectDir, ".planning")`
- Line 1107: `const planningDir = join(projectDir, "planning")` → `const planningDir = join(projectDir, ".planning")`

**Verification:** `/api/artifacts` returns non-empty list when `.planning/` has files.

---

### Task 1.2: Fix SPA catch-all hanging on unregistered API routes

**File:** `src/dashboard/backend/server.ts`
**Lines:** 1196-1200

**What:** `if (req.path.startsWith("/api/")) return` exits without response. Client hangs.

**Fix:** Change `return` to `return next()` — let Express default 404 handler respond. Requires adding `next` param:
```typescript
app.get("*", (req: Request, res: Response, next) => {
  if (req.path.startsWith("/api/")) return next()
  res.sendFile(join(frontendDistPath, "index.html"))
})
```

**Verification:** `curl http://localhost:3001/api/nonexistent` returns 404 JSON, not hang.

---

### Task 1.3: Fix event subscription resource leak on prompt completion

**File:** `src/dashboard/backend/server.ts`
**Lines:** 747-749

**What:** `finally` block clears timeout and ends response but never calls `abortController.abort()`. SDK event subscription stays open.

**Fix:** Add `abortController.abort()` in `finally`:
```typescript
} finally {
  abortController.abort()
  clearTimeout(timeout)
  res.end()
}
```

**Verification:** After prompt completes, no orphan event subscriptions remain.

---

### Task 1.4: Unify `resolveProjectDir` usage across all routes

**File:** `src/dashboard/backend/server.ts`
**Lines:** 406, 414, 426, 450, 755, 763, 793, 854, 951, 971, 1006, 1038

**What:** 12 routes use `req.header("X-Project-Dir") || process.cwd()` directly, bypassing `configuredProjectDir` fallback.

**Fix:** Replace every instance of `req.header("X-Project-Dir") || process.cwd()` with `resolveProjectDir(req)`. All 12 occurrences.

**Verification:** Grep confirms zero remaining raw `req.header("X-Project-Dir")` outside of `resolveProjectDir()`.

---

### Task 1.5: Fix duplicate SIGINT/SIGTERM handler race

**Files:** `src/dashboard/backend/server.ts` (lines 1323-1333), `src/dashboard/backend/engine.ts` (lines 53-79)

**What:** Both register `process.on("SIGINT/SIGTERM")`. Both call `process.exit(0)`. Race condition.

**Fix:** Remove signal handlers from `engine.ts`. The server's `stopServer()` already calls `stopRuntimeEngine()`, so engine cleanup is covered. In `engine.ts`, delete `installShutdownHandlers()` function and its call site at line 92. Remove `shutdownHandlersInstalled` flag.

**Verification:** Only one set of SIGINT/SIGTERM handlers remains (in `server.ts`).

---

### Task 1.6: Fix `OPENCOD_PORT` typo and `implamentation` typo

**File:** `src/dashboard/backend/server.ts`
**Lines:** 126, 478, 506, 1172

**Fix:**
- Lines 478, 506, 1172: Remove `process.env.OPENCOD_PORT ??` entirely — keep only `process.env.OPENCODE_PORT`.
- Line 126: `"implamentation-plan-turn-based"` → `"implementation-plan-turn-based"`

**Verification:** Grep confirms zero `OPENCOD_PORT` and zero `implamentation`.

---

### Task 1.7: Increase prompt timeout from 45s to 5 minutes

**File:** `src/dashboard/backend/server.ts`
**Lines:** 700-702

**What:** 45-second timeout aborts legitimate long-running agent turns.

**Fix:** `45_000` → `300_000` (5 minutes). Add comment explaining why.

**Verification:** Line reads `300_000`.

---

## Wave 2 — Critical Frontend Fixes (blocking UAT)

### Task 2.1: Fix `API_BASE` to use relative paths

**File:** `src/dashboard/frontend/src/lib/api.ts`
**Line:** 1

**What:** Hardcoded `http://localhost:3001` bypasses Vite proxy and breaks on port retry.

**Fix:** `const API_BASE = import.meta.env.VITE_API_URL || "http://localhost:3001"` → `const API_BASE = import.meta.env.VITE_API_URL || ""`

**Verification:** All API calls use relative `/api/*` paths in dev mode. Vite proxy routes them correctly.

---

### Task 2.2: Remove duplicate `API_BASE` from ProjectHealthCard

**File:** `src/dashboard/frontend/src/components/dashboard/ProjectHealthCard.tsx`
**Line:** 8

**What:** Redeclares `API_BASE` instead of importing from `api.ts`.

**Fix:** Remove line 8 (`const API_BASE = ...`). Import `api` from `@/lib/api`. Change `fetch(\`${API_BASE}/api/health\`)` to `fetch(\`${api.eventsUrl().replace('/api/events', '/api/health')}\`)` — actually simpler: since API_BASE is now `""` in api.ts, just use `fetch("/api/health")`.

**Verification:** Zero occurrences of `API_BASE` outside of `api.ts`.

---

### Task 2.3: Fix DelegationThread toggle — per-child expanded state

**File:** `src/dashboard/frontend/src/components/chat/DelegationThread.tsx`
**Lines:** 10-36

**What:** Single `useState(false)` toggles all children together.

**Fix:** Replace `useState(false)` with `useState<Set<string>>(new Set())`. Each child button toggles its own ID in the set:
```tsx
function DelegationNode({ sessionId, depth }: { sessionId: string; depth: number }) {
  const { data: children = [] } = useSessionChildren(sessionId)
  const [expanded, setExpanded] = useState<Set<string>>(new Set())

  const toggle = (id: string) =>
    setExpanded((prev) => {
      const next = new Set(prev)
      if (next.has(id)) next.delete(id)
      else next.add(id)
      return next
    })

  if (children.length === 0) return null

  return (
    <div className="mt-2 border-l border-indigo-500/30 pl-3" style={{ marginLeft: `${depth * 12}px` }}>
      {children.map((child) => (
        <div key={child.id} className="mb-2 rounded border border-indigo-500/30 bg-indigo-500/10 p-2">
          <button
            type="button"
            className="flex w-full items-center gap-2 text-left text-xs text-indigo-100"
            onClick={() => toggle(child.id)}
          >
            {expanded.has(child.id) ? <ChevronDown className="h-3.5 w-3.5" /> : <ChevronRight className="h-3.5 w-3.5" />}
            <span className="font-semibold">{child.title || `Delegated ${child.id.slice(0, 8)}`}</span>
          </button>

          {expanded.has(child.id) && depth < 3 ? (
            <DelegationNode sessionId={child.id} depth={depth + 1} />
          ) : null}
        </div>
      ))}
    </div>
  )
}
```

**Verification:** Click one child, only that child expands. Others stay collapsed.

---

### Task 2.4: Add React Error Boundary

**File:** NEW — `src/dashboard/frontend/src/components/layout/ErrorBoundary.tsx`
**Also:** `src/dashboard/frontend/src/App.tsx`

**What:** No error boundary. Render crash = white screen.

**Fix:** Create class component `ErrorBoundary` with `getDerivedStateFromError` + `componentDidCatch`. Shows error message with retry button. Wrap `<Routes>` in `App.tsx` with `<ErrorBoundary>`.

**Verification:** Frontend typecheck passes. `ErrorBoundary` wraps routes.

---

### Task 2.5: Fix GovernanceBar stale timestamp

**File:** `src/dashboard/frontend/src/components/governance/GovernanceBar.tsx`
**Lines:** 36, 80

**What:** "Xs ago" computed at render time, never updates.

**Fix:** Add a `useEffect` with 1-second interval that forces re-render via tick state:
```tsx
const [tick, setTick] = useState(0)
useEffect(() => {
  if (!lastEventAt) return
  const interval = setInterval(() => setTick((t) => t + 1), 1000)
  return () => clearInterval(interval)
}, [lastEventAt])
```
The `tick` state change triggers re-render, recomputing `Date.now() - lastEventAt`.

**Verification:** Timestamp increments every second in the browser.

---

## Wave 3 — Cleanup + Documentation

### Task 3.1: Delete 12 orphaned component files

**Files to delete:**
```
src/dashboard/frontend/src/components/layout/DashboardLayout.tsx
src/dashboard/frontend/src/components/layout/Panel.tsx
src/dashboard/frontend/src/components/panels/BrainKnowledgePanel.tsx
src/dashboard/frontend/src/components/panels/DelegationChainPanel.tsx
src/dashboard/frontend/src/components/panels/PlanningArtifactsPanel.tsx
src/dashboard/frontend/src/components/panels/TaskHierarchyPanel.tsx
src/dashboard/frontend/src/components/panels/TaskGraphPanel.tsx
src/dashboard/frontend/src/components/artifacts/ArtifactViewer.tsx
src/dashboard/frontend/src/components/artifacts/ArtifactComments.tsx
src/dashboard/frontend/src/components/artifacts/ArtifactMetadata.tsx
src/dashboard/frontend/src/components/artifacts/InlineEditor.tsx
src/dashboard/frontend/src/components/ui/badge.tsx
```

**Also check:** `src/dashboard/shared/schema-types.ts` and `src/dashboard/shared/comments-types.ts` — if only consumed by deleted files, delete them too.

**Verification:** Frontend typecheck and build still pass. No import errors.

---

### Task 3.2: Delete duplicate 01-01-revised-SUMMARY.md

**File:** `.planning/phases/01-engine-task-bus/01-01-revised-SUMMARY.md`

**What:** Two summaries for 01-01. Keep `01-01-SUMMARY.md` (canonical), delete `01-01-revised-SUMMARY.md`.

**Verification:** Only one 01-01 summary exists.

---

### Task 3.3: Document SC-4 partial implementation as known gap

**File:** `.planning/phases/01-engine-task-bus/01-06-PLAN.md` (or STATE.md)

**What:** Success Criterion 4 ("Agent sessions spawned and coordinated programmatically") is only passively visualized, not actively orchestrated. This is a known scope limitation of Phase 1 — active coordination is Phase 2+ territory.

**Fix:** Add a note in STATE.md under "Recent Decisions" documenting this as intentional Phase 1 scope:
```
| SC-4 scoped to passive delegation display; active orchestration deferred to Phase 2 | 2026-02-10 | Phase 1 |
```

**Verification:** STATE.md documents the decision.

---

## Post-Fix Verification Sequence

After all 3 waves complete:

1. `npm run typecheck` — zero errors
2. `cd src/dashboard/frontend && npx tsc --noEmit` — zero errors
3. `cd src/dashboard/frontend && npm run build` — clean build
4. `npm test` — all suites pass, no regressions
5. Grep validations:
   - `grep -r 'OPENCOD_PORT' src/` → 0 matches
   - `grep -r 'implamentation' src/` → 0 matches
   - `grep -r 'API_BASE' src/dashboard/frontend/src/` → only in `api.ts`
   - `grep -r 'req.header.*X-Project-Dir.*process.cwd' src/dashboard/backend/` → 0 matches outside `resolveProjectDir`

---

## Issue ↔ Task Mapping

| # | Issue | Severity | Task |
|---|-------|----------|------|
| 1 | Wrong `.planning` path | Critical | 1.1 |
| 2 | SPA catch-all hangs | Critical | 1.2 |
| 3 | Hardcoded `API_BASE` | Critical | 2.1 |
| 4 | DelegationThread toggle | Critical | 2.3 |
| 5 | Event subscription leak | Critical | 1.3 |
| 6 | Duplicate signal handlers | Important | 1.5 |
| 7 | 12 orphaned components | Important | 3.1 |
| 8 | No Error Boundary | Important | 2.4 |
| 9 | `OPENCOD_PORT` typo | Important | 1.6 |
| 10 | Inconsistent resolveProjectDir | Important | 1.4 |
| 11 | Duplicate `API_BASE` | Important | 2.2 |
| 12 | 45s prompt timeout | Important | 1.7 |
| 13 | GovernanceBar stale timestamp | Important | 2.5 |
| 14 | `implamentation` typo | Important | 1.6 |
| 15 | SC-4 partial implementation | Discrepancy | 3.3 |
| 16 | Two 01-01 summaries | Discrepancy | 3.2 |

**Coverage: 16/16 — 100%**
