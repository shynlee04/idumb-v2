---
milestone: v2.0
audited: 2026-02-11T16:25:00Z
status: gaps_found
scope: partial (Phases 5, 6, 11 completed — cross-phase impact audit before Phase 7)
scores:
  requirements: 8/25
  phases_complete: 3/7
  integration: 6/9
  flows: 2/2 (structural — need runtime verification)
gaps:
  build:
    - "Production build (npm run build:app) fails — Monaco manualChunks vs Vite SSR external conflict"
  typecheck:
    - "app/ typecheck fails — unused @ts-expect-error in __root.tsx line 23"
  type_governance:
    - "config.ts imports 4 SDK types directly from @opencode-ai/sdk (bypasses engine-types.ts gateway)"
    - "sessions.ts line 143: as Record<string, unknown> cast on SDK data — banned by Phase 11 AGENTS.md"
    - "sessions.ts lines 107-108: JSON.parse(JSON.stringify()) destroys type chain after Zod validation"
  config_drift:
    - "@shared alias in tsconfig.app.json and vite.config.ts points to deleted path src/dashboard/shared/"
    - "CLAUDE.md test baseline stale: claims 10 suites/~512 assertions, actual is 9 suites/591 assertions"
tech_debt:
  - phase: 05-framework-foundation
    items:
      - "SSE routes need runtime verification (never human-tested)"
      - "Drizzle ORM DB path discrepancy: code says .idumb/data/idumb.db, Phase 5 docs say .data/idumb.db"
  - phase: 06-ide-shell
    items:
      - "IDEShell.tsx dead derived state: isSidebarCollapsed/isTerminalCollapsed computed but unused in JSX"
      - "TerminalPlaceholder is static content (expected — Phase 7 scope)"
  - phase: 11-sdk-type-realignment
    items:
      - "config.ts 4 missing re-exports (Provider, Agent, Path, VcsInfo) — Phase 7 will need them"
      - "AGENTS.md False Alarm Registry says 11 Part union members, SDK has 12 (includes subtask)"
  - phase: 1A-plugin-demotion
    items:
      - "workspaceConfig Drizzle table defined but never consumed by any server function"
---

# Milestone v2.0 — Cross-Phase Impact Audit Report

**Milestone:** v2.0 — AI Code IDE + Workspace Foundation
**Scope:** Phases 5 (Framework), 6 (IDE Shell), 11 (SDK Types) — pre-Phase 7 impact analysis
**Audited:** 2026-02-11
**Status:** GAPS FOUND

## Executive Summary

Three phases are complete (5, 6, 11). Phase 11's cross-cutting SDK type changes successfully improved the type chain across phases, but exposed and created several integration gaps. **Two are blockers** for Phase 7: the production build failure and the app typecheck failure. Several type governance violations exist that, if not fixed, will propagate into Phase 7 code.

## Phase Verification Summary

| Phase | Verification Status | Gaps | Tech Debt |
|-------|--------------------|------|-----------|
| 1A: Plugin Demotion | gaps_found (3.5/5 ROADMAP SC) | @opencode-ai/sdk dep FIXED ✓ | workspaceConfig table unused |
| 5: Framework Foundation | human_needed (3/4) | SSE routes FIXED ✓ | Runtime verification still needed |
| 6: IDE Shell | passed (3/3) | All gaps closed ✓ | Dead derived state in IDEShell.tsx |
| 11: SDK Type Architecture | passed (5/5) | None | config.ts bypass, doc inaccuracies |

## Critical Gaps (Blockers)

### GAP-1: Production Build Fails — Monaco SSR Externals Conflict

**Severity:** BLOCKER
**File:** `app/vite.config.ts` lines 31-39
**Introduced by:** Phase 6 (IDE Shell — Monaco editor addition)
**Discovered by:** This audit

```
✗ Build failed in 743ms
"monaco-editor" cannot be included in manualChunks because it is resolved
as an external module by the "external" option or plugins.
```

**Root cause:** `manualChunks: { 'monaco-editor': ['monaco-editor'] }` conflicts with the SSR build where `monaco-editor` resolves as external. The client build succeeds (29.57s), but the SSR build fails because Rollup can't put an external module into a manual chunk.

**Impact:** Cannot deploy to production. Dev server works fine, so this was invisible during development.

**Fix:** Remove `monaco-editor` from `manualChunks` — Vite's lazy import via `MonacoEditor.lazy.tsx` already achieves code splitting. Or conditionally apply `manualChunks` only to the client build.

### GAP-2: App TypeScript Check Fails

**Severity:** BLOCKER (violates CLAUDE.md "zero TypeScript errors at all times")
**File:** `app/routes/__root.tsx` line 23
**Error:** `TS2578: Unused '@ts-expect-error' directive.`

```typescript
// @ts-expect-error — Vite ?url import, resolved at build time
import appCss from "@/styles/app.css?url"
```

**Root cause:** A dependency upgrade (likely TanStack Start or Vite) added proper type declarations for `?url` imports, making the error suppression directive unnecessary. This happened silently during Phase 11 or a dependency update.

**Fix:** Remove the `@ts-expect-error` comment. The import works without it now.

## Type Governance Violations (Phase 11 Drift)

### GOV-1: Direct SDK Import in config.ts

**File:** `app/server/config.ts` line 17
**Rule violated:** Import Path Rules in AGENTS.md — "All app/ code imports SDK types from engine-types.ts"

```typescript
import type { Provider, Agent, Path, VcsInfo } from "@opencode-ai/sdk"
```

**Impact:** Phase 7 builds config UI (CHAT-05). If it follows config.ts patterns, the violation propagates. These 4 types need re-exporting through `engine-types.ts`.

### GOV-2: `as Record<string, unknown>` Cast on SDK Data

**File:** `app/server/sessions.ts` line 143
**Rule violated:** AGENTS.md Banned Pattern #1 — "as any on SDK types"

```typescript
const statusMap = unwrapSdkResult(result) as Record<string, unknown>
```

**Impact:** The SDK's `session.status()` return type is unknown. The cast sidesteps type safety. Should use Zod validation instead.

### GOV-3: JSON Roundtrip Destroys Type Chain

**File:** `app/server/sessions.ts` lines 107-108
**Pattern:** After Zod validation, data is immediately serialized/deserialized

```typescript
validateMessages(messages)
return JSON.parse(JSON.stringify(messages))
```

**Impact:** Phase 7's ChatMessage component receives untyped data. The Zod validation runs (for error detection) but the return type is `any`. Phase 11 established a type chain (SDK → Zod → hook → component), but this link breaks it.

**Note:** This workaround exists because TanStack Start's serialization doesn't accept `unknown` in index signatures. The fix requires either a type assertion after validation or a Zod `.parse()` (not `.safeParse()`) that returns the typed result directly.

## Configuration Drift

### DRIFT-1: Dead `@shared` Alias

**Files:** `tsconfig.app.json` line 18, `app/vite.config.ts` line 20
**Problem:** Both define `@shared → src/dashboard/shared/` which was deleted in Phase 1A. No code uses the alias currently, but it's a trap for Phase 7 developers.
**Fix:** Remove from both config files.

### DRIFT-2: Test Baseline Stale in CLAUDE.md

**Documented:** 10 suites, ~512 assertions
**Actual:** 9 suites, 591 assertions
**Origin:** Phase 1A archived test suites, but the count was inaccurately updated. Later phases may have added assertions.
**Fix:** Update CLAUDE.md to "9 suites, 591 assertions"

## Cross-Phase Integration Analysis

### SDK Type Flow (Phase 11 → Phase 5 → Phase 6)

| Chain Link | Status | Evidence |
|------------|--------|----------|
| @opencode-ai/sdk → engine-types.ts | ✓ WIRED | 18 types re-exported, single gateway |
| engine-types.ts → ChatMessage.tsx | ✓ WIRED | Part, TextPart, ToolPart imported |
| engine-types.ts → chat.$sessionId.tsx | ✓ WIRED | Message, Part imported |
| sdk-validators.ts → sessions.ts | ✓ WIRED | 4 validators called at 7 boundaries |
| sdk-validators.ts → useStreaming.ts | ✓ WIRED | parseSSEEvent at line 109 |
| sdk-validators.ts → useEventStream.tsx | ✓ WIRED | parseSSEEvent at lines 77, 99 |
| config.ts → engine-types.ts | ✗ BYPASSED | 4 types imported directly from SDK |

### SSE Pipeline (Phase 5 → Phase 11)

| Chain Link | Status | Evidence |
|------------|--------|----------|
| useStreaming.ts → /api/sessions/$id/prompt | ✓ WIRED | fetch path matches route |
| useEventStream.tsx → /api/events | ✓ WIRED | EventSource path matches route |
| routeTree.gen.ts registers API routes | ✓ VERIFIED | Both routes in generated tree |
| SSE routes → SDK client | ✓ WIRED | Import getClient, sdkQuery |
| parseSSEEvent validates SSE data | ✓ WIRED | Typed parsing replaces raw JSON.parse |

### IDE Components (Phase 6 — Isolated)

| Component | SDK Type Dependency | Status |
|-----------|-------------------|--------|
| FileTree.tsx | None (uses app types) | ✓ CLEAN |
| MonacoEditor.tsx | None (uses app types) | ✓ CLEAN |
| IDEShell.tsx | None (layout only) | ✓ CLEAN |
| TabBar.tsx | None (uses store types) | ✓ CLEAN |
| ide-store.ts | None | ✓ CLEAN |
| layout-store.ts | None | ✓ CLEAN |

Phase 6 components are fully isolated from Phase 11's SDK type changes. No cross-phase impact.

### Server Functions → Hooks → Components

| Server Function | Hook Consumer | Component Consumer | Status |
|----------------|---------------|-------------------|--------|
| getSessionsFn | useSession (getSessionsFn) | chat.tsx sidebar | ✓ WIRED |
| createSessionFn | useSession (createSessionFn) | chat.tsx | ✓ WIRED |
| getSessionFn | useSession | chat.$sessionId.tsx | ✓ WIRED |
| getSessionMessagesFn | useSession (useSessionMessages) | chat.$sessionId.tsx | ✓ WIRED |
| getEngineStatusFn | useEngine | __root.tsx + layout | ✓ WIRED |
| listDirFn | useFiles (useDirectory) | FileTree.tsx | ✓ WIRED |
| readFileFn/writeFileFn | — (direct import) | MonacoEditor.tsx | ✓ WIRED |
| getSettingFn etc. | — (no hook wrapper) | — (no UI consumer) | ⚠️ ORPHANED |

Settings server functions are wired to Drizzle but have no React Query hooks or UI consumers. Phase 7 (CHAT-05: config UI) will need to create these hooks.

## Requirements Coverage

| Requirement | Phase | Status | Notes |
|-------------|-------|--------|-------|
| FND-01 | 5 | ✓ SATISFIED | TanStack Start SPA working |
| FND-02 | 5+11 | ✓ SATISFIED | Server functions + SDK type governance |
| FND-03 | 5 | ? NEEDS RUNTIME | SSE routes exist, structurally wired, untested at runtime |
| FND-04 | 5 | ✓ SATISFIED | Drizzle + SQLite working |
| IDE-01 | 6 | ✓ SATISFIED | Monaco editor verified |
| IDE-02 | 6 | ✓ SATISFIED | File tree verified |
| IDE-05 | 6 | ✓ SATISFIED | Resizable panels verified |
| IDE-03 | 7 | PENDING | Phase 7 scope |
| CHAT-01 | 7 | PENDING | Phase 7 scope (but ChatMessage Part rendering done by Phase 11) |
| CHAT-02 | 7 | PENDING | Phase 7 scope |
| CHAT-05 | 7 | PENDING | Phase 7 scope |
| CHAT-03 | 8 | PENDING | — |
| CHAT-04 | 8 | PENDING | — |
| IDE-04 | 8 | PENDING | — |
| CHAT-06 | 8 | PENDING | — |
| DF-01 | 8 | PENDING | — |
| DF-06 | 8 | PENDING | — |
| DF-02..05,07 | 9 | PENDING | — |
| I18N-01..03 | 10 | PENDING | — |

**Satisfied:** 7/25 | **Needs runtime:** 1/25 | **Pending:** 17/25

## Phase 7 Readiness Assessment

### What Phase 7 Will Build On

Phase 7 needs: rich chat rendering (CHAT-01), step clustering (CHAT-02), integrated terminal (IDE-03), config UI (CHAT-05).

| Foundation | Ready? | Gap |
|-----------|--------|-----|
| ChatMessage.tsx Part rendering | ✓ Yes | 12 SDK Part types handled (text, tool, reasoning, file + 8 meta) |
| useStreaming SSE parsing | ✓ Yes | parseSSEEvent provides typed events |
| Server functions for sessions | ✓ Yes | 8 functions with Zod validation |
| Server functions for config | ⚠️ Partial | Functions exist but use direct SDK imports; no hook wrappers |
| Server functions for settings | ⚠️ Partial | CRUD exists but no React Query hooks |
| Terminal infrastructure | ✗ No | Nothing exists — need xterm.js + node-pty + WebSocket |
| Production build | ✗ No | Cannot build for deployment |
| App typecheck | ✗ No | Fails with unused @ts-expect-error |

### Risks for Phase 7

1. **Build must work before Phase 7 starts** — can't add features to a broken build
2. **Config server functions' direct SDK imports** will spread if Phase 7 copies the pattern
3. **Settings hooks gap** — Phase 7 plan 07-04 (config/settings UI) needs hooks that don't exist
4. **Terminal requires WebSocket** — different transport from SSE, needs new server infrastructure

## Integration Checker Findings (Cross-Phase Wiring)

### E2E Flow Verification

| Flow | Steps Verified | Status |
|------|---------------|--------|
| Chat: Open → Engine → Session → Send → Stream → Render → Reload | 12/12 | COMPLETE |
| IDE: Navigate → Tree → Click → Tab → Edit → Dirty → Save → Context Menu | 9/9 | COMPLETE |

Both user-facing flows are structurally connected end-to-end. No broken wiring.

### Orphaned Infrastructure (Phase 7 Readiness)

| Category | Count | Items |
|----------|-------|-------|
| Server functions (no hook/UI consumer) | 5 | getSessionStatusFn, 4x settings CRUD |
| Hooks (no component consumer) | 8 | useHealthCheck, useProviders, useAgents, useConfig, useAppInfo, useSessionChildren, useSession, useAbortSession |
| Types (defined, never imported) | 9 | 6x Session*Response, DashboardConfig, PortConfig, SessionPromptRequest |
| DB table (never queried) | 1 | workspaceConfig |
| Validator (never consumed) | 1 | PromptRequestSchema |

These are infrastructure laid for Phase 7, not bugs. But their existence means Phase 7 can build faster — hooks and server functions are pre-wired.

### Abort Behavior Gap

`ChatInput.tsx` calls `useStreaming.abort()` which aborts the client-side `fetch`, but does NOT call `abortSessionFn` which would abort the SDK session server-side. If a user aborts mid-stream, the server-side session may continue running to completion. Phase 7 should wire `abort` to both client-side fetch abort AND server-side `abortSessionFn`.

### SDK Import Compliance

| File | Imports from @opencode-ai/sdk | Verdict |
|------|------------------------------|---------|
| engine-types.ts | 18 type re-exports | CORRECT (gateway) |
| sdk-client.server.ts | createOpencode, createOpencodeClient, OpencodeClient | ACCEPTABLE (runtime SDK constructors) |
| config.ts | Provider, Agent, Path, VcsInfo | VIOLATION (types should go through gateway) |

Only `config.ts` is a real violation. `sdk-client.server.ts` is the SDK client itself — it must import runtime functions directly.

## Recommendations

### Before Phase 7 (gap closure — estimated 30 min)

1. **Fix GAP-1** — Remove `monaco-editor` from `manualChunks` in vite.config.ts
2. **Fix GAP-2** — Remove unused `@ts-expect-error` in __root.tsx
3. **Fix GOV-1** — Add Provider, Agent, Path, VcsInfo to engine-types.ts re-exports; update config.ts import
4. **Fix DRIFT-1** — Remove dead `@shared` alias from tsconfig.app.json and vite.config.ts
5. **Fix DRIFT-2** — Update test baseline in CLAUDE.md (9 suites, 591 assertions)

### During Phase 7

6. **Address GOV-2** — Replace `as Record<string, unknown>` with Zod validation in sessions.ts
7. **Address GOV-3** — Use Zod `.parse()` return type instead of JSON roundtrip in getSessionMessagesFn
8. **Wire abort** — Connect `useStreaming.abort()` to also call `abortSessionFn` server-side
9. **Create settings hooks** — React Query wrappers for settings server functions
10. **Create useSessionStatus hook** — Wrap getSessionStatusFn for busy/idle indicators

### Track as Tech Debt

11. Dead derived state in IDEShell.tsx (isSidebarCollapsed/isTerminalCollapsed computed but unused in JSX)
12. workspaceConfig table unused (defined in schema.ts, never queried)
13. PromptRequestSchema defined but unused (SSE route uses manual JSON parsing)
14. AGENTS.md False Alarm Registry says 11 Part union members, SDK has 12 (includes subtask)
15. Drizzle DB path documentation discrepancy (.idumb/data/ vs .data/)
16. 9 orphaned response/config types in engine-types.ts (clean up or document as reserved)

---
*Audited: 2026-02-11*
*Auditor: Claude (opus-4-6-thinking)*
*Integration checker: gsd-integration-checker (sonnet) — 62 tool calls, verified 28 connected exports, 20 orphaned exports, 2 E2E flows*
*Method: Phase verification aggregation + live codebase verification + cross-phase wiring analysis*
