prompt = "<purpose>\nOrchestrate `/gsd:new-milestone` from context loading through roadmap approval.\n\nDesign goals:\n- Keep base context small\n- Load heavy assets only when needed\n- Leverage existing validated requirements\n</purpose>\n\n<always_loaded>\nLoad these first:\n\n- `./.gemini/get-shit-done/references/questioning.md`\n- `./.gemini/get-shit-done/references/ui-brand.md`\n- `./.gemini/get-shit-done/templates/project.md`\n- `./.gemini/get-shit-done/templates/requirements.md`\n</always_loaded>\n\n<process>\n\n## Phase 1: Load Context\n\nLoad project context:\n\n```bash\ncat .planning/PROJECT.md\ncat .planning/STATE.md\ncat .planning/MILESTONES.md 2>/dev/null\ncat .planning/config.json 2>/dev/null\ncat .planning/MILESTONE-CONTEXT.md 2>/dev/null\n```\n\nError if PROJECT.md missing:\n```\nERROR: No project found. Run /gsd:new-project first.\n```\n\n## Phase 2: Gather Milestone Goals\n\n**If MILESTONE-CONTEXT.md exists:**\n- Use features and scope from discuss-milestone\n- Present summary for confirmation\n\n**If no context file:**\n- Present what shipped in last milestone\n- Start with: \"What do you want to build next?\"\n- Use AskUserQuestion to explore features, priorities, constraints\n\n## Phase 3: Determine Milestone Version\n\nParse last version from MILESTONES.md.\nSuggest next version (v1.0 → v1.1, or v2.0 for major).\n\nAskUserQuestion:\n- header: \"Version\"\n- question: \"What version for this milestone?\"\n- options:\n  - \"v[X.Y] — [suggested description]\"\n  - \"v[X+1].0 — Major version bump\"\n  - \"Custom version\"\n\n## Phase 4: Update PROJECT.md\n\nAdd/update Current Milestone section:\n\n```markdown\n## Current Milestone: v[X.Y] [Name]\n\n**Goal:** [One sentence describing milestone focus]\n\n**Target features:**\n- [Feature 1]\n- [Feature 2]\n- [Feature 3]\n```\n\nUpdate Active requirements section with new goals.\nUpdate footer timestamp.\n\n## Phase 5: Update STATE.md\n\n```markdown\n## Current Position\n\nPhase: Not started (defining requirements)\nPlan: —\nStatus: Defining requirements\nLast activity: [today] — Milestone v[X.Y] started\n```\n\nKeep Accumulated Context (decisions, blockers) from previous milestone.\n\n## Phase 6: Cleanup and Commit\n\nDelete MILESTONE-CONTEXT.md if exists (consumed).\n\n@./.gemini/get-shit-done/references/git-planning-commit.md\n\nIf committing:\n```bash\ngit add .planning/PROJECT.md .planning/STATE.md\ngit commit -m \"docs: start milestone v[X.Y] [Name]\"\n```\n\n## Phase 6.5: Resolve Model Profile\n\n@./.gemini/get-shit-done/references/model-profile-resolution.md\n\nResolve models for:\n- `gsd-project-researcher`\n- `gsd-research-synthesizer`\n- `gsd-roadmapper`\n\n## Phase 7: Research Decision\n\nAskUserQuestion:\n- header: \"Research\"\n- question: \"Research the domain ecosystem for new features before defining requirements?\"\n- options:\n  - \"Research first (Recommended)\" — Discover patterns, expected features, architecture for NEW capabilities\n  - \"Skip research\" — Go straight to requirements\n\n**If skip:** Continue to Phase 8.\n\n**If research:**\n\nDisplay `GSD ► RESEARCHING` banner.\n\n```bash\nmkdir -p .planning/research\n```\n\nCreate milestone-aware research brief:\n- Note this is SUBSEQUENT MILESTONE\n- List validated/existing capabilities (DO NOT re-research)\n- Focus on NEW features only\n\nLoad research prompt templates and spawn 4 parallel researchers:\n- Stack (additions for new features)\n- Features (expected behavior)\n- Architecture (integration)\n- Pitfalls (mistakes when adding to existing system)\n\nSpawn synthesizer for SUMMARY.md.\n\nDisplay `GSD ► RESEARCH COMPLETE ✓` banner with key findings.\n\nIf committing, commit research artifacts.\n\n## Phase 8: Define Requirements\n\nDisplay `GSD ► DEFINING REQUIREMENTS` banner.\n\nLoad context:\n- `.planning/PROJECT.md` (Validated requirements = existing)\n- `.planning/research/FEATURES.md` (if exists)\n\n**If research exists:**\n- Present features by category\n- Scope each category with AskUserQuestion (multi-select)\n\n**If no research:**\n- Gather requirements through AskUserQuestion conversation\n\nTrack:\n- Selected features → this milestone's requirements\n- Unselected table stakes → future milestone\n- Unselected differentiators → out of scope\n\nAdditions pass:\n- header: \"Additions\"\n- question: \"Any requirements research missed?\"\n- options: \"No\" / \"Yes, let me add some\"\n\nGenerate REQUIREMENTS.md:\n- v1 Requirements for THIS milestone (checkboxes, REQ-IDs)\n- Future Requirements (deferred)\n- Out of Scope (explicit exclusions)\n- Traceability section (filled by roadmap)\n\nREQ-ID format: `[CATEGORY]-[NUMBER]` (continue numbering from existing).\n\nPresent full requirements list for confirmation.\n\nIf committing, commit requirements.\n\n## Phase 9: Create Roadmap\n\nDisplay `GSD ► CREATING ROADMAP` banner.\n\n**Determine starting phase number:**\n- Read MILESTONES.md for last phase number\n- New phases continue from there\n\nCreate compact context files in `.planning/_ctx/`.\n\nSpawn gsd-roadmapper with milestone context:\n- Start phase numbering from [N]\n- Derive phases from THIS MILESTONE's requirements\n- Map every requirement to exactly one phase\n- Derive 2-5 success criteria per phase\n- Validate 100% coverage\n\nHandle returns:\n- `## ROADMAP BLOCKED`: Surface blockers, resolve, respawn\n- `## ROADMAP CREATED`: Present structured summary\n\nApproval gate:\n- header: \"Roadmap\"\n- question: \"Does this roadmap structure work for you?\"\n- options: \"Approve\" / \"Adjust phases\" / \"Review full file\"\n\nIf adjust: Collect feedback, respawn roadmapper, loop until approved.\n\nAfter approval, if committing:\n```bash\ngit add .planning/ROADMAP.md .planning/STATE.md .planning/REQUIREMENTS.md\ngit commit -m \"docs: create milestone v[X.Y] roadmap ([N] phases)\"\n```\n\n## Phase 10: Done\n\nDisplay `GSD ► MILESTONE INITIALIZED ✓` banner.\n\nShow artifact table:\n| Artifact | Location |\n|----------|----------|\n| Project | `.planning/PROJECT.md` |\n| Research | `.planning/research/` |\n| Requirements | `.planning/REQUIREMENTS.md` |\n| Roadmap | `.planning/ROADMAP.md` |\n\nShow Next Up block:\n- `/gsd:discuss-phase [N]` — gather context and clarify approach\n- optional `/gsd:plan-phase [N]`\n\n</process>\n"
