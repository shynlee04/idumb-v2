prompt = "<purpose>\nOrchestrate `/gsd:plan-phase` from validation through plan verification.\n\nDesign goals:\n- Spawn research, planner, and checker agents with fresh context\n- Build compact context files to avoid passing full source docs\n- Handle revision loop for plan quality\n</purpose>\n\n<always_loaded>\n- `./.gemini/get-shit-done/references/ui-brand.md`\n</always_loaded>\n\n<process>\n\n## Step 1: Validate Environment and Resolve Model Profile\n\n```bash\nls .planning/ 2>/dev/null || { echo \"ERROR: Run /gsd:new-project first\"; exit 1; }\n```\n\n@./.gemini/get-shit-done/references/model-profile-resolution.md\n\nResolve models for:\n- `gsd-phase-researcher`\n- `gsd-planner`\n- `gsd-plan-checker`\n\n## Step 2: Parse and Normalize Arguments\n\n@./.gemini/get-shit-done/references/phase-argument-parsing.md\n\nExtract from $ARGUMENTS:\n- Phase number (integer or decimal)\n- `--research` — Force re-research\n- `--skip-research` — Skip research\n- `--gaps` — Gap closure mode (uses VERIFICATION.md)\n- `--skip-verify` — Bypass verification loop\n\nIf no phase number: Detect next unplanned phase.\n\nCheck for existing research and plans:\n```bash\nls \"${PHASE_DIR}\"/*-RESEARCH.md 2>/dev/null\nls \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null\n```\n\n## Step 3: Validate Phase\n\n```bash\ngrep -A5 \"Phase ${PHASE}:\" .planning/ROADMAP.md 2>/dev/null || {\n  echo \"ERROR: Phase ${PHASE} not found\"\n  exit 1\n}\n```\n\nExtract phase number, name, description.\n\n## Step 4: Ensure Phase Directory and Load CONTEXT.md\n\n```bash\nPHASE_DIR=$(ls -d .planning/phases/${PHASE}-* 2>/dev/null | head -1)\nif [ -z \"$PHASE_DIR\" ]; then\n  PHASE_NAME=$(grep \"Phase ${PHASE}:\" .planning/ROADMAP.md | sed 's/.*Phase [0-9]*: //' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')\n  mkdir -p \".planning/phases/${PHASE}-${PHASE_NAME}\"\n  PHASE_DIR=\".planning/phases/${PHASE}-${PHASE_NAME}\"\nfi\nCONTEXT_CONTENT=$(cat \"${PHASE_DIR}\"/*-CONTEXT.md 2>/dev/null)\n```\n\n**CRITICAL:** Store `CONTEXT_CONTENT` now. Pass to all downstream agents.\n\n## Step 5: Handle Research\n\nSkip if `--gaps` or `--skip-research`.\n\nCheck config: `workflow.research` setting.\n\nIf RESEARCH.md exists and `--research` not set: Use existing.\n\nOtherwise spawn `gsd-phase-researcher`:\n\nDisplay: `GSD ► RESEARCHING PHASE {X}`\n\nBuild research prompt with:\n- Phase description from ROADMAP\n- Requirements (if any)\n- Prior decisions from STATE.md\n- CONTEXT_CONTENT (locked decisions, Claude's discretion, deferred)\n\nHandle returns:\n- `## RESEARCH COMPLETE` → Continue\n- `## RESEARCH BLOCKED` → Present blocker, offer options\n\n## Step 6: Check Existing Plans\n\n```bash\nls \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null\n```\n\nIf exists: Offer continue/view/replan options.\n\n## Step 7: Build Compact Context Files\n\n```bash\nmkdir -p \"${PHASE_DIR}/_ctx\"\n```\n\nCreate:\n- `planner-input.md` — phase goal, requirements, locked decisions, research findings, **full CONTEXT_CONTENT**\n- `checker-input.md` — phase goal, must-haves, requirements, verification constraints, **full CONTEXT_CONTENT**\n- `revision-input.md` — issues from checker, **full CONTEXT_CONTENT** (created during revision loop)\n\n**CRITICAL:** All three context files MUST include the full CONTEXT_CONTENT (user decisions from /gsd:discuss-phase). This ensures:\n- Planner honors locked decisions when creating tasks\n- Checker can verify plans don't contradict user decisions\n- Revision loop preserves user constraints\n\nDo not inline full STATE.md / ROADMAP.md / RESEARCH.md.\n\n## Step 8: Spawn gsd-planner\n\nDisplay: `GSD ► PLANNING PHASE {X}`\n\n```\nTask(\n  prompt=\"<planning_context>\n**Phase:** {phase_number}\n**Mode:** {standard | gap_closure}\n\n{planner_input_content}\n\n<user_decisions>\n{CONTEXT_CONTENT}\n</user_decisions>\n\nSource files available (read on demand):\n- .planning/STATE.md\n- .planning/ROADMAP.md\n- {phase_dir}/*-RESEARCH.md\n</planning_context>\n\n<constraints>\n**CRITICAL:** The <user_decisions> section contains locked decisions from /gsd:discuss-phase.\n- Plans MUST implement decisions from `## Decisions` exactly as specified\n- Plans MUST NOT include anything from `## Deferred Ideas`\n- Plans MAY exercise judgment on items in `## Claude's Discretion`\n</constraints>\n\n<output>\nPlans executable by /gsd:execute-phase.\nFrontmatter: wave, depends_on, files_modified, autonomous\nTasks in XML format with verification criteria\nmust_haves for goal-backward verification\n</output>\",\n  subagent_type=\"gsd-planner\",\n  model=\"{planner_model}\"\n)\n```\n\n## Step 9: Handle Planner Return\n\n- `## PLANNING COMPLETE` — Plans created, proceed to verification\n- `## CHECKPOINT REACHED` — Present to user, spawn continuation\n- `## PLANNING INCONCLUSIVE` — Show attempts, offer options\n\nIf `--skip-verify` or `workflow.plan_check = false`: Skip to Step 13.\n\n## Step 10: Spawn gsd-plan-checker\n\nDisplay: `GSD ► VERIFYING PLANS`\n\nRead plans:\n```bash\nPLANS_CONTENT=$(cat \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null)\n```\n\n```\nTask(\n  prompt=\"<verification_context>\n**Phase:** {phase_number}\n**Phase Goal:** {goal}\n\n**Plans:**\n{plans_content}\n\n{checker_input_content}\n\n<user_decisions>\n{CONTEXT_CONTENT}\n</user_decisions>\n</verification_context>\n\n<verification_requirement>\n**CRITICAL:** Verify Context Compliance dimension:\n- Do plans implement all locked decisions from `## Decisions`?\n- Do plans exclude everything from `## Deferred Ideas`?\n- Flag any task that contradicts a user decision as a BLOCKER.\n</verification_requirement>\n\nReturn: ## VERIFICATION PASSED or ## ISSUES FOUND\",\n  subagent_type=\"gsd-plan-checker\",\n  model=\"{checker_model}\"\n)\n```\n\n## Step 11: Handle Checker Return\n\n- `## VERIFICATION PASSED` → Proceed to Step 13\n- `## ISSUES FOUND` → Check iteration count, proceed to Step 12\n\n## Step 12: Revision Loop (Max 3 Iterations)\n\nTrack `iteration_count`.\n\nIf iteration_count < 3:\n- Display: `Sending back to planner for revision... (iteration {N}/3)`\n- Write revision-input.md with:\n  - Issues from checker\n  - **Full CONTEXT_CONTENT** (user decisions - CRITICAL for maintaining fidelity)\n- Spawn planner with revision context including `<user_decisions>{CONTEXT_CONTENT}</user_decisions>`\n- After planner returns → spawn checker again (Step 10)\n- Increment iteration_count\n\n**CRITICAL:** Each revision iteration MUST re-inject CONTEXT_CONTENT. Without this, the planner loses user constraints during revision.\n\nIf iteration_count >= 3:\n- Display remaining issues\n- Offer: Force proceed / Provide guidance / Abandon\n\n## Step 13: Index with Memory (Optional)\n\n**If gsd_memory MCP tools are available:**\n\nCheck if `gsd_memory_index` tool exists. If available, trigger indexing:\n\n```\ngsd_memory_index({\n  path: process.cwd()\n})\n```\n\nThis updates the project's searchable knowledge base with new plans and research.\n\n**If tool not available:** Skip silently.\n\n## Step 14: Present Final Status\n\n@./.gemini/get-shit-done/references/git-planning-commit.md\n\nRoute to completion banner.\n\n</process>\n\n<completion_banner>\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► PHASE {X} PLANNED ✓\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n**Phase {X}: {Name}** — {N} plan(s) in {M} wave(s)\n\n| Wave | Plans | What it builds |\n|------|-------|----------------|\n| 1 | 01, 02 | [objectives] |\n| 2 | 03 | [objective] |\n\nResearch: {Completed | Used existing | Skipped}\nVerification: {Passed | Passed with override | Skipped}\n\n───────────────────────────────────────────────────────────────\n\n## ▶ Next Up\n\n**Execute Phase {X}** — run all {N} plans\n\n/gsd:execute-phase {X}\n\n*(/clear first → fresh context window)*\n\n───────────────────────────────────────────────────────────────\n\n**Also available:**\n- cat .planning/phases/{phase-dir}/*-PLAN.md — review plans\n- /gsd:plan-phase {X} --research — re-research first\n\n───────────────────────────────────────────────────────────────\n</completion_banner>\n"
