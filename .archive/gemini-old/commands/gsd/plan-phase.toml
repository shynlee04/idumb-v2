description = "Create detailed execution plan for a phase (PLAN.md) with verification loop"
prompt = "<execution_context>\n@./.gemini/get-shit-done/references/ui-brand.md\n</execution_context>\n\n<objective>\nCreate executable phase prompts (PLAN.md files) for a roadmap phase with integrated research and verification.\n\n**Default flow:** Research (if needed) → Plan → Verify → Done\n\n**Orchestrator role:** Parse arguments, validate phase, research domain (unless skipped or exists), spawn gsd-planner agent, verify plans with gsd-plan-checker, iterate until plans pass or max iterations reached, present results.\n\n**Why subagents:** Research and planning burn context fast. Verification uses fresh context. User sees the flow between agents in main context.\n</objective>\n\n<context>\nPhase number: $ARGUMENTS (optional - auto-detects next unplanned phase if not provided)\n\n**Flags:**\n- `--research` — Force re-research even if RESEARCH.md exists\n- `--skip-research` — Skip research entirely, go straight to planning\n- `--gaps` — Gap closure mode (reads VERIFICATION.md, skips research)\n- `--skip-verify` — Skip planner → checker verification loop\n\nNormalize phase input in step 2 before any directory lookups.\n</context>\n\n<process>\n\n## 1. Validate Environment and Resolve Model Profile\n\n```bash\nls .planning/ 2>/dev/null\n```\n\n**If not found:** Error - user should run `/gsd:new-project` first.\n\n**Resolve model profile for agent spawning:**\n\n```bash\nMODEL_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '\"model_profile\"[[:space:]]*:[[:space:]]*\"[^\"]*\"' | grep -o '\"[^\"]*\"$' | tr -d '\"' || echo \"balanced\")\n```\n\nDefault to \"balanced\" if not set.\n\n**Model lookup table:**\n\n| Agent | quality | balanced | budget |\n|-------|---------|----------|--------|\n| gsd-phase-researcher | opus | sonnet | haiku |\n| gsd-planner | opus | opus | sonnet |\n| gsd-plan-checker | sonnet | sonnet | haiku |\n\nStore resolved models for use in Task calls below.\n\n## 2. Parse and Normalize Arguments\n\nExtract from $ARGUMENTS:\n\n- Phase number (integer or decimal like `2.1`)\n- `--research` flag to force re-research\n- `--skip-research` flag to skip research\n- `--gaps` flag for gap closure mode\n- `--skip-verify` flag to bypass verification loop\n\n**If no phase number:** Detect next unplanned phase from roadmap.\n\n**Normalize phase to zero-padded format:**\n\n```bash\n# Normalize phase number (8 → 08, but preserve decimals like 2.1 → 02.1)\nif [[ \"$PHASE\" =~ ^[0-9]+$ ]]; then\n  PHASE=$(printf \"%02d\" \"$PHASE\")\nelif [[ \"$PHASE\" =~ ^([0-9]+)\\.([0-9]+)$ ]]; then\n  PHASE=$(printf \"%02d.%s\" \"${BASH_REMATCH[1]}\" \"${BASH_REMATCH[2]}\")\nfi\n```\n\n**Check for existing research and plans:**\n\n```bash\nls .planning/phases/${PHASE}-*/*-RESEARCH.md 2>/dev/null\nls .planning/phases/${PHASE}-*/*-PLAN.md 2>/dev/null\n```\n\n## 3. Validate Phase\n\n```bash\ngrep -A5 \"Phase ${PHASE}:\" .planning/ROADMAP.md 2>/dev/null\n```\n\n**If not found:** Error with available phases. **If found:** Extract phase number, name, description.\n\n## 4. Ensure Phase Directory Exists and Load CONTEXT.md\n\n```bash\n# PHASE is already normalized (08, 02.1, etc.) from step 2\nPHASE_DIR=$(ls -d .planning/phases/${PHASE}-* 2>/dev/null | head -1)\nif [ -z \"$PHASE_DIR\" ]; then\n  # Create phase directory from roadmap name\n  PHASE_NAME=$(grep \"Phase ${PHASE}:\" .planning/ROADMAP.md | sed 's/.*Phase [0-9]*: //' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')\n  mkdir -p \".planning/phases/${PHASE}-${PHASE_NAME}\"\n  PHASE_DIR=\".planning/phases/${PHASE}-${PHASE_NAME}\"\nfi\n\n# Load CONTEXT.md immediately - this informs ALL downstream agents\nCONTEXT_CONTENT=$(cat \"${PHASE_DIR}\"/*-CONTEXT.md 2>/dev/null)\n```\n\n**CRITICAL:** Store `CONTEXT_CONTENT` now. It must be passed to:\n- **Researcher** — constrains what to research (locked decisions vs Claude's discretion)\n- **Planner** — locked decisions must be honored, not revisited\n- **Checker** — verifies plans respect user's stated vision\n- **Revision** — context for targeted fixes\n\nIf CONTEXT.md exists, display: `Using phase context from: ${PHASE_DIR}/*-CONTEXT.md`\n\n## 5. Handle Research\n\n**If `--gaps` flag:** Skip research (gap closure uses VERIFICATION.md instead).\n\n**If `--skip-research` flag:** Skip to step 6.\n\n**Check config for research setting:**\n\n```bash\nWORKFLOW_RESEARCH=$(cat .planning/config.json 2>/dev/null | grep -o '\"research\"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\\|false' || echo \"true\")\n```\n\n**If `workflow.research` is `false` AND `--research` flag NOT set:** Skip to step 6.\n\n**Otherwise:**\n\nCheck for existing research:\n\n```bash\nls \"${PHASE_DIR}\"/*-RESEARCH.md 2>/dev/null\n```\n\n**If RESEARCH.md exists AND `--research` flag NOT set:**\n- Display: `Using existing research: ${PHASE_DIR}/${PHASE}-RESEARCH.md`\n- Skip to step 6\n\n**If RESEARCH.md missing OR `--research` flag set:**\n\nDisplay stage banner:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► RESEARCHING PHASE {X}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n◆ Spawning researcher...\n```\n\nProceed to spawn researcher\n\n### Spawn gsd-phase-researcher\n\nGather additional context for research prompt:\n\n```bash\n# Get phase description from roadmap\nPHASE_DESC=$(grep -A3 \"Phase ${PHASE}:\" .planning/ROADMAP.md)\n\n# Get requirements if they exist\nREQUIREMENTS=$(cat .planning/REQUIREMENTS.md 2>/dev/null | grep -A100 \"## Requirements\" | head -50)\n\n# Get prior decisions from STATE.md\nDECISIONS=$(grep -A20 \"### Decisions Made\" .planning/STATE.md 2>/dev/null)\n\n# CONTEXT_CONTENT already loaded in step 4\n```\n\nFill research prompt and spawn:\n\n```markdown\n<objective>\nResearch how to implement Phase {phase_number}: {phase_name}\n\nAnswer: \"What do I need to know to PLAN this phase well?\"\n</objective>\n\n<phase_context>\n**IMPORTANT:** If CONTEXT.md exists below, it contains user decisions from /gsd:discuss-phase.\n\n- **Decisions section** = Locked choices — research THESE deeply, don't explore alternatives\n- **Claude's Discretion section** = Your freedom areas — research options, make recommendations\n- **Deferred Ideas section** = Out of scope — ignore completely\n\n{context_content}\n</phase_context>\n\n<additional_context>\n**Phase description:**\n{phase_description}\n\n**Requirements (if any):**\n{requirements}\n\n**Prior decisions from STATE.md:**\n{decisions}\n</additional_context>\n\n<output>\nWrite research findings to: {phase_dir}/{phase}-RESEARCH.md\n</output>\n```\n\n```\nTask(\n  prompt=\"First, read ./.gemini/agents/gsd-phase-researcher.md for your role and instructions.\\n\\n\" + research_prompt,\n  subagent_type=\"general-purpose\",\n  model=\"{researcher_model}\",\n  description=\"Research Phase {phase}\"\n)\n```\n\n### Handle Researcher Return\n\n**`## RESEARCH COMPLETE`:**\n- Display: `Research complete. Proceeding to planning...`\n- Continue to step 6\n\n**`## RESEARCH BLOCKED`:**\n- Display blocker information\n- Offer: 1) Provide more context, 2) Skip research and plan anyway, 3) Abort\n- Wait for user response\n\n## 6. Check Existing Plans\n\n```bash\nls \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null\n```\n\n**If exists:** Offer: 1) Continue planning (add more plans), 2) View existing, 3) Replan from scratch. Wait for response.\n\n## 7. Read Context Files\n\nRead and store context file contents for the planner agent. The `@` syntax does not work across Task() boundaries - content must be inlined.\n\n```bash\n# Read required files\nSTATE_CONTENT=$(cat .planning/STATE.md)\nROADMAP_CONTENT=$(cat .planning/ROADMAP.md)\n\n# Read optional files (empty string if missing)\nREQUIREMENTS_CONTENT=$(cat .planning/REQUIREMENTS.md 2>/dev/null)\n# CONTEXT_CONTENT already loaded in step 4\nRESEARCH_CONTENT=$(cat \"${PHASE_DIR}\"/*-RESEARCH.md 2>/dev/null)\n\n# Gap closure files (only if --gaps mode)\nVERIFICATION_CONTENT=$(cat \"${PHASE_DIR}\"/*-VERIFICATION.md 2>/dev/null)\nUAT_CONTENT=$(cat \"${PHASE_DIR}\"/*-UAT.md 2>/dev/null)\n```\n\n## 8. Spawn gsd-planner Agent\n\nDisplay stage banner:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► PLANNING PHASE {X}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n◆ Spawning planner...\n```\n\nFill prompt with inlined content and spawn:\n\n```markdown\n<planning_context>\n\n**Phase:** {phase_number}\n**Mode:** {standard | gap_closure}\n\n**Project State:**\n{state_content}\n\n**Roadmap:**\n{roadmap_content}\n\n**Requirements (if exists):**\n{requirements_content}\n\n**Phase Context (if exists):**\n\nIMPORTANT: If phase context exists below, it contains USER DECISIONS from /gsd:discuss-phase.\n- **Decisions** = LOCKED — honor these exactly, do not revisit or suggest alternatives\n- **Claude's Discretion** = Your freedom — make implementation choices here\n- **Deferred Ideas** = Out of scope — do NOT include in this phase\n\n{context_content}\n\n**Research (if exists):**\n{research_content}\n\n**Gap Closure (if --gaps mode):**\n{verification_content}\n{uat_content}\n\n</planning_context>\n\n<downstream_consumer>\nOutput consumed by /gsd:execute-phase\nPlans must be executable prompts with:\n\n- Frontmatter (wave, depends_on, files_modified, autonomous)\n- Tasks in XML format\n- Verification criteria\n- must_haves for goal-backward verification\n</downstream_consumer>\n\n<quality_gate>\nBefore returning PLANNING COMPLETE:\n\n- [ ] PLAN.md files created in phase directory\n- [ ] Each plan has valid frontmatter\n- [ ] Tasks are specific and actionable\n- [ ] Dependencies correctly identified\n- [ ] Waves assigned for parallel execution\n- [ ] must_haves derived from phase goal\n</quality_gate>\n```\n\n```\nTask(\n  prompt=\"First, read ./.gemini/agents/gsd-planner.md for your role and instructions.\\n\\n\" + filled_prompt,\n  subagent_type=\"general-purpose\",\n  model=\"{planner_model}\",\n  description=\"Plan Phase {phase}\"\n)\n```\n\n## 9. Handle Planner Return\n\nParse planner output:\n\n**`## PLANNING COMPLETE`:**\n- Display: `Planner created {N} plan(s). Files on disk.`\n- If `--skip-verify`: Skip to step 13\n- Check config: `WORKFLOW_PLAN_CHECK=$(cat .planning/config.json 2>/dev/null | grep -o '\"plan_check\"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\\|false' || echo \"true\")`\n- If `workflow.plan_check` is `false`: Skip to step 13\n- Otherwise: Proceed to step 10\n\n**`## CHECKPOINT REACHED`:**\n- Present to user, get response, spawn continuation (see step 12)\n\n**`## PLANNING INCONCLUSIVE`:**\n- Show what was attempted\n- Offer: Add context, Retry, Manual\n- Wait for user response\n\n## 10. Spawn gsd-plan-checker Agent\n\nDisplay:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► VERIFYING PLANS\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n◆ Spawning plan checker...\n```\n\nRead plans for the checker:\n\n```bash\n# Read all plans in phase directory\nPLANS_CONTENT=$(cat \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null)\n\n# CONTEXT_CONTENT already loaded in step 4\n# REQUIREMENTS_CONTENT already loaded in step 7\n```\n\nFill checker prompt with inlined content and spawn:\n\n```markdown\n<verification_context>\n\n**Phase:** {phase_number}\n**Phase Goal:** {goal from ROADMAP}\n\n**Plans to verify:**\n{plans_content}\n\n**Requirements (if exists):**\n{requirements_content}\n\n**Phase Context (if exists):**\n\nIMPORTANT: If phase context exists below, it contains USER DECISIONS from /gsd:discuss-phase.\nPlans MUST honor these decisions. Flag as issue if plans contradict user's stated vision.\n\n- **Decisions** = LOCKED — plans must implement these exactly\n- **Claude's Discretion** = Freedom areas — plans can choose approach\n- **Deferred Ideas** = Out of scope — plans must NOT include these\n\n{context_content}\n\n</verification_context>\n\n<expected_output>\nReturn one of:\n- ## VERIFICATION PASSED — all checks pass\n- ## ISSUES FOUND — structured issue list\n</expected_output>\n```\n\n```\nTask(\n  prompt=checker_prompt,\n  subagent_type=\"gsd-plan-checker\",\n  model=\"{checker_model}\",\n  description=\"Verify Phase {phase} plans\"\n)\n```\n\n## 11. Handle Checker Return\n\n**If `## VERIFICATION PASSED`:**\n- Display: `Plans verified. Ready for execution.`\n- Proceed to step 13\n\n**If `## ISSUES FOUND`:**\n- Display: `Checker found issues:`\n- List issues from checker output\n- Check iteration count\n- Proceed to step 12\n\n## 12. Revision Loop (Max 3 Iterations)\n\nTrack: `iteration_count` (starts at 1 after initial plan + check)\n\n**If iteration_count < 3:**\n\nDisplay: `Sending back to planner for revision... (iteration {N}/3)`\n\nRead current plans for revision context:\n\n```bash\nPLANS_CONTENT=$(cat \"${PHASE_DIR}\"/*-PLAN.md 2>/dev/null)\n# CONTEXT_CONTENT already loaded in step 4\n```\n\nSpawn gsd-planner with revision prompt:\n\n```markdown\n<revision_context>\n\n**Phase:** {phase_number}\n**Mode:** revision\n\n**Existing plans:**\n{plans_content}\n\n**Checker issues:**\n{structured_issues_from_checker}\n\n**Phase Context (if exists):**\n\nIMPORTANT: If phase context exists, revisions MUST still honor user decisions.\n\n{context_content}\n\n</revision_context>\n\n<instructions>\nMake targeted updates to address checker issues.\nDo NOT replan from scratch unless issues are fundamental.\nRevisions must still honor all locked decisions from Phase Context.\nReturn what changed.\n</instructions>\n```\n\n```\nTask(\n  prompt=\"First, read ./.gemini/agents/gsd-planner.md for your role and instructions.\\n\\n\" + revision_prompt,\n  subagent_type=\"general-purpose\",\n  model=\"{planner_model}\",\n  description=\"Revise Phase {phase} plans\"\n)\n```\n\n- After planner returns → spawn checker again (step 10)\n- Increment iteration_count\n\n**If iteration_count >= 3:**\n\nDisplay: `Max iterations reached. {N} issues remain:`\n- List remaining issues\n\nOffer options:\n1. Force proceed (execute despite issues)\n2. Provide guidance (user gives direction, retry)\n3. Abandon (exit planning)\n\nWait for user response.\n\n## 13. Present Final Status\n\nRoute to `<offer_next>`.\n\n</process>\n\n<offer_next>\nOutput this markdown directly (not as a code block):\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► PHASE {X} PLANNED ✓\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n**Phase {X}: {Name}** — {N} plan(s) in {M} wave(s)\n\n| Wave | Plans | What it builds |\n|------|-------|----------------|\n| 1    | 01, 02 | [objectives] |\n| 2    | 03     | [objective]  |\n\nResearch: {Completed | Used existing | Skipped}\nVerification: {Passed | Passed with override | Skipped}\n\n───────────────────────────────────────────────────────────────\n\n## ▶ Next Up\n\n**Execute Phase {X}** — run all {N} plans\n\n/gsd:execute-phase {X}\n\n*(/clear first → fresh context window)*\n\n───────────────────────────────────────────────────────────────\n\n**Also available:**\n- cat .planning/phases/{phase-dir}/*-PLAN.md — review plans\n- /gsd:plan-phase {X} --research — re-research first\n\n───────────────────────────────────────────────────────────────\n</offer_next>\n\n<success_criteria>\n- [ ] .planning/ directory validated\n- [ ] Phase validated against roadmap\n- [ ] Phase directory created if needed\n- [ ] CONTEXT.md loaded early (step 4) and passed to ALL agents\n- [ ] Research completed (unless --skip-research or --gaps or exists)\n- [ ] gsd-phase-researcher spawned with CONTEXT.md (constrains research scope)\n- [ ] Existing plans checked\n- [ ] gsd-planner spawned with context (CONTEXT.md + RESEARCH.md)\n- [ ] Plans created (PLANNING COMPLETE or CHECKPOINT handled)\n- [ ] gsd-plan-checker spawned with CONTEXT.md (verifies context compliance)\n- [ ] Verification passed OR user override OR max iterations with user decision\n- [ ] User sees status between agent spawns\n- [ ] User knows next steps (execute or review)\n</success_criteria>"
