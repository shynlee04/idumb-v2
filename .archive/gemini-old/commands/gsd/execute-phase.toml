description = "Execute all plans in a phase with wave-based parallelization"
prompt = "<objective>\nExecute all plans in a phase using wave-based parallel execution.\n\nOrchestrator stays lean: discover plans, analyze dependencies, group into waves, spawn subagents, collect results. Each subagent loads the full execute-plan context and handles its own plan.\n\nContext budget: ~15% orchestrator, 100% fresh per subagent.\n</objective>\n\n<execution_context>\n@./.gemini/get-shit-done/references/ui-brand.md\n@./.gemini/get-shit-done/workflows/execute-phase.md\n</execution_context>\n\n<context>\nPhase: $ARGUMENTS\n\n**Flags:**\n- `--gaps-only` â€” Execute only gap closure plans (plans with `gap_closure: true` in frontmatter). Use after verify-work creates fix plans.\n\n@.planning/ROADMAP.md\n@.planning/STATE.md\n</context>\n\n<process>\n0. **Resolve Model Profile**\n\n   Read model profile for agent spawning:\n   ```bash\n   MODEL_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '\"model_profile\"[[:space:]]*:[[:space:]]*\"[^\"]*\"' | grep -o '\"[^\"]*\"$' | tr -d '\"' || echo \"balanced\")\n   ```\n\n   Default to \"balanced\" if not set.\n\n   **Model lookup table:**\n\n   | Agent | quality | balanced | budget |\n   |-------|---------|----------|--------|\n   | gsd-executor | opus | sonnet | sonnet |\n   | gsd-verifier | sonnet | sonnet | haiku |\n\n   Store resolved models for use in Task calls below.\n\n1. **Validate phase exists**\n   - Find phase directory matching argument\n   - Count PLAN.md files\n   - Error if no plans found\n\n2. **Discover plans**\n   - List all *-PLAN.md files in phase directory\n   - Check which have *-SUMMARY.md (already complete)\n   - If `--gaps-only`: filter to only plans with `gap_closure: true`\n   - Build list of incomplete plans\n\n3. **Group by wave**\n   - Read `wave` from each plan's frontmatter\n   - Group plans by wave number\n   - Report wave structure to user\n\n4. **Execute waves**\n   For each wave in order:\n   - Spawn `gsd-executor` for each plan in wave (parallel Task calls)\n   - Wait for completion (Task blocks)\n   - Verify SUMMARYs created and spot-check claims\n   - Proceed to next wave\n\n5. **Aggregate results**\n   - Collect summaries from all plans\n   - Report phase completion status\n\n6. **Commit any orchestrator corrections**\n   Check for uncommitted changes before verification:\n   ```bash\n   git status --porcelain\n   ```\n\n   **If changes exist:** Orchestrator made corrections between executor completions. Stage and commit them individually:\n   ```bash\n   # Stage each modified file individually (never use git add -u, git add ., or git add -A)\n   git status --porcelain | grep '^ M' | cut -c4- | while read file; do\n     git add \"$file\"\n   done\n   git commit -m \"fix({phase}): orchestrator corrections\"\n   ```\n\n   **If clean:** Continue to verification.\n\n7. **Verify phase goal**\n   Check config: `WORKFLOW_VERIFIER=$(cat .planning/config.json 2>/dev/null | grep -o '\"verifier\"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\\|false' || echo \"true\")`\n\n   **If `workflow.verifier` is `false`:** Skip to step 8 (treat as passed).\n\n   **Otherwise:**\n   - Spawn `gsd-verifier` subagent with phase directory and goal\n   - Verifier checks must_haves against actual codebase (not SUMMARY claims)\n   - Creates VERIFICATION.md with detailed report\n   - Route by status:\n     - `passed` â†’ continue to step 8\n     - `human_needed` â†’ present items, get approval or feedback\n     - `gaps_found` â†’ present gaps, offer `/gsd:plan-phase {X} --gaps`\n\n8. **Update roadmap and state**\n   - Update ROADMAP.md, STATE.md\n\n9. **Update requirements**\n   Mark phase requirements as Complete:\n   - Read ROADMAP.md, find this phase's `Requirements:` line (e.g., \"AUTH-01, AUTH-02\")\n   - Read REQUIREMENTS.md traceability table\n   - For each REQ-ID in this phase: change Status from \"Pending\" to \"Complete\"\n   - Write updated REQUIREMENTS.md\n   - Skip if: REQUIREMENTS.md doesn't exist, or phase has no Requirements line\n\n10. **Commit phase completion**\n    Check `COMMIT_PLANNING_DOCS` from config.json (default: true).\n    If false: Skip git operations for .planning/ files.\n    If true: Bundle all phase metadata updates in one commit:\n    - Stage: `git add .planning/ROADMAP.md .planning/STATE.md`\n    - Stage REQUIREMENTS.md if updated: `git add .planning/REQUIREMENTS.md`\n    - Commit: `docs({phase}): complete {phase-name} phase`\n\n11. **Offer next steps**\n    - Route to next action (see `<offer_next>`)\n</process>\n\n<offer_next>\nOutput this markdown directly (not as a code block). Route based on status:\n\n| Status | Route |\n|--------|-------|\n| `gaps_found` | Route C (gap closure) |\n| `human_needed` | Present checklist, then re-route based on approval |\n| `passed` + more phases | Route A (next phase) |\n| `passed` + last phase | Route B (milestone complete) |\n\n---\n\n**Route A: Phase verified, more phases remain**\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n GSD â–º PHASE {Z} COMPLETE âœ“\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n**Phase {Z}: {Name}**\n\n{Y} plans executed\nGoal verified âœ“\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n## â–¶ Next Up\n\n**Phase {Z+1}: {Name}** â€” {Goal from ROADMAP.md}\n\n/gsd:discuss-phase {Z+1} â€” gather context and clarify approach\n\n*(/clear first â†’ fresh context window)*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n**Also available:**\n- /gsd:plan-phase {Z+1} â€” skip discussion, plan directly\n- /gsd:verify-work {Z} â€” manual acceptance testing before continuing\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n---\n\n**Route B: Phase verified, milestone complete**\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n GSD â–º MILESTONE COMPLETE ğŸ‰\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n**v1.0**\n\n{N} phases completed\nAll phase goals verified âœ“\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n## â–¶ Next Up\n\n**Audit milestone** â€” verify requirements, cross-phase integration, E2E flows\n\n/gsd:audit-milestone\n\n*(/clear first â†’ fresh context window)*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n**Also available:**\n- /gsd:verify-work â€” manual acceptance testing\n- /gsd:complete-milestone â€” skip audit, archive directly\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n---\n\n**Route C: Gaps found â€” need additional planning**\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n GSD â–º PHASE {Z} GAPS FOUND âš \nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n**Phase {Z}: {Name}**\n\nScore: {N}/{M} must-haves verified\nReport: .planning/phases/{phase_dir}/{phase}-VERIFICATION.md\n\n### What's Missing\n\n{Extract gap summaries from VERIFICATION.md}\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n## â–¶ Next Up\n\n**Plan gap closure** â€” create additional plans to complete the phase\n\n/gsd:plan-phase {Z} --gaps\n\n*(/clear first â†’ fresh context window)*\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n**Also available:**\n- cat .planning/phases/{phase_dir}/{phase}-VERIFICATION.md â€” see full report\n- /gsd:verify-work {Z} â€” manual testing before planning\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n---\n\nAfter user runs /gsd:plan-phase {Z} --gaps:\n1. Planner reads VERIFICATION.md gaps\n2. Creates plans 04, 05, etc. to close gaps\n3. User runs /gsd:execute-phase {Z} again\n4. Execute-phase runs incomplete plans (04, 05...)\n5. Verifier runs again â†’ loop until passed\n</offer_next>\n\n<wave_execution>\n**Parallel spawning:**\n\nBefore spawning, read file contents. The `@` syntax does not work across Task() boundaries.\n\n```bash\n# Read each plan and STATE.md\nPLAN_01_CONTENT=$(cat \"{plan_01_path}\")\nPLAN_02_CONTENT=$(cat \"{plan_02_path}\")\nPLAN_03_CONTENT=$(cat \"{plan_03_path}\")\nSTATE_CONTENT=$(cat .planning/STATE.md)\n```\n\nSpawn all plans in a wave with a single message containing multiple Task calls, with inlined content:\n\n```\nTask(prompt=\"Execute plan at {plan_01_path}\\n\\nPlan:\\n{plan_01_content}\\n\\nProject state:\\n{state_content}\", subagent_type=\"gsd-executor\", model=\"{executor_model}\")\nTask(prompt=\"Execute plan at {plan_02_path}\\n\\nPlan:\\n{plan_02_content}\\n\\nProject state:\\n{state_content}\", subagent_type=\"gsd-executor\", model=\"{executor_model}\")\nTask(prompt=\"Execute plan at {plan_03_path}\\n\\nPlan:\\n{plan_03_content}\\n\\nProject state:\\n{state_content}\", subagent_type=\"gsd-executor\", model=\"{executor_model}\")\n```\n\nAll three run in parallel. Task tool blocks until all complete.\n\n**No polling.** No background agents. No TaskOutput loops.\n</wave_execution>\n\n<checkpoint_handling>\nPlans with `autonomous: false` have checkpoints. The execute-phase.md workflow handles the full checkpoint flow:\n- Subagent pauses at checkpoint, returns structured state\n- Orchestrator presents to user, collects response\n- Spawns fresh continuation agent (not resume)\n\nSee `@./.gemini/get-shit-done/workflows/execute-phase.md` step `checkpoint_handling` for complete details.\n</checkpoint_handling>\n\n<deviation_rules>\nDuring execution, handle discoveries automatically:\n\n1. **Auto-fix bugs** - Fix immediately, document in Summary\n2. **Auto-add critical** - Security/correctness gaps, add and document\n3. **Auto-fix blockers** - Can't proceed without fix, do it and document\n4. **Ask about architectural** - Major structural changes, stop and ask user\n\nOnly rule 4 requires user intervention.\n</deviation_rules>\n\n<commit_rules>\n**Per-Task Commits:**\n\nAfter each task completes:\n1. Stage only files modified by that task\n2. Commit with format: `{type}({phase}-{plan}): {task-name}`\n3. Types: feat, fix, test, refactor, perf, chore\n4. Record commit hash for SUMMARY.md\n\n**Plan Metadata Commit:**\n\nAfter all tasks in a plan complete:\n1. Stage plan artifacts only: PLAN.md, SUMMARY.md\n2. Commit with format: `docs({phase}-{plan}): complete [plan-name] plan`\n3. NO code files (already committed per-task)\n\n**Phase Completion Commit:**\n\nAfter all plans in phase complete (step 7):\n1. Stage: ROADMAP.md, STATE.md, REQUIREMENTS.md (if updated), VERIFICATION.md\n2. Commit with format: `docs({phase}): complete {phase-name} phase`\n3. Bundles all phase-level state updates in one commit\n\n**NEVER use:**\n- `git add .`\n- `git add -A`\n- `git add src/` or any broad directory\n\n**Always stage files individually.**\n</commit_rules>\n\n<success_criteria>\n- [ ] All incomplete plans in phase executed\n- [ ] Each plan has SUMMARY.md\n- [ ] Phase goal verified (must_haves checked against codebase)\n- [ ] VERIFICATION.md created in phase directory\n- [ ] STATE.md reflects phase completion\n- [ ] ROADMAP.md updated\n- [ ] REQUIREMENTS.md updated (phase requirements marked Complete)\n- [ ] User informed of next steps\n</success_criteria>"
