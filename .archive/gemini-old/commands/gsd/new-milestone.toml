description = "Start a new milestone cycle — update PROJECT.md and route to requirements"
prompt = "<objective>\nStart a new milestone through unified flow: questioning → research (optional) → requirements → roadmap.\n\nThis is the brownfield equivalent of new-project. The project exists, PROJECT.md has history. This command gathers \"what's next\", updates PROJECT.md, then continues through the full requirements → roadmap cycle.\n\n**Creates/Updates:**\n- `.planning/PROJECT.md` — updated with new milestone goals\n- `.planning/research/` — domain research (optional, focuses on NEW features)\n- `.planning/REQUIREMENTS.md` — scoped requirements for this milestone\n- `.planning/ROADMAP.md` — phase structure (continues numbering)\n- `.planning/STATE.md` — reset for new milestone\n\n**After this command:** Run `/gsd:plan-phase [N]` to start execution.\n</objective>\n\n<execution_context>\n@./.gemini/get-shit-done/references/questioning.md\n@./.gemini/get-shit-done/references/ui-brand.md\n@./.gemini/get-shit-done/templates/project.md\n@./.gemini/get-shit-done/templates/requirements.md\n</execution_context>\n\n<context>\nMilestone name: $ARGUMENTS (optional - will prompt if not provided)\n\n**Load project context:**\n@.planning/PROJECT.md\n@.planning/STATE.md\n@.planning/MILESTONES.md\n@.planning/config.json\n\n**Load milestone context (if exists, from /gsd:discuss-milestone):**\n@.planning/MILESTONE-CONTEXT.md\n</context>\n\n<process>\n\n## Phase 1: Load Context\n\n- Read PROJECT.md (existing project, Validated requirements, decisions)\n- Read MILESTONES.md (what shipped previously)\n- Read STATE.md (pending todos, blockers)\n- Check for MILESTONE-CONTEXT.md (from /gsd:discuss-milestone)\n\n## Phase 2: Gather Milestone Goals\n\n**If MILESTONE-CONTEXT.md exists:**\n- Use features and scope from discuss-milestone\n- Present summary for confirmation\n\n**If no context file:**\n- Present what shipped in last milestone\n- Ask: \"What do you want to build next?\"\n- Use AskUserQuestion to explore features\n- Probe for priorities, constraints, scope\n\n## Phase 3: Determine Milestone Version\n\n- Parse last version from MILESTONES.md\n- Suggest next version (v1.0 → v1.1, or v2.0 for major)\n- Confirm with user\n\n## Phase 4: Update PROJECT.md\n\nAdd/update these sections:\n\n```markdown\n## Current Milestone: v[X.Y] [Name]\n\n**Goal:** [One sentence describing milestone focus]\n\n**Target features:**\n- [Feature 1]\n- [Feature 2]\n- [Feature 3]\n```\n\nUpdate Active requirements section with new goals.\n\nUpdate \"Last updated\" footer.\n\n## Phase 5: Update STATE.md\n\n```markdown\n## Current Position\n\nPhase: Not started (defining requirements)\nPlan: —\nStatus: Defining requirements\nLast activity: [today] — Milestone v[X.Y] started\n```\n\nKeep Accumulated Context section (decisions, blockers) from previous milestone.\n\n## Phase 6: Cleanup and Commit\n\nDelete MILESTONE-CONTEXT.md if exists (consumed).\n\nCheck planning config:\n```bash\nCOMMIT_PLANNING_DOCS=$(cat .planning/config.json 2>/dev/null | grep -o '\"commit_docs\"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\\|false' || echo \"true\")\ngit check-ignore -q .planning 2>/dev/null && COMMIT_PLANNING_DOCS=false\n```\n\nIf `COMMIT_PLANNING_DOCS=false`: Skip git operations\n\nIf `COMMIT_PLANNING_DOCS=true` (default):\n```bash\ngit add .planning/PROJECT.md .planning/STATE.md\ngit commit -m \"docs: start milestone v[X.Y] [Name]\"\n```\n\n## Phase 6.5: Resolve Model Profile\n\nRead model profile for agent spawning:\n\n```bash\nMODEL_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '\"model_profile\"[[:space:]]*:[[:space:]]*\"[^\"]*\"' | grep -o '\"[^\"]*\"$' | tr -d '\"' || echo \"balanced\")\n```\n\nDefault to \"balanced\" if not set.\n\n**Model lookup table:**\n\n| Agent | quality | balanced | budget |\n|-------|---------|----------|--------|\n| gsd-project-researcher | opus | sonnet | haiku |\n| gsd-research-synthesizer | sonnet | sonnet | haiku |\n| gsd-roadmapper | opus | sonnet | sonnet |\n\nStore resolved models for use in Task calls below.\n\n## Phase 7: Research Decision\n\nUse AskUserQuestion:\n- header: \"Research\"\n- question: \"Research the domain ecosystem for new features before defining requirements?\"\n- options:\n  - \"Research first (Recommended)\" — Discover patterns, expected features, architecture for NEW capabilities\n  - \"Skip research\" — I know what I need, go straight to requirements\n\n**If \"Research first\":**\n\nDisplay stage banner:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► RESEARCHING\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nResearching [new features] ecosystem...\n```\n\nCreate research directory:\n```bash\nmkdir -p .planning/research\n```\n\nDisplay spawning indicator:\n```\n◆ Spawning 4 researchers in parallel...\n  → Stack research (for new features)\n  → Features research\n  → Architecture research (integration)\n  → Pitfalls research\n```\n\nSpawn 4 parallel gsd-project-researcher agents with milestone-aware context:\n\n```\nTask(prompt=\"\n<research_type>\nProject Research — Stack dimension for [new features].\n</research_type>\n\n<milestone_context>\nSUBSEQUENT MILESTONE — Adding [target features] to existing app.\n\nExisting validated capabilities (DO NOT re-research):\n[List from PROJECT.md Validated requirements]\n\nFocus ONLY on what's needed for the NEW features.\n</milestone_context>\n\n<question>\nWhat stack additions/changes are needed for [new features]?\n</question>\n\n<project_context>\n[PROJECT.md summary - current state, new milestone goals]\n</project_context>\n\n<downstream_consumer>\nYour STACK.md feeds into roadmap creation. Be prescriptive:\n- Specific libraries with versions for NEW capabilities\n- Integration points with existing stack\n- What NOT to add and why\n</downstream_consumer>\n\n<quality_gate>\n- [ ] Versions are current (verify with Context7/official docs, not training data)\n- [ ] Rationale explains WHY, not just WHAT\n- [ ] Integration with existing stack considered\n</quality_gate>\n\n<output>\nWrite to: .planning/research/STACK.md\nUse template: ./.gemini/get-shit-done/templates/research-project/STACK.md\n</output>\n\", subagent_type=\"gsd-project-researcher\", model=\"{researcher_model}\", description=\"Stack research\")\n\nTask(prompt=\"\n<research_type>\nProject Research — Features dimension for [new features].\n</research_type>\n\n<milestone_context>\nSUBSEQUENT MILESTONE — Adding [target features] to existing app.\n\nExisting features (already built):\n[List from PROJECT.md Validated requirements]\n\nFocus on how [new features] typically work, expected behavior.\n</milestone_context>\n\n<question>\nHow do [target features] typically work? What's expected behavior?\n</question>\n\n<project_context>\n[PROJECT.md summary - new milestone goals]\n</project_context>\n\n<downstream_consumer>\nYour FEATURES.md feeds into requirements definition. Categorize clearly:\n- Table stakes (must have for these features)\n- Differentiators (competitive advantage)\n- Anti-features (things to deliberately NOT build)\n</downstream_consumer>\n\n<quality_gate>\n- [ ] Categories are clear (table stakes vs differentiators vs anti-features)\n- [ ] Complexity noted for each feature\n- [ ] Dependencies on existing features identified\n</quality_gate>\n\n<output>\nWrite to: .planning/research/FEATURES.md\nUse template: ./.gemini/get-shit-done/templates/research-project/FEATURES.md\n</output>\n\", subagent_type=\"gsd-project-researcher\", model=\"{researcher_model}\", description=\"Features research\")\n\nTask(prompt=\"\n<research_type>\nProject Research — Architecture dimension for [new features].\n</research_type>\n\n<milestone_context>\nSUBSEQUENT MILESTONE — Adding [target features] to existing app.\n\nExisting architecture:\n[Summary from PROJECT.md or codebase map]\n\nFocus on how [new features] integrate with existing architecture.\n</milestone_context>\n\n<question>\nHow do [target features] integrate with existing [domain] architecture?\n</question>\n\n<project_context>\n[PROJECT.md summary - current architecture, new features]\n</project_context>\n\n<downstream_consumer>\nYour ARCHITECTURE.md informs phase structure in roadmap. Include:\n- Integration points with existing components\n- New components needed\n- Data flow changes\n- Suggested build order\n</downstream_consumer>\n\n<quality_gate>\n- [ ] Integration points clearly identified\n- [ ] New vs modified components explicit\n- [ ] Build order considers existing dependencies\n</quality_gate>\n\n<output>\nWrite to: .planning/research/ARCHITECTURE.md\nUse template: ./.gemini/get-shit-done/templates/research-project/ARCHITECTURE.md\n</output>\n\", subagent_type=\"gsd-project-researcher\", model=\"{researcher_model}\", description=\"Architecture research\")\n\nTask(prompt=\"\n<research_type>\nProject Research — Pitfalls dimension for [new features].\n</research_type>\n\n<milestone_context>\nSUBSEQUENT MILESTONE — Adding [target features] to existing app.\n\nFocus on common mistakes when ADDING these features to an existing system.\n</milestone_context>\n\n<question>\nWhat are common mistakes when adding [target features] to [domain]?\n</question>\n\n<project_context>\n[PROJECT.md summary - current state, new features]\n</project_context>\n\n<downstream_consumer>\nYour PITFALLS.md prevents mistakes in roadmap/planning. For each pitfall:\n- Warning signs (how to detect early)\n- Prevention strategy (how to avoid)\n- Which phase should address it\n</downstream_consumer>\n\n<quality_gate>\n- [ ] Pitfalls are specific to adding these features (not generic)\n- [ ] Integration pitfalls with existing system covered\n- [ ] Prevention strategies are actionable\n</quality_gate>\n\n<output>\nWrite to: .planning/research/PITFALLS.md\nUse template: ./.gemini/get-shit-done/templates/research-project/PITFALLS.md\n</output>\n\", subagent_type=\"gsd-project-researcher\", model=\"{researcher_model}\", description=\"Pitfalls research\")\n```\n\nAfter all 4 agents complete, spawn synthesizer to create SUMMARY.md:\n\n```\nTask(prompt=\"\n<task>\nSynthesize research outputs into SUMMARY.md.\n</task>\n\n<research_files>\nRead these files:\n- .planning/research/STACK.md\n- .planning/research/FEATURES.md\n- .planning/research/ARCHITECTURE.md\n- .planning/research/PITFALLS.md\n</research_files>\n\n<output>\nWrite to: .planning/research/SUMMARY.md\nUse template: ./.gemini/get-shit-done/templates/research-project/SUMMARY.md\nCommit after writing.\n</output>\n\", subagent_type=\"gsd-research-synthesizer\", model=\"{synthesizer_model}\", description=\"Synthesize research\")\n```\n\nDisplay research complete banner and key findings:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► RESEARCH COMPLETE ✓\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n## Key Findings\n\n**Stack additions:** [from SUMMARY.md]\n**New feature table stakes:** [from SUMMARY.md]\n**Watch Out For:** [from SUMMARY.md]\n\nFiles: `.planning/research/`\n```\n\n**If \"Skip research\":** Continue to Phase 8.\n\n## Phase 8: Define Requirements\n\nDisplay stage banner:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► DEFINING REQUIREMENTS\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n```\n\n**Load context:**\n\nRead PROJECT.md and extract:\n- Core value (the ONE thing that must work)\n- Current milestone goals\n- Validated requirements (what already exists)\n\n**If research exists:** Read research/FEATURES.md and extract feature categories.\n\n**Present features by category:**\n\n```\nHere are the features for [new capabilities]:\n\n## [Category 1]\n**Table stakes:**\n- Feature A\n- Feature B\n\n**Differentiators:**\n- Feature C\n- Feature D\n\n**Research notes:** [any relevant notes]\n\n---\n\n## [Next Category]\n...\n```\n\n**If no research:** Gather requirements through conversation instead.\n\nAsk: \"What are the main things users need to be able to do with [new features]?\"\n\nFor each capability mentioned:\n- Ask clarifying questions to make it specific\n- Probe for related capabilities\n- Group into categories\n\n**Scope each category:**\n\nFor each category, use AskUserQuestion:\n\n- header: \"[Category name]\"\n- question: \"Which [category] features are in this milestone?\"\n- multiSelect: true\n- options:\n  - \"[Feature 1]\" — [brief description]\n  - \"[Feature 2]\" — [brief description]\n  - \"[Feature 3]\" — [brief description]\n  - \"None for this milestone\" — Defer entire category\n\nTrack responses:\n- Selected features → this milestone's requirements\n- Unselected table stakes → future milestone\n- Unselected differentiators → out of scope\n\n**Identify gaps:**\n\nUse AskUserQuestion:\n- header: \"Additions\"\n- question: \"Any requirements research missed? (Features specific to your vision)\"\n- options:\n  - \"No, research covered it\" — Proceed\n  - \"Yes, let me add some\" — Capture additions\n\n**Generate REQUIREMENTS.md:**\n\nCreate `.planning/REQUIREMENTS.md` with:\n- v1 Requirements for THIS milestone grouped by category (checkboxes, REQ-IDs)\n- Future Requirements (deferred to later milestones)\n- Out of Scope (explicit exclusions with reasoning)\n- Traceability section (empty, filled by roadmap)\n\n**REQ-ID format:** `[CATEGORY]-[NUMBER]` (AUTH-01, NOTIF-02)\n\nContinue numbering from existing requirements if applicable.\n\n**Requirement quality criteria:**\n\nGood requirements are:\n- **Specific and testable:** \"User can reset password via email link\" (not \"Handle password reset\")\n- **User-centric:** \"User can X\" (not \"System does Y\")\n- **Atomic:** One capability per requirement (not \"User can login and manage profile\")\n- **Independent:** Minimal dependencies on other requirements\n\n**Present full requirements list:**\n\nShow every requirement (not counts) for user confirmation:\n\n```\n## Milestone v[X.Y] Requirements\n\n### [Category 1]\n- [ ] **CAT1-01**: User can do X\n- [ ] **CAT1-02**: User can do Y\n\n### [Category 2]\n- [ ] **CAT2-01**: User can do Z\n\n[... full list ...]\n\n---\n\nDoes this capture what you're building? (yes / adjust)\n```\n\nIf \"adjust\": Return to scoping.\n\n**Commit requirements:**\n\nCheck planning config (same pattern as Phase 6).\n\nIf committing:\n```bash\ngit add .planning/REQUIREMENTS.md\ngit commit -m \"$(cat <<'EOF'\ndocs: define milestone v[X.Y] requirements\n\n[X] requirements across [N] categories\nEOF\n)\"\n```\n\n## Phase 9: Create Roadmap\n\nDisplay stage banner:\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► CREATING ROADMAP\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n◆ Spawning roadmapper...\n```\n\n**Determine starting phase number:**\n\nRead MILESTONES.md to find the last phase number from previous milestone.\nNew phases continue from there (e.g., if v1.0 ended at phase 5, v1.1 starts at phase 6).\n\nSpawn gsd-roadmapper agent with context:\n\n```\nTask(prompt=\"\n<planning_context>\n\n**Project:**\n@.planning/PROJECT.md\n\n**Requirements:**\n@.planning/REQUIREMENTS.md\n\n**Research (if exists):**\n@.planning/research/SUMMARY.md\n\n**Config:**\n@.planning/config.json\n\n**Previous milestone (for phase numbering):**\n@.planning/MILESTONES.md\n\n</planning_context>\n\n<instructions>\nCreate roadmap for milestone v[X.Y]:\n1. Start phase numbering from [N] (continues from previous milestone)\n2. Derive phases from THIS MILESTONE's requirements (don't include validated/existing)\n3. Map every requirement to exactly one phase\n4. Derive 2-5 success criteria per phase (observable user behaviors)\n5. Validate 100% coverage of new requirements\n6. Write files immediately (ROADMAP.md, STATE.md, update REQUIREMENTS.md traceability)\n7. Return ROADMAP CREATED with summary\n\nWrite files first, then return. This ensures artifacts persist even if context is lost.\n</instructions>\n\", subagent_type=\"gsd-roadmapper\", model=\"{roadmapper_model}\", description=\"Create roadmap\")\n```\n\n**Handle roadmapper return:**\n\n**If `## ROADMAP BLOCKED`:**\n- Present blocker information\n- Work with user to resolve\n- Re-spawn when resolved\n\n**If `## ROADMAP CREATED`:**\n\nRead the created ROADMAP.md and present it nicely inline:\n\n```\n---\n\n## Proposed Roadmap\n\n**[N] phases** | **[X] requirements mapped** | All milestone requirements covered ✓\n\n| # | Phase | Goal | Requirements | Success Criteria |\n|---|-------|------|--------------|------------------|\n| [N] | [Name] | [Goal] | [REQ-IDs] | [count] |\n| [N+1] | [Name] | [Goal] | [REQ-IDs] | [count] |\n...\n\n### Phase Details\n\n**Phase [N]: [Name]**\nGoal: [goal]\nRequirements: [REQ-IDs]\nSuccess criteria:\n1. [criterion]\n2. [criterion]\n\n[... continue for all phases ...]\n\n---\n```\n\n**CRITICAL: Ask for approval before committing:**\n\nUse AskUserQuestion:\n- header: \"Roadmap\"\n- question: \"Does this roadmap structure work for you?\"\n- options:\n  - \"Approve\" — Commit and continue\n  - \"Adjust phases\" — Tell me what to change\n  - \"Review full file\" — Show raw ROADMAP.md\n\n**If \"Approve\":** Continue to commit.\n\n**If \"Adjust phases\":**\n- Get user's adjustment notes\n- Re-spawn roadmapper with revision context:\n  ```\n  Task(prompt=\"\n  <revision>\n  User feedback on roadmap:\n  [user's notes]\n\n  Current ROADMAP.md: @.planning/ROADMAP.md\n\n  Update the roadmap based on feedback. Edit files in place.\n  Return ROADMAP REVISED with changes made.\n  </revision>\n  \", subagent_type=\"gsd-roadmapper\", model=\"{roadmapper_model}\", description=\"Revise roadmap\")\n  ```\n- Present revised roadmap\n- Loop until user approves\n\n**If \"Review full file\":** Display raw `cat .planning/ROADMAP.md`, then re-ask.\n\n**Commit roadmap (after approval):**\n\nCheck planning config (same pattern as Phase 6).\n\nIf committing:\n```bash\ngit add .planning/ROADMAP.md .planning/STATE.md .planning/REQUIREMENTS.md\ngit commit -m \"$(cat <<'EOF'\ndocs: create milestone v[X.Y] roadmap ([N] phases)\n\nPhases:\n[N]. [phase-name]: [requirements covered]\n[N+1]. [phase-name]: [requirements covered]\n...\n\nAll milestone requirements mapped to phases.\nEOF\n)\"\n```\n\n## Phase 10: Done\n\nPresent completion with next steps:\n\n```\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n GSD ► MILESTONE INITIALIZED ✓\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n**Milestone v[X.Y]: [Name]**\n\n| Artifact       | Location                    |\n|----------------|-----------------------------|\n| Project        | `.planning/PROJECT.md`      |\n| Research       | `.planning/research/`       |\n| Requirements   | `.planning/REQUIREMENTS.md` |\n| Roadmap        | `.planning/ROADMAP.md`      |\n\n**[N] phases** | **[X] requirements** | Ready to build ✓\n\n───────────────────────────────────────────────────────────────\n\n## ▶ Next Up\n\n**Phase [N]: [Phase Name]** — [Goal from ROADMAP.md]\n\n`/gsd:discuss-phase [N]` — gather context and clarify approach\n\n*(`/clear` first → fresh context window)*\n\n---\n\n**Also available:**\n- `/gsd:plan-phase [N]` — skip discussion, plan directly\n\n───────────────────────────────────────────────────────────────\n```\n\n</process>\n\n<success_criteria>\n- [ ] PROJECT.md updated with Current Milestone section\n- [ ] STATE.md reset for new milestone\n- [ ] MILESTONE-CONTEXT.md consumed and deleted (if existed)\n- [ ] Research completed (if selected) — 4 parallel agents spawned, milestone-aware\n- [ ] Requirements gathered (from research or conversation)\n- [ ] User scoped each category\n- [ ] REQUIREMENTS.md created with REQ-IDs\n- [ ] gsd-roadmapper spawned with phase numbering context\n- [ ] Roadmap files written immediately (not draft)\n- [ ] User feedback incorporated (if any)\n- [ ] ROADMAP.md created with phases continuing from previous milestone\n- [ ] All commits made (if planning docs committed)\n- [ ] User knows next step is `/gsd:discuss-phase [N]`\n\n**Atomic commits:** Each phase commits its artifacts immediately. If context is lost, artifacts persist.\n</success_criteria>"
